<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolatore Business Plan Completo - Bando Sicilia FSC 2021-2027</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px; color: #333;
        }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .tabs { display: flex; background: #f5f5f5; border-bottom: 2px solid #ddd; overflow-x: auto; }
        .tab { flex: 1; min-width: 150px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.3s; font-weight: 600; border-right: 1px solid #ddd; font-size: 13px; }
        .tab:hover { background: #e0e0e0; }
        .tab.active { background: white; color: #1e3c72; border-bottom: 3px solid #1e3c72; }
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
        .section { margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 10px; border-left: 4px solid #1e3c72; }
        .section h2 { color: #1e3c72; margin-bottom: 20px; font-size: 20px; display: flex; align-items: center; }
        .section h2::before { content: "‚ñ∂"; margin-right: 10px; color: #667eea; }
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-weight: 600; margin-bottom: 8px; color: #555; font-size: 14px; }
        .input-group input, .input-group select { padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; transition: all 0.3s; }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .input-group .hint { font-size: 12px; color: #888; margin-top: 5px; font-style: italic; }
        .checkbox-group { padding: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .checkbox-group label { display: block; padding: 8px; margin-bottom: 5px; cursor: pointer; }
        .checkbox-group label:hover { background: #f0f0f0; border-radius: 5px; }
        .checkbox-group input[type="checkbox"], .checkbox-group input[type="radio"] { margin-right: 8px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 40px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; margin: 20px 10px 20px 0; display: inline-block; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, #28a745 0%, #20c997 100%); }
        .btn-warning { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .result-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-left: 4px solid #667eea; }
        .result-card h3 { color: #1e3c72; font-size: 14px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .result-value { font-size: 32px; font-weight: 700; color: #667eea; margin: 10px 0; }
        .result-benchmark { font-size: 12px; color: #888; margin-top: 5px; }
        .result-status { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 10px; }
        .status-excellent { background: #d4edda; color: #155724; }
        .status-good { background: #d1ecf1; color: #0c5460; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-poor { background: #f8d7da; color: #721c24; }
        .score-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; text-align: center; margin: 20px 0; }
        .score-value { font-size: 72px; font-weight: bold; margin: 20px 0; }
        .score-max { font-size: 18px; opacity: 0.9; }
        .occupancy-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; border-radius: 10px; overflow: hidden; }
        .occupancy-table th { background: #1e3c72; color: white; padding: 15px; text-align: left; font-weight: 600; font-size: 13px; }
        .occupancy-table td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 13px; }
        .occupancy-table tr:hover { background: #f5f5f5; }
        .occupancy-table input { width: 80px; padding: 8px; border: 2px solid #ddd; border-radius: 5px; text-align: center; }
        .quadro-table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
        .quadro-table th { background: #2a5298; color: white; padding: 12px; text-align: center; font-weight: 600; font-size: 12px; border: 1px solid #ddd; }
        .quadro-table td { padding: 10px; border: 1px solid #ddd; font-size: 12px; }
        .quadro-table input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; text-align: right; }
        .quadro-table .label-cell { font-weight: 600; background: #f8f9fa; }
        .quadro-table .total-row { background: #e8f4f8; font-weight: bold; }
        .quadro-table .subtotal-row { background: #f0f0f0; font-weight: 600; }
        .alert { padding: 15px; border-radius: 8px; margin: 20px 0; }
        .alert-info { background: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .alert-warning { background: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .alert-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .alert-danger { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .print-btn { background: #28a745; float: right; }
        @media print { body { background: white; padding: 0; } .tabs, .btn { display: none; } .container { box-shadow: none; } }
        .legend { background: #f0f0f0; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 13px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Calcolatore Business Plan Completo</h1>
            <p>Bando FSC 2021-2027 - Agevolazioni Imprese Turistiche Sicilia</p>
        </div>
        
        
        <div class="tabs">
            <div class="tab active" onclick="showTab(0)">üìù Dati Base</div>
            <div class="tab" onclick="showTab(1)">üí∞ Dati Economici</div>
            <div class="tab" onclick="showTab(2)">üíº Quadro H</div>
            <div class="tab" onclick="showTab(3)">üìä Quadro L</div>
            <div class="tab" onclick="showTab(4)">üìà Indici</div>
            <div class="tab" onclick="showTab(5)">üéØ Punteggio</div>
        </div>
        
        <div class="content">
            <!-- TAB 1: DATI BASE -->
            <div class="tab-content active">
                <!-- <div class="alert alert-info"><strong‚ÑπÔ∏è Informazioni:</strong> Inserisci i dati strutturali della tua attivit√† turistica.</div>-->
                
                <div class="section">
                    <h2>Informazioni Cliente</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Denominazione Cliente *</label>
                            <input type="text" id="denominazioneCliente" placeholder="Es. Hotel Paradise SRL">
                            <span class="hint">Nome della societ√†</span>
                        </div>
                        <div class="input-group">
                            <label>Comune</label>
                            <select id="comuneSelect">
                                <option value="">-- Seleziona Comune --</option>
                            </select>
                            <span class="hint">Comune della struttura</span>
                        </div>
                        <div class="input-group">
                            <label>Risultato lookup Comune</label>
                            <input type="text" id="comuneLookupResult" readonly placeholder="Seleziona comune">
                            <span class="hint">Aree rilevate</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                <h2>Regime di Aiuto e Contributo</h2>
    
    <div class="input-grid">
        <div class="input-group">
            <label>Regime di Aiuto *</label>
            <select id="regimeAiuto" onchange="aggiornaRegimeAiuto()">
                <option value="">Seleziona regime</option>
                <option value="de_minimis">De Minimis (Reg. UE 2831/2023)</option>
                <option value="gber">In Esenzione (Reg. UE 651/2014 - Art. 14)</option>
            </select>
            <span class="hint">Determina l'intensit√† massima di aiuto</span>
        </div>
        
        <div class="input-group" id="dimensioneImpresaGroup" style="display: none;">
            <label>Dimensione Impresa *</label>
            <select id="dimensioneImpresa" onchange="aggiornaRegimeAiuto()">
                <option value="mpi">Micro/Piccola Impresa</option>
                <option value="media">Media Impresa</option>
                <option value="grande">Grande Impresa</option>
            </select>
            <span class="hint">Determina l'intensit√† per regime GBER</span>
        </div>
        
        <div class="input-group">
            <label>Calcolo Contributo</label>
            <select id="modalitaContributo" onchange="calcolaDettaglioInvestimenti()">
                <option value="automatico">Automatico (intensit√† massima)</option>
                <option value="manuale">Manuale (inserimento libero)</option>
            </select>
            <span class="hint">Automatico applica l'intensit√† massima consentita</span>
        </div>
    </div>
    
    <!-- BOX RIEPILOGO REGIME -->
    <div id="riepilogoRegime" style="display: none; margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div>
                <div style="font-size: 12px; opacity: 0.9;">REGIME SELEZIONATO</div>
                <div id="regimeNome" style="font-size: 18px; font-weight: bold; margin-top: 5px;">-</div>
            </div>
            <div>
                <div style="font-size: 12px; opacity: 0.9;">INTENSIT√Ä MASSIMA</div>
                <div id="intensitaMassima" style="font-size: 28px; font-weight: bold; margin-top: 5px;">-</div>
            </div>
            <div>
                <div style="font-size: 12px; opacity: 0.9;">CONTRIBUTO MASSIMO</div>
                <div id="contributoMassimo" style="font-size: 18px; font-weight: bold; margin-top: 5px;">-</div>
            </div>
        </div>
        <div id="vincoliRegime" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3); font-size: 13px; opacity: 0.95;">
            <!-- Vincoli specifici del regime -->
        </div>
    </div>
    
    <!-- ALERT VALIDAZIONE REGIME -->
    <div id="alert_regime" class="alert alert-warning" style="display: none; margin-top: 15px;">
        <strong>‚ö†Ô∏è Attenzione:</strong> <span id="alert_regime_msg"></span>
    </div>
    
    <div id="alert_regime_ok" class="alert alert-success" style="display: none; margin-top: 15px;">
        <strong>‚úÖ Contributo conforme:</strong> <span id="alert_regime_ok_msg"></span>
    </div>
</div>
                <div class="section">
                    <h2>Tipologia Impresa</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Stato Impresa *</label>
                            <select id="impresaStato" onchange="updateFormVisibility()">
                                <option value="inattiva">Impresa Inattiva (nuova costituzione)</option>
                                <option value="attiva">Impresa Attiva</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tipologia Struttura *</label>
                            <select id="tipologiaStruttura">
                                <option value="hotel">Hotel / Albergo</option>
                                <option value="residenza">Residenza Turistico-Alberghiera</option>
                                <option value="bb">B&B</option>
                                <option value="villaggio">Villaggio Turistico</option>
                                <option value="altro">Altra struttura extralberghiera</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Caratteristiche Struttura</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Numero Camere/Unit√† Abitative *</label>
                            <input type="number" id="numCamere" value="0" min="1">
                        </div>
                        <div class="input-group">
                            <label>Giorni Apertura Annui *</label>
                            <input type="number" id="giorniApertura" value="365" min="1" max="365">
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Attuali (ULA)</label>
                            <input type="number" id="dipendentiAttuali" value="0" min="0" step="0.5">
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Previsti (ULA) *</label>
                            <input type="number" id="dipendentiPrevisti" value="0" min="1" step="0.5">
                        </div>
                    </div>
                </div>
                
                <div class="section">
    <h2>Dettaglio Investimenti con Limiti Bando</h2>
    
    <div class="alert alert-info">
        <strong>‚ÑπÔ∏è Limiti Ammissibilit√†:</strong> Le percentuali sono calcolate sull'<strong>Investimento Ammissibile</strong> (importi senza IVA).<br>
        Limiti: Parte Edile max 70%, Spese Tecniche max 4%, Consulenze max 2%, Informatiche max 20%
    </div>
    
    <!-- BOX INVESTIMENTO AMMISSIBILE -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">INVESTIMENTO AMMISSIBILE TOTALE (base calcolo limiti)</div>
        <div id="investimento_ammissibile_display" style="font-size: 42px; font-weight: bold;">‚Ç¨ 0,00</div>
        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">Somma importi ammessi (senza IVA)</div>
    </div>
    
    <table class="quadro-table" style="margin-bottom: 20px;">
    <thead>
    <tr>
        <th style="width: 18%;">Voce Investimento</th>
        <th style="width: 11%;">Importo Investimento (‚Ç¨)</th>
        <th style="width: 8%;">IVA (‚Ç¨)</th>
        <th style="width: 10%;">Totale (‚Ç¨)</th>
        <th style="width: 11%;">Importo Ammesso (‚Ç¨)</th>
        <th style="width: 11%;">Contributo (‚Ç¨)</th>
        <th style="width: 8%;">Aliq. Amm. %</th>
        <th style="width: 8%;">% su Inv.</th>
        <th style="width: 8%;">Limite</th>
        <th style="width: 7%;">Categoria</th>
    </tr>
    <tr style="background: #f8f9fa; font-size: 11px; color: #666;">
        <th></th>
        <th style="font-weight: normal;">Al netto IVA</th>
        <th style="font-weight: normal;">Manuale</th>
        <th style="font-weight: normal;">Auto</th>
        <th style="font-weight: normal;">Ammissibile</th>
        <th style="font-weight: normal;">Agevolazione</th>
        <th style="font-weight: normal;">% annua</th>
        <th style="font-weight: normal;">Calcolo limiti</th>
        <th style="font-weight: normal;">Max</th>
        <th style="font-weight: normal;">Contabile</th>
    </tr>
</thead>
    <tbody>
<!-- PARTE EDILE - CON SCELTA CATEGORIA -->
<tr id="row_edile">
    <td class="label-cell">
        <strong>Parte Edile</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Opere murarie</span>
    </td>
    <td>
        <input type="number" id="inv_edile_investimento" value="0" min="0" step="1000" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_edile_iva" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_edile_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_edile_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_edile_contributo" value="0" min="0" step="1000" 
               oninput="verificaContributoManuale('edile')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_edile_aliquota" value="3" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;"
               title="Aliquota ammortamento annua">
    </td>
    <td id="inv_edile_perc" style="text-align: center; font-weight: bold;">0%</td>
    <td style="text-align: center; font-size: 11px; color: #666; font-weight: bold;">max 70%</td>
    <td style="padding: 2px;">
        <select id="inv_edile_categoria" onchange="calcolaDettaglioInvestimenti()" 
                style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ced4da; border-radius: 4px;"
                title="Classificazione contabile">
            <option value="MAT">MAT</option>
            <option value="IMM">IMM</option>
        </select>
    </td>
</tr>

<!-- IMPIANTI - FISSO MAT -->
<tr id="row_impianti">
    <td class="label-cell">
        <strong>Impianti</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Impianti tecnici</span>
    </td>
    <td>
        <input type="number" id="inv_impianti_investimento" value="0" min="0" step="1000" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_impianti_iva" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_impianti_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_impianti_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_impianti_contributo" value="0" min="0" step="1000" 
               oninput="verificaContributoManuale('impianti')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_impianti_aliquota" value="10" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_impianti_perc" style="text-align: center; font-weight: bold; color: #666;">-</td>
    <td style="text-align: center; font-size: 11px; color: #999;">no limite</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">MAT</td>
</tr>

<!-- MACCHINARI - FISSO MAT -->
<tr id="row_macchinari">
    <td class="label-cell">
        <strong>Macchinari</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Macchinari industriali</span>
    </td>
    <td>
        <input type="number" id="inv_macchinari_investimento" value="0" min="0" step="1000" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_macchinari_iva" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_macchinari_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_macchinari_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_macchinari_contributo" value="0" min="0" step="1000" 
               oninput="verificaContributoManuale('macchinari')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_macchinari_aliquota" value="12" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_macchinari_perc" style="text-align: center; font-weight: bold; color: #666;">-</td>
    <td style="text-align: center; font-size: 11px; color: #999;">no limite</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">MAT</td>
</tr>

<!-- ATTREZZATURE - FISSO MAT -->
<tr id="row_attrezzature">
    <td class="label-cell">
        <strong>Attrezzature</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Attrezzature varie</span>
    </td>
    <td>
        <input type="number" id="inv_attrezzature_investimento" value="0" min="0" step="1000" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_attrezzature_iva" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_attrezzature_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_attrezzature_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_attrezzature_contributo" value="0" min="0" step="1000" 
               oninput="verificaContributoManuale('attrezzature')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_attrezzature_aliquota" value="15" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_attrezzature_perc" style="text-align: center; font-weight: bold; color: #666;">-</td>
    <td style="text-align: center; font-size: 11px; color: #999;">no limite</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">MAT</td>
</tr>

<!-- ARREDI - FISSO MAT -->
<tr id="row_arredi">
    <td class="label-cell">
        <strong>Arredi</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Mobili e arredi</span>
    </td>
    <td>
        <input type="number" id="inv_arredi_investimento" value="0" min="0" step="1000" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_arredi_iva" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_arredi_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_arredi_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_arredi_contributo" value="0" min="0" step="1000" 
               oninput="verificaContributoManuale('arredi')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_arredi_aliquota" value="12" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_arredi_perc" style="text-align: center; font-weight: bold; color: #666;">-</td>
    <td style="text-align: center; font-size: 11px; color: #999;">no limite</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">MAT</td>
</tr>

<!-- SPESE TECNICHE - CON SCELTA CATEGORIA -->
<tr id="row_tecniche">
    <td class="label-cell">
        <strong>Spese Tecniche</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Progettazione, DL</span>
    </td>
    <td>
        <input type="number" id="inv_tecniche_investimento" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_tecniche_iva" value="0" min="0" step="10" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_tecniche_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_tecniche_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_tecniche_contributo" value="0" min="0" step="100" 
               oninput="verificaContributoManuale('tecniche')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_tecniche_aliquota" value="20" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_tecniche_perc" style="text-align: center; font-weight: bold;">0%</td>
    <td style="text-align: center; font-size: 11px; color: #666; font-weight: bold;">max 4%</td>
    <td style="padding: 2px;">
        <select id="inv_tecniche_categoria" onchange="calcolaDettaglioInvestimenti()" 
                style="width: 100%; padding: 4px; font-size: 11px; border: 1px solid #ced4da; border-radius: 4px;"
                title="Classificazione contabile">
            <option value="IMM">IMM</option>
            <option value="MAT">MAT</option>
        </select>
    </td>
</tr>

<!-- SPESE CONSULENZE - FISSO IMM -->
<tr id="row_consulenze">
    <td class="label-cell">
        <strong>Spese Consulenze</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Consulenze, studi</span>
    </td>
    <td>
        <input type="number" id="inv_consulenze_investimento" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_consulenze_iva" value="0" min="0" step="10" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_consulenze_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_consulenze_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_consulenze_contributo" value="0" min="0" step="100" 
               oninput="verificaContributoManuale('consulenze')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_consulenze_aliquota" value="20" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_consulenze_perc" style="text-align: center; font-weight: bold;">0%</td>
    <td style="text-align: center; font-size: 11px; color: #666; font-weight: bold;">max 2%</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">IMM</td>
</tr>

<!-- SPESE INFORMATICHE - FISSO IMM -->
<tr id="row_informatiche">
    <td class="label-cell">
        <strong>Spese Informatiche</strong>
        <span style="font-size: 10px; color: #666; display: block; margin-top: 3px;">Software, sistemi</span>
    </td>
    <td>
        <input type="number" id="inv_informatiche_investimento" value="0" min="0" step="100" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right; font-weight: bold;">
    </td>
    <td>
        <input type="number" id="inv_informatiche_iva" value="0" min="0" step="10" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: right;">
    </td>
    <td id="inv_informatiche_totale" style="text-align: right; background: #f0f8ff; font-weight: bold; color: #1e3c72;">0,00</td>
    <td id="inv_informatiche_ammesso" style="text-align: right; background: #f0fff0; font-weight: bold; color: #155724;">0,00</td>
    <td>
        <input type="number" id="inv_informatiche_contributo" value="0" min="0" step="100" 
               oninput="verificaContributoManuale('informatiche')" 
               style="text-align: right;">
    </td>
    <td>
        <input type="number" id="inv_informatiche_aliquota" value="20" min="0" max="100" step="0.5" 
               oninput="calcolaDettaglioInvestimenti()" 
               style="text-align: center; width: 100%;">
    </td>
    <td id="inv_informatiche_perc" style="text-align: center; font-weight: bold;">0%</td>
    <td style="text-align: center; font-size: 11px; color: #666;">max 20%</td>
    <td style="text-align: center; font-size: 10px; color: #666; font-weight: bold;">IMM</td>
</tr>

<!-- RIGA SEPARATORE -->
<tr style="height: 5px; background: #dee2e6;"><td colspan="10"></td></tr>

<!-- TOTALI -->
<tr class="total-row" style="background: #cfe2ff; font-size: 15px;">
    <td><strong>TOTALE</strong></td>
    <td id="inv_tot_investimento" style="text-align: right; font-weight: bold; color: #0d6efd;">0,00</td>
    <td id="inv_tot_iva" style="text-align: right; font-weight: bold; color: #0d6efd;">0,00</td>
    <td id="inv_tot_totale" style="text-align: right; font-weight: bold; color: #0d6efd;">0,00</td>
    <td id="inv_tot_ammesso" style="text-align: right; font-weight: bold; color: #155724; background: #d4edda;">0,00</td>
    <td id="inv_tot_contributo" style="text-align: right; font-weight: bold; color: #0d6efd;">0,00</td>
    <td style="text-align: center; font-weight: bold;">-</td>
    <td style="text-align: center; font-weight: bold;">100%</td>
    <td colspan="2"></td>
</tr>
    </tbody>
</table>
 
<!-- ALERT VALIDAZIONE -->
    <div id="alert_limiti" class="alert alert-warning" style="display: none;">
        <strong>‚ö†Ô∏è Attenzione: Limiti Superati</strong>
        <p style="margin: 10px 0 5px 0; font-size: 13px;">Le seguenti voci superano i limiti ammissibili:</p>
        <ul id="alert_limiti_dettaglio" style="margin: 5px 0 10px 20px; padding: 0; font-size: 13px;"></ul>
        <p style="margin-top: 10px; font-size: 12px; color: #856404;">
            <strong>üí° Suggerimento:</strong> Ridurre le spese eccedenti o aumentare le altre voci di investimento per rispettare i limiti percentuali.
        </p>
    </div>
    
    <div id="alert_limiti_ok" class="alert alert-success" style="display: none;">
        <strong>‚úÖ Tutti i limiti rispettati!</strong> L'investimento √® conforme ai requisiti del bando.
    </div>
    <!-- RIEPILOGO AMMORTAMENTI E CONTRIBUTO -->
<div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #28a745;">
    <h3 style="color: #155724; margin-bottom: 15px;">üìä Riepilogo Ammortamenti e Contributo (Anno a Regime)</h3>
    
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
        <!-- AMMORTAMENTI -->
        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #dee2e6;">
            <h4 style="color: #495057; margin-bottom: 10px; font-size: 14px;">Ammortamenti Annui</h4>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px; background: #e7f3ff; border-radius: 4px;">
                    <span style="font-size: 13px;">Immobilizzazioni Immateriali:</span>
                    <strong id="amm_immateriali_calc" style="color: #0d6efd;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px; background: #e7f3ff; border-radius: 4px;">
                    <span style="font-size: 13px;">Immobilizzazioni Materiali:</span>
                    <strong id="amm_materiali_calc" style="color: #0d6efd;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="padding-top: 10px; border-top: 2px solid #dee2e6; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px;">
                    <span style="font-size: 14px; font-weight: bold;">Totale Ammortamenti Annui:</span>
                    <strong id="amm_totale_calc" style="color: #155724; font-size: 16px;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
                ‚ÑπÔ∏è Questi importi verranno automaticamente aggiunti agli ammortamenti gi√† presenti nei Dati Economici
            </div>
        </div>
        
        <!-- CONTRIBUTO IN CONTO IMPIANTI -->
        <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #dee2e6;">
            <h4 style="color: #495057; margin-bottom: 10px; font-size: 14px;">Contributo in Conto Impianti</h4>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px; background: #d4edda; border-radius: 4px;">
                    <span style="font-size: 13px;">Quota Annua (Altri Ricavi):</span>
                    <strong id="contributo_quota_annua" style="color: #155724;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px; background: #fff3cd; border-radius: 4px;">
                    <span style="font-size: 13px;">Contributo Residuo (Risconti):</span>
                    <strong id="contributo_residuo" style="color: #856404;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="padding-top: 10px; border-top: 2px solid #dee2e6; margin-top: 10px;">
                <div style="display: flex; justify-content: space-between; padding: 8px;">
                    <span style="font-size: 14px; font-weight: bold;">Contributo Totale:</span>
                    <strong id="contributo_totale_calc" style="color: #155724; font-size: 16px;">‚Ç¨0</strong>
                </div>
            </div>
            
            <div style="margin-top: 10px; font-size: 11px; color: #666;">
                ‚ÑπÔ∏è La quota annua va in "Altri Ricavi" e il residuo in "Risconti Passivi" nell'anno a regime
            </div>
        </div>
    </div>
</div>
    <!-- RIEPILOGO AUTOMATICO -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px;">
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
            <label style="font-size: 12px; color: #0c5460; font-weight: 600;">Investimenti Immobiliari</label>
            <div id="riepilogo_immobiliari" style="font-size: 28px; font-weight: bold; color: #1e3c72; margin: 8px 0;">‚Ç¨0</div>
            <span style="font-size: 11px; color: #666;">Parte Edile + Spese Tecniche</span>
        </div>
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border: 2px solid #17a2b8;">
            <label style="font-size: 12px; color: #0c5460; font-weight: 600;">Investimenti Operativi</label>
            <div id="riepilogo_operativi" style="font-size: 28px; font-weight: bold; color: #1e3c72; margin: 8px 0;">‚Ç¨0</div>
            <span style="font-size: 11px; color: #666;">Operativi (esclusi edile e spese tecniche)</span>
        </div>
        <div style="background: #d4edda; padding: 15px; border-radius: 8px; border: 2px solid #28a745;">
            <label style="font-size: 12px; color: #155724; font-weight: 600;">Contributo Totale Richiesto</label>
            <div id="riepilogo_contributo" style="font-size: 28px; font-weight: bold; color: #155724; margin: 8px 0;">‚Ç¨0</div>
            <span style="font-size: 11px; color: #666;">Totale agevolazione</span>
        </div>
    </div>
    
    <!-- CAMPI NASCOSTI PER COMPATIBILIT√Ä -->
    <input type="hidden" id="investimentoTotale" value="0">
    <input type="hidden" id="investimentiOperativi" value="0">
    <input type="hidden" id="investimentiImmobiliari" value="0">
    <input type="hidden" id="ivaInvestimenti" value="0">
    <input type="hidden" id="contributoRichiesto" value="0">
</div>
 <div class="section">
    <h2>‚è±Ô∏è Ripartizione Temporale Investimenti</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        Indica la percentuale di investimento da realizzare in ogni anno. La somma deve essere 100%.
    </p>
    
    <div class="input-grid">
        <div class="input-group">
            <label>Anno di Avvio (%) *</label>
            <input type="number" id="percAnno0" value="0" min="0" max="100" step="1" onchange="validaPercentuali()">
            <span class="hint">Percentuale investimenti anno 0</span>
        </div>
        
        <div class="input-group">
            <label>Anno +1 (%) *</label>
            <input type="number" id="percAnno1" value="100" min="0" max="100" step="1" onchange="validaPercentuali()">
            <span class="hint">Percentuale investimenti anno 1</span>
        </div>
        
        <div class="input-group">
            <label>Anno +2 (%) *</label>
            <input type="number" id="percAnno2" value="0" min="0" max="100" step="1" onchange="validaPercentuali()">
            <span class="hint">Percentuale investimenti anno 2</span>
        </div>
    </div>
    
    <!-- BOX VALIDAZIONE PERCENTUALI -->
    <div id="alertPercentuali" class="alert alert-warning" style="display: none; margin-top: 20px;">
        <strong>‚ö†Ô∏è Attenzione:</strong> La somma delle percentuali deve essere 100%! 
        Attualmente: <strong><span id="sommaPerc">100</span>%</strong>
    </div>
    
    <div id="alertPercentualiOk" class="alert alert-success" style="display: none; margin-top: 20px;">
        <strong>‚úÖ Perfetto!</strong> La somma delle percentuali √® <strong>100%</strong>
    </div>
    
    <!-- RIEPILOGO VISUALE -->
    <div style="margin-top: 25px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
        <h3 style="margin-bottom: 15px; font-size: 16px;">üìä Distribuzione Temporale</h3>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center; backdrop-filter: blur(10px);">
                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Anno di Avvio</div>
                <div id="display_perc_0" style="font-size: 32px; font-weight: bold;">0%</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center; backdrop-filter: blur(10px);">
                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Anno +1</div>
                <div id="display_perc_1" style="font-size: 32px; font-weight: bold;">100%</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px; text-align: center; backdrop-filter: blur(10px);">
                <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Anno +2</div>
                <div id="display_perc_2" style="font-size: 32px; font-weight: bold;">0%</div>
            </div>
        </div>
        
        <!-- BARRA PROGRESSIVA -->
        <div style="margin-top: 20px;">
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px; text-align: center;">Visualizzazione Timeline</div>
            <div style="display: flex; height: 40px; border-radius: 20px; overflow: hidden; border: 2px solid rgba(255,255,255,0.3);">
                <div id="barra_perc_0" style="width: 0%; background: #4caf50; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transition: width 0.3s ease;"></div>
                <div id="barra_perc_1" style="width: 100%; background: #2196f3; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transition: width 0.3s ease;">100%</div>
                <div id="barra_perc_2" style="width: 0%; background: #ff9800; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; transition: width 0.3s ease;"></div>
            </div>
        </div>
    </div>
</div>                      
                <div class="section">
    <h2>üìä Previsione Tasso Occupazione Camere</h2>
    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
        Inserisci il numero di camere che prevedi di vendere per ogni stagione. La percentuale di occupazione verr√† calcolata automaticamente.
    </p>
    
    <!-- BOX INFO RIEPILOGO -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
        <div style="background: #e8f4f8; padding: 15px; border-radius: 8px; border-left: 4px solid #0d6efd;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Camere Disponibili</div>
            <div id="info_camere_disponibili" style="font-size: 24px; font-weight: bold; color: #0d6efd;">0</div>
        </div>
        <div style="background: #f0f8e8; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Giorni Apertura Annui</div>
            <div id="info_giorni_apertura" style="font-size: 24px; font-weight: bold; color: #28a745;">365</div>
        </div>
        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Capacit√† Totale (Camere√óGiorni)</div>
            <div id="info_capacita_totale" style="font-size: 24px; font-weight: bold; color: #ff9800;">0</div>
        </div>
    </div>
    
    <!-- TABELLA OCCUPAZIONE -->
    <table class="occupancy-table">
        <thead>
            <tr>
                <th style="width: 25%;">Periodo</th>
                <th style="width: 15%;">Giorni</th>
                <th style="width: 20%;">Camere Vendute</th>
                <th style="width: 20%;">Capacit√† Periodo</th>
                <th style="width: 20%;">Occupazione %</th>
            </tr>
        </thead>
        <tbody>
            <!-- ALTA STAGIONE -->
            <tr id="row_alta">
                <td><strong>Alta Stagione</strong></td>
                <td>
                    <input type="number" id="giorniAlta" value="120" min="0" max="365" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td>
                    <input type="number" id="camereAlta" value="0" min="0" step="1" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td id="capacitaAlta" style="text-align: center; background: #f8f9fa; font-weight: bold;">0</td>
                <td id="occAlta" style="text-align: center; background: #e8f5e9; font-weight: bold; color: #2e7d32; font-size: 16px;">0%</td>
            </tr>
            
            <!-- MEDIA STAGIONE -->
            <tr id="row_media">
                <td><strong>Media Stagione</strong></td>
                <td>
                    <input type="number" id="giorniMedia" value="120" min="0" max="365" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td>
                    <input type="number" id="camereMedia" value="0" min="0" step="1" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td id="capacitaMedia" style="text-align: center; background: #f8f9fa; font-weight: bold;">0</td>
                <td id="occMedia" style="text-align: center; background: #fff3e0; font-weight: bold; color: #ef6c00; font-size: 16px;">0%</td>
            </tr>
            
            <!-- BASSA STAGIONE -->
            <tr id="row_bassa">
                <td><strong>Bassa Stagione</strong></td>
                <td>
                    <input type="number" id="giorniBassa" value="125" min="0" max="365" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td>
                    <input type="number" id="camereBassa" value="0" min="0" step="1" 
                           oninput="calcolaOccupazione()" 
                           style="text-align: center; font-weight: bold;">
                </td>
                <td id="capacitaBassa" style="text-align: center; background: #f8f9fa; font-weight: bold;">0</td>
                <td id="occBassa" style="text-align: center; background: #ffebee; font-weight: bold; color: #c62828; font-size: 16px;">0%</td>
            </tr>
            
            <!-- RIGA SEPARATORE -->
            <tr style="height: 5px; background: #dee2e6;"><td colspan="5"></td></tr>
            
            <!-- TOTALI -->
            <tr style="background: #cfe2ff; font-weight: bold; font-size: 15px;">
                <td><strong>TOTALE ANNUO</strong></td>
                <td id="giorniTotali" style="text-align: center; color: #0d6efd;">365</td>
                <td id="camereTotali" style="text-align: center; color: #0d6efd;">0</td>
                <td id="capacitaTotale" style="text-align: center; color: #0d6efd;">0</td>
                <td id="occMediaTotale" style="text-align: center; color: #0d6efd; font-size: 18px;">0%</td>
            </tr>
        </tbody>
    </table>
    
    <!-- ALERT VALIDAZIONE GIORNI -->
    <div id="alert_giorni_stagioni" class="alert alert-warning" style="display: none; margin-top: 15px;">
        <strong>‚ö†Ô∏è Attenzione:</strong> <span id="alert_giorni_msg"></span>
    </div>
    
    <div id="alert_giorni_ok" class="alert alert-success" style="display: none; margin-top: 15px;">
        <strong>‚úÖ Perfetto!</strong> I giorni delle stagioni corrispondono ai giorni di apertura annui.
    </div>
</div>
                
                <button class="btn" onclick="showTab(1)">Continua: Dati Economici ‚Üí</button>
            </div>
            
            <!-- TAB 2: DATI ECONOMICI -->
            <div class="tab-content">
                <div class="alert alert-info"><strong>‚ÑπÔ∏è Dati Finanziari:</strong> Inserisci le proiezioni economiche dell'anno a regime.</div>
                
                <div class="section">
                    <h2>Ricavi Previsionali (anno a regime)</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Prezzo Medio Camera (‚Ç¨) *</label>
                            <input type="number" id="adr" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Fatturato Ristorazione (‚Ç¨)</label>
                            <input type="number" id="fattRistorazione" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Altri Ricavi (‚Ç¨)</label>
                            <input type="number" id="altriRicavi" value="0" min="0">
                        </div>
                        <div class="input-group" style="background: #e8f4f8; padding: 15px; border-radius: 8px;">
                            <label style="color: #0c5460;">Fatturato Totale Previsto (‚Ç¨)</label>
                            <input type="text" id="fatturatoTotale" readonly style="background: white; font-weight: bold; font-size: 18px; color: #0c5460;">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Costi Operativi (anno a regime)</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Materie Prime e Sussidiarie (‚Ç¨)</label>
                            <input type="number" id="costiMaterie" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Costo Personale (‚Ç¨) *</label>
                            <input type="number" id="costoPersonale" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Servizi Generali (‚Ç¨) *</label>
                            <input type="number" id="costiServizi" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Godimento Beni di Terzi (‚Ç¨)</label>
                            <input type="number" id="costiBeni" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Costi Vendita e Pubblicit√† (‚Ç¨)</label>
                            <input type="number" id="costiMarketing" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Spese Generali/Amministrative (‚Ç¨)</label>
                            <input type="number" id="speseGenerali" value="0" min="0">
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Ammortamenti e Gestione Finanziaria (anno a regime)</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Ammortamenti Immateriali (‚Ç¨)</label>
                            <input type="number" id="ammImmateriali" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Ammortamenti Materiali (‚Ç¨) *</label>
                            <input type="number" id="ammMateriali" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Oneri Finanziari (‚Ç¨)</label>
                            <input type="number" id="oneriFin" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Imposte sul Reddito (‚Ç¨)</label>
                            <input type="number" id="imposte" value="0" min="0">
                        </div>
                    </div>
                </div>
                
                <div id="datiConfronto" style="display: none;">
                    <div class="section">
                        <h2>Dati Esercizio Precedente</h2>
                        <div class="input-grid">
                            <div class="input-group">
                                <label>Fatturato Anno Precedente (‚Ç¨)</label>
                                <input type="number" id="fattPrecedente" value="0" min="0">
                            </div>
                            <div class="input-group">
                                <label>Risultato Operativo Precedente (‚Ç¨)</label>
                                <input type="number" id="risOpPrecedente" value="0">
                            </div>
                            <div class="input-group">
                                <label>Capitale Investito Precedente (‚Ç¨)</label>
                                <input type="number" id="capInvPrecedente" value="0" min="0">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="showTab(2)">Vai al Quadro H ‚Üí</button>
            </div>
            
            <!-- TAB 3: QUADRO H - PIANO FINANZIARIO -->
            <div class="tab-content">
                <div class="alert alert-info">
                    <strong>üìã Quadro H - Fattibilit√† Economica:</strong> Piano fonti/impieghi e tempistica investimenti.
                </div>
                
                <button class="btn btn-secondary" onclick="popolaQuadroH()">üîÑ Importa da Dati Base</button>
                <button class="btn" onclick="exportQuadroH()">üìä Esporta Quadro H (Excel)</button>
                
                <div class="section">
                    <h2>Piano Finanziario per la Copertura degli Investimenti</h2>
                    
                    <h3 style="margin: 20px 0 10px 0; color: #1e3c72;">FABBISOGNI (Impieghi)</h3>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Descrizione Investimento</th>
                                <th>Anno di avvio</th>
                                <th>+1</th>
                                <th>+2</th>
                                <th>TOT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">Investimenti immateriali</td>
                                <td><input type="number" id="h_immateriali_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_immateriali_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_immateriali_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_immateriali_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Investimenti materiali</td>
                                <td><input type="number" id="h_materiali_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_materiali_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_materiali_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_materiali_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">IVA sugli investimenti</td>
                                <td><input type="number" id="h_iva_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_iva_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_iva_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_iva_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Totale Fabbisogni</strong></td>
                                <td id="h_fabb_0" style="text-align: right;">0</td>
                                <td id="h_fabb_1" style="text-align: right;">0</td>
                                <td id="h_fabb_2" style="text-align: right;">0</td>
                                <td id="h_fabb_tot" style="text-align: right;">0</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <h3 style="margin: 30px 0 10px 0; color: #1e3c72;">FONTI (Copertura Finanziaria)</h3>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Fonti di Finanziamento</th>
                                <th>Anno di avvio</th>
                                <th>+1</th>
                                <th>+2</th>
                                <th>TOT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">Incremento Capitale Sociale</td>
                                <td><input type="number" id="h_capitale_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_capitale_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_capitale_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_capitale_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Contributo c/impianti</td>
                                <td><input type="number" id="h_contributo_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_contributo_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_contributo_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_contributo_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Finanziamenti a m/l termine</td>
                                <td><input type="number" id="h_fin_mlt_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_fin_mlt_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_fin_mlt_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_fin_mlt_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Finanziamenti a breve termine</td>
                                <td><input type="number" id="h_fin_bt_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_fin_bt_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_fin_bt_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_fin_bt_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Altre Disponibilit√†</td>
                                <td><input type="number" id="h_altre_0" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_altre_1" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td><input type="number" id="h_altre_2" value="0" oninput="calcolaTotaliQuadroH()"></td>
                                <td id="h_altre_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>Totale Fonti</strong></td>
                                <td id="h_fonti_0" style="text-align: right;">0</td>
                                <td id="h_fonti_1" style="text-align: right;">0</td>
                                <td id="h_fonti_2" style="text-align: right;">0</td>
                                <td id="h_fonti_tot" style="text-align: right;">0</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div id="h_alert_bilancio" class="alert alert-warning" style="display:none;">
                        <strong>‚ö†Ô∏è Attenzione:</strong> Fonti e Fabbisogni non sono bilanciati!
                        <br>Differenza: <span id="h_diff">0</span> ‚Ç¨
                    </div>
                    
                    <div id="h_alert_success" class="alert alert-success" style="display:none;">
                        <strong>‚úÖ Ottimo:</strong> Fonti e Fabbisogni sono perfettamente bilanciati!
                    </div>
			<!-- Dopo gli alert h_alert_bilancio e h_alert_success -->
<div id="h_verifica_dettagliata" style="margin-top: 20px;">
    <h3 style="color: #1e3c72; font-size: 16px; margin-bottom: 10px;">üìä Verifica Bilanciamento per Anno</h3>
    <table class="occupancy-table" style="width: 100%; max-width: 600px;">
        <thead>
            <tr>
                <th>Anno</th>
                <th>Fabbisogni</th>
                <th>Fonti</th>
                <th>Differenza</th>
                <th>Stato</th>
            </tr>
        </thead>
        <tbody>
            <tr id="verifica_anno_0">
                <td><strong>Anno Avvio</strong></td>
                <td id="verif_fabb_0" style="text-align: right;">-</td>
                <td id="verif_fonti_0" style="text-align: right;">-</td>
                <td id="verif_diff_0" style="text-align: right;">-</td>
                <td id="verif_stato_0" style="text-align: center;">-</td>
            </tr>
            <tr id="verifica_anno_1">
                <td><strong>Anno +1</strong></td>
                <td id="verif_fabb_1" style="text-align: right;">-</td>
                <td id="verif_fonti_1" style="text-align: right;">-</td>
                <td id="verif_diff_1" style="text-align: right;">-</td>
                <td id="verif_stato_1" style="text-align: center;">-</td>
            </tr>
            <tr id="verifica_anno_2">
                <td><strong>Anno +2</strong></td>
                <td id="verif_fabb_2" style="text-align: right;">-</td>
                <td id="verif_fonti_2" style="text-align: right;">-</td>
                <td id="verif_diff_2" style="text-align: right;">-</td>
                <td id="verif_stato_2" style="text-align: center;">-</td>
            </tr>
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td><strong>TOTALE</strong></td>
                <td id="verif_fabb_tot" style="text-align: right;">-</td>
                <td id="verif_fonti_tot" style="text-align: right;">-</td>
                <td id="verif_diff_tot" style="text-align: right;">-</td>
                <td id="verif_stato_tot" style="text-align: center;">-</td>
            </tr>
        </tbody>
    </table>
</div>
                </div>
                
                <div class="section">
                    <h2>Tempistica Prevista per la Realizzazione del Programma</h2>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 35%;">Descrizione Investimento</th>
                                <th>Importo da realizzare (IVA compresa)</th>
                                <th>Anno avvio</th>
                                <th>+1</th>
                                <th>+2</th>
                                <th>TOT</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">Consulenze specialistiche e studi</td>
                                <td><input type="number" id="temp_consulenze" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_consulenze_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_consulenze_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_consulenze_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_consulenze_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Oneri progettazione, direzione lavori</td>
                                <td><input type="number" id="temp_progettazione" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_progettazione_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_progettazione_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_progettazione_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_progettazione_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Acquisto suolo, fabbricati, immobili</td>
                                <td><input type="number" id="temp_immobili" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_immobili_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_immobili_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_immobili_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_immobili_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Opere murarie e assimilabili</td>
                                <td><input type="number" id="temp_opere" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_opere_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_opere_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_opere_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_opere_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Programmi informatici</td>
                                <td><input type="number" id="temp_software" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_software_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_software_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_software_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_software_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Macchinari, impianti, arredi</td>
                                <td><input type="number" id="temp_macchinari" value="0" oninput="calcolaTotaliTempistica()"></td>
                                <td><input type="number" id="temp_macchinari_0" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_macchinari_1" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td><input type="number" id="temp_macchinari_2" value="0" readonly style="background: #f0f0f0; cursor: not-allowed;"></td>
                                <td id="temp_macchinari_tot" style="text-align: right; font-weight: bold;">0</td>
                            </tr>
                            <tr class="total-row">
                                <td><strong>TOTALE</strong></td>
                                <td id="temp_tot_importo" style="text-align: right;">0</td>
                                <td id="temp_tot_0" style="text-align: right;">0</td>
                                <td id="temp_tot_1" style="text-align: right;">0</td>
                                <td id="temp_tot_2" style="text-align: right;">0</td>
                                <td id="temp_tot_finale" style="text-align: right;">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <button class="btn" onclick="showTab(3)">Continua: Quadro L ‚Üí</button>
            </div>
            
            <!-- TAB 4: QUADRO L - DATI DI BILANCIO -->
            <div class="tab-content">
                <div class="alert alert-info">
                    <strong>üìä Quadro L - Dati di Bilancio:</strong> Conto Economico e Stato Patrimoniale previsionali (importi in migliaia di euro).
                </div>
                
                <button class="btn btn-secondary" onclick="popolaQuadroL()">üîÑ Importa Anno a Regime</button>
                <button class="btn" onclick="exportQuadroL()">üìä Esporta Quadro L (Excel)</button>
                
                <div class="section">
                    <h2>Conto Economico - Importi in migliaia di euro</h2>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Conto Economico</th>
                                <th>Es. Precedente</th>
                                <th>202x</th>
                                <th>202x+1</th>
                                <th>202x+2</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background: #e8f4f8;">
                                <td class="label-cell"><strong>Fatturato</strong></td>
                                <td><input type="number" id="l_fatt_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_fatt_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_fatt_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_fatt_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Altri ricavi</td>
                                <td><input type="number" id="l_altri_ric_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_altri_ric_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_altri_ric_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_altri_ric_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>Valore della produzione</strong></td>
                                <td id="l_val_prod_prec" style="text-align: right;">0.0</td>
                                <td id="l_val_prod_0" style="text-align: right;">0.0</td>
                                <td id="l_val_prod_1" style="text-align: right;">0.0</td>
                                <td id="l_val_prod_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Acquisto materie prime e sussidiarie</td>
                                <td><input type="number" id="l_materie_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_materie_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_materie_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_materie_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Variazione rimanenze</td>
                                <td><input type="number" id="l_rimanenze_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_rimanenze_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_rimanenze_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_rimanenze_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Servizi e Godimento beni di terzi</td>
                                <td><input type="number" id="l_servizi_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_servizi_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_servizi_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_servizi_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Personale</td>
                                <td><input type="number" id="l_personale_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_personale_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_personale_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_personale_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #fff3cd;">
                                <td><strong>MOL</strong></td>
                                <td id="l_mol_prec" style="text-align: right;">0.0</td>
                                <td id="l_mol_0" style="text-align: right;">0.0</td>
                                <td id="l_mol_1" style="text-align: right;">0.0</td>
                                <td id="l_mol_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Svalutazioni e accantonamenti</td>
                                <td><input type="number" id="l_svalutazioni_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_svalutazioni_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_svalutazioni_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_svalutazioni_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d1ecf1;">
                                <td><strong>EBITDA</strong></td>
                                <td id="l_ebitda_prec" style="text-align: right;">0.0</td>
                                <td id="l_ebitda_0" style="text-align: right;">0.0</td>
                                <td id="l_ebitda_1" style="text-align: right;">0.0</td>
                                <td id="l_ebitda_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Ammortamenti imm. Immateriali</td>
                                <td><input type="number" id="l_amm_imm_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_imm_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_imm_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_imm_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Ammortamenti imm. Materiali</td>
                                <td><input type="number" id="l_amm_mat_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_mat_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_mat_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_amm_mat_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d4edda;">
                                <td><strong>Risultato Operativo (EBIT)</strong></td>
                                <td id="l_ris_op_prec" style="text-align: right;">0.0</td>
                                <td id="l_ris_op_0" style="text-align: right;">0.0</td>
                                <td id="l_ris_op_1" style="text-align: right;">0.0</td>
                                <td id="l_ris_op_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">(+/-) Gestione finanziaria</td>
                                <td><input type="number" id="l_gest_fin_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_fin_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_fin_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_fin_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">(+/-) Gestione straordinaria</td>
                                <td><input type="number" id="l_gest_str_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_str_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_str_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_gest_str_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>Risultato lordo</strong></td>
                                <td id="l_ris_lordo_prec" style="text-align: right;">0.0</td>
                                <td id="l_ris_lordo_0" style="text-align: right;">0.0</td>
                                <td id="l_ris_lordo_1" style="text-align: right;">0.0</td>
                                <td id="l_ris_lordo_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Imposte sul reddito</td>
                                <td><input type="number" id="l_imposte_prec" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_imposte_0" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_imposte_1" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                                <td><input type="number" id="l_imposte_2" value="0" step="0.1" oninput="calcolaTotaliQuadroL()"></td>
                            </tr>
                            <tr class="total-row" style="background: #cfe2ff; font-size: 14px;">
                                <td><strong>Risultato netto</strong></td>
                                <td id="l_ris_netto_prec" style="text-align: right;">0.0</td>
                                <td id="l_ris_netto_0" style="text-align: right;">0.0</td>
                                <td id="l_ris_netto_1" style="text-align: right;">0.0</td>
                                <td id="l_ris_netto_2" style="text-align: right;">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>Stato Patrimoniale - ATTIVO</h2>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">ATTIVO</th>
                                <th>Es. Precedente</th>
                                <th>202x</th>
                                <th>202x+1</th>
                                <th>202x+2</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">Immobilizzazioni immateriali</td>
                                <td><input type="number" id="sp_imm_imm_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_imm_imm_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_imm_imm_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_imm_imm_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>Tot. Immob. Immateriali nette</strong></td>
                                <td id="sp_tot_imm_prec" style="text-align: right;">0.0</td>
                                <td id="sp_tot_imm_0" style="text-align: right;">0.0</td>
                                <td id="sp_tot_imm_1" style="text-align: right;">0.0</td>
                                <td id="sp_tot_imm_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Terreni e fabbricati</td>
                                <td><input type="number" id="sp_terreni_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_terreni_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_terreni_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_terreni_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Impianti e macchinari</td>
                                <td><input type="number" id="sp_impianti_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_impianti_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_impianti_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_impianti_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Attrezzature, arredi e altri beni</td>
                                <td><input type="number" id="sp_attrezzature_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_attrezzature_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_attrezzature_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_attrezzature_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>Tot. Immob. Materiali nette</strong></td>
                                <td id="sp_tot_mat_prec" style="text-align: right;">0.0</td>
                                <td id="sp_tot_mat_0" style="text-align: right;">0.0</td>
                                <td id="sp_tot_mat_1" style="text-align: right;">0.0</td>
                                <td id="sp_tot_mat_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Partecipazioni</td>
                                <td><input type="number" id="sp_partec_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_partec_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_partec_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_partec_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Altri titoli immobilizzati</td>
                                <td><input type="number" id="sp_titoli_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_titoli_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_titoli_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_titoli_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>Tot. Immob. Finanziarie</strong></td>
                                <td id="sp_tot_fin_prec" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fin_0" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fin_1" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fin_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d4edda;">
                                <td><strong>TOTALE ATTIVO FISSO</strong></td>
                                <td id="sp_att_fisso_prec" style="text-align: right;">0.0</td>
                                <td id="sp_att_fisso_0" style="text-align: right;">0.0</td>
                                <td id="sp_att_fisso_1" style="text-align: right;">0.0</td>
                                <td id="sp_att_fisso_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Crediti</td>
                                <td><input type="number" id="sp_crediti_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_crediti_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_crediti_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_crediti_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Disponibilit√† liquide</td>
                                <td><input type="number" id="sp_liquidita_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_liquidita_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_liquidita_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_liquidita_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Ratei e risconti attivi</td>
                                <td><input type="number" id="sp_ratei_att_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_att_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_att_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_att_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d1ecf1;">
                                <td><strong>TOTALE ATTIVO CIRCOLANTE</strong></td>
                                <td id="sp_att_circ_prec" style="text-align: right;">0.0</td>
                                <td id="sp_att_circ_0" style="text-align: right;">0.0</td>
                                <td id="sp_att_circ_1" style="text-align: right;">0.0</td>
                                <td id="sp_att_circ_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr class="total-row" style="background: #cfe2ff; font-size: 14px;">
                                <td><strong>TOTALE ATTIVO</strong></td>
                                <td id="sp_totale_att_prec" style="text-align: right;">0.0</td>
                                <td id="sp_totale_att_0" style="text-align: right;">0.0</td>
                                <td id="sp_totale_att_1" style="text-align: right;">0.0</td>
                                <td id="sp_totale_att_2" style="text-align: right;">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>Stato Patrimoniale - PASSIVO E NETTO</h2>
                    <table class="quadro-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">PASSIVO E NETTO</th>
                                <th>Es. Precedente</th>
                                <th>202x</th>
                                <th>202x+1</th>
                                <th>202x+2</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="label-cell">Capitale sociale</td>
                                <td><input type="number" id="sp_capitale_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_capitale_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_capitale_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_capitale_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Riserve</td>
                                <td><input type="number" id="sp_riserve_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_riserve_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_riserve_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_riserve_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Utili (perdite)</td>
                                <td><input type="number" id="sp_utili_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_utili_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_utili_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_utili_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d4edda;">
                                <td><strong>PATRIMONIO NETTO</strong></td>
                                <td id="sp_patr_netto_prec" style="text-align: right;">0.0</td>
                                <td id="sp_patr_netto_0" style="text-align: right;">0.0</td>
                                <td id="sp_patr_netto_1" style="text-align: right;">0.0</td>
                                <td id="sp_patr_netto_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Fondo indennit√† TFR</td>
                                <td><input type="number" id="sp_tfr_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_tfr_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_tfr_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_tfr_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Altri fondi rischi e oneri</td>
                                <td><input type="number" id="sp_fondi_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fondi_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fondi_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fondi_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>FONDI</strong></td>
                                <td id="sp_tot_fondi_prec" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fondi_0" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fondi_1" style="text-align: right;">0.0</td>
                                <td id="sp_tot_fondi_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Debiti m/l termine</td>
                                <td><input type="number" id="sp_debiti_mlt_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_mlt_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_mlt_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_mlt_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row">
                                <td><strong>PASSIVITA' CONSOLIDATE</strong></td>
                                <td id="sp_pass_cons_prec" style="text-align: right;">0.0</td>
                                <td id="sp_pass_cons_0" style="text-align: right;">0.0</td>
                                <td id="sp_pass_cons_1" style="text-align: right;">0.0</td>
                                <td id="sp_pass_cons_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr>
                                <td class="label-cell">Debiti breve termine</td>
                                <td><input type="number" id="sp_debiti_bt_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_bt_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_bt_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_debiti_bt_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Debiti v/fornitori</td>
                                <td><input type="number" id="sp_fornitori_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fornitori_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fornitori_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_fornitori_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr>
                                <td class="label-cell">Ratei e risconti passivi</td>
                                <td><input type="number" id="sp_ratei_pass_prec" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_pass_0" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_pass_1" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                                <td><input type="number" id="sp_ratei_pass_2" value="0" step="0.1" oninput="calcolaTotaliStatoPatrimoniale()"></td>
                            </tr>
                            <tr class="subtotal-row" style="background: #d1ecf1;">
                                <td><strong>PASSIVITA' CORRENTI</strong></td>
                                <td id="sp_pass_corr_prec" style="text-align: right;">0.0</td>
                                <td id="sp_pass_corr_0" style="text-align: right;">0.0</td>
                                <td id="sp_pass_corr_1" style="text-align: right;">0.0</td>
                                <td id="sp_pass_corr_2" style="text-align: right;">0.0</td>
                            </tr>
                            <tr class="total-row" style="background: #cfe2ff; font-size: 14px;">
                                <td><strong>TOTALE PASSIVO</strong></td>
                                <td id="sp_totale_pass_prec" style="text-align: right;">0.0</td>
                                <td id="sp_totale_pass_0" style="text-align: right;">0.0</td>
                                <td id="sp_totale_pass_1" style="text-align: right;">0.0</td>
                                <td id="sp_totale_pass_2" style="text-align: right;">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div id="sp_alert_quadratura" class="alert alert-warning" style="display:none;">
                        <strong>‚ö†Ô∏è Attenzione:</strong> Attivo e Passivo non quadrano! Verifica i dati inseriti.
                    </div>
                    
                    <div id="sp_alert_success" class="alert alert-success" style="display:none;">
                        <strong>‚úÖ Perfetto:</strong> Stato Patrimoniale quadrato correttamente!
                    </div>
                </div>
                
                <button class="btn" onclick="showTab(4)">Continua: Visualizza Indici ‚Üí</button>
            </div>
            
            <!-- TAB 5: INDICI E RISULTATI -->
            <div class="tab-content">
                <button class="btn print-btn" onclick="window.print()">üñ®Ô∏è Stampa Report</button>
                <button class="btn btn-warning" onclick="calcola()">üßÆ CALCOLA TUTTI GLI INDICI</button>
                <button class="btn" onclick="exportExcel()">üìä Esporta Excel</button>
                
                <div class="alert alert-info"><strong>üìä Dashboard Risultati:</strong> Analisi completa degli indici economici e operativi.</div>
                
                <div class="section">
                    <h2>Indici Economico-Finanziari</h2>
                    <!-- BOX VARIAZIONI (solo per imprese attive) -->
    <div id="boxVariazioni" style="display: none; margin-bottom: 20px; padding: 20px; background: #e8f4f8; border-radius: 10px; border-left: 4px solid #17a2b8;">
        <h3 style="color: #0c5460; margin-bottom: 15px;">üìä Analisi Variazioni (Impresa Attiva)</h3>
        <table class="occupancy-table">
            <thead>
                <tr>
                    <th>Indicatore</th>
                    <th>Anno Precedente</th>
                    <th>Anno a Regime</th>
                    <th>Variazione Assoluta</th>
                    <th>Variazione %</th>
                    <th>Punti Criterio</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>ROS</strong></td>
                    <td id="var_ros_prec">-</td>
                    <td id="var_ros_regime">-</td>
                    <td id="var_ros_assoluta">-</td>
                    <td id="var_ros_perc" style="font-weight: bold;">-</td>
                    <td id="var_ros_punti" style="text-align: center; font-weight: bold;">-</td>
                </tr>
                <tr>
                    <td><strong>ROI</strong></td>
                    <td id="var_roi_prec">-</td>
                    <td id="var_roi_regime">-</td>
                    <td id="var_roi_assoluta">-</td>
                    <td id="var_roi_perc" style="font-weight: bold;">-</td>
                    <td id="var_roi_punti" style="text-align: center; font-weight: bold;">-</td>
                </tr>
                <tr>
                    <td><strong>EBITDA Margin</strong></td>
                    <td id="var_ebitda_prec">-</td>
                    <td id="var_ebitda_regime">-</td>
                    <td id="var_ebitda_assoluta">-</td>
                    <td id="var_ebitda_perc" style="font-weight: bold;">-</td>
                    <td id="var_ebitda_punti" style="text-align: center; font-weight: bold;">-</td>
                </tr>
            </tbody>
        </table>
        
        <div style="margin-top: 15px; padding: 10px; background: #fff; border-radius: 5px;">
            <p style="margin: 5px 0; font-size: 13px;">
                <strong>üìå Criteri di valutazione per imprese attive:</strong>
            </p>
            <ul style="margin: 10px 0 0 20px; font-size: 12px; line-height: 1.6;">
                <li><strong>ROS/ROI:</strong> Variazione >10% = 4 punti | ‚â•5% = 2 punti</li>
                <li><strong>EBITDA Margin:</strong> Variazione >20% = 4 punti | ‚â•8% = 2 punti</li>
            </ul>
        </div>
    </div>

                    <div class="results-grid">
                        <div class="result-card">
                            <h3>ROS - Return On Sales</h3>
                            <div class="result-value" id="rosValue">-</div>
                            <div class="result-benchmark">Target: >20%</div>
                            <span class="result-status" id="rosStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>ROI - Return On Investment</h3>
                            <div class="result-value" id="roiValue">-</div>
                            <div class="result-benchmark">Target: >15%</div>
                            <span class="result-status" id="roiStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>EBITDA Margin</h3>
                            <div class="result-value" id="ebitdaValue">-</div>
                            <div class="result-benchmark">Target: >30%</div>
                            <span class="result-status" id="ebitdaStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>Margine Operativo Lordo</h3>
                            <div class="result-value" id="molValue">-</div>
                            <div class="result-benchmark">In valore assoluto</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Indici Operativi Turistici</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>Tasso Occupazione</h3>
                            <div class="result-value" id="torValue">-</div>
                            <div class="result-benchmark">Target: >70%</div>
                            <span class="result-status" id="torStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>Ricavo per camera disponibile</h3>
                            <div class="result-value" id="revparValue">-</div>
                            <div class="result-benchmark"></div>
                        </div>
                        <div class="result-card">
                            <h3>Tariffa Media</h3>
                            <div class="result-value" id="adrResultValue">-</div>
                            <div class="result-benchmark"></div>
                        </div>
                        <div class="result-card">
                            <h3>GOPPAR</h3>
                            <div class="result-value" id="gopparValue">-</div>
                            <div class="result-benchmark">Utile Operativo Lordo per Camera Disponibile</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Indici Efficienza</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>Costo del lavoro %</h3>
                            <div class="result-value" id="laborValue">-</div>
                            <div class="result-benchmark">Target: <35%</div>
                            <span class="result-status" id="laborStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>Produttivit√† Dipendente</h3>
                            <div class="result-value" id="prodValue">-</div>
                            <div class="result-benchmark">Fatturato per ULA</div>
                            <span class="result-status" id="prodStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>Inv/Occupazione</h3>
                            <div class="result-value" id="invOccValue">-</div>
                            <div class="result-benchmark">‚Ç¨ per ULA</div>
                            <span class="result-status" id="invOccStatus">-</span>
                        </div>
                        <div class="result-card">
                            <h3>Tasso Saturazione</h3>
                            <div class="result-value" id="satValue">-</div>
                            <div class="result-benchmark"></div>
                            <span class="result-status" id="satStatus">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>Riepilogo Economico</h2>
                    <table class="occupancy-table">
                        <tr><th>Voce</th><th style="text-align: right;">Importo (‚Ç¨)</th></tr>
                        <tr><td><strong>Fatturato Totale</strong></td><td style="text-align: right;" id="recap_fatt">-</td></tr>
                        <tr><td>Costi Operativi</td><td style="text-align: right;" id="recap_costi">-</td></tr>
                        <tr style="background: #f0f0f0;"><td><strong>MOL</strong></td><td style="text-align: right;" id="recap_mol">-</td></tr>
                        <tr><td>Ammortamenti</td><td style="text-align: right;" id="recap_amm">-</td></tr>
                        <tr style="background: #e8f4f8;"><td><strong>EBITDA</strong></td><td style="text-align: right;" id="recap_ebitda">-</td></tr>
                        <tr style="background: #d4edda;"><td><strong>Risultato Operativo</strong></td><td style="text-align: right;" id="recap_risop">-</td></tr>
                        <tr><td>Oneri Finanziari</td><td style="text-align: right;" id="recap_fin">-</td></tr>
                        <tr><td>Imposte</td><td style="text-align: right;" id="recap_imp">-</td></tr>
                        <tr style="background: #cfe2ff; font-weight: bold;"><td><strong>RISULTATO NETTO</strong></td><td style="text-align: right;" id="recap_netto">-</td></tr>
                    </table>
                </div>
                
                <button class="btn" onclick="showTab(5)">Vai al Punteggio Bando ‚Üí</button>
            </div>
            
            <!-- TAB 6: PUNTEGGIO BANDO -->
            <div class="tab-content">
                <div class="alert alert-warning"><strong>‚ö†Ô∏è Attenzione:</strong> Punteggi calcolati automaticamente. Verifica sempre con il bando ufficiale.</div>
                
                <div class="score-card">
                    <h3>PUNTEGGIO TOTALE GRIGLIA VALUTAZIONE</h3>
                    <div class="score-value" id="punteggioTotale">0</div>
                    <div class="score-max">su 76 punti massimi</div>
                </div>
                
                <div class="section">
                    <h2>A) Rapporto Investimento/Occupazione</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>Investimento per ULA</h3>
                            <div class="result-value" id="griglia_invula">-</div>
                            <div class="result-benchmark">Max 6 punti</div>
                            <span class="result-status status-good" id="griglia_invula_punti">0 punti</span>
                        </div>
                    </div>
                    <table class="occupancy-table">
                        <thead><tr><th>Criterio</th><th>Soglia</th><th>Punti</th><th>Status</th></tr></thead>
                        <tbody id="griglia_a_dettaglio"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>B) Rapporto Investimento Operativo</h2>
                    <div class="alert alert-success">
                        <strong>‚ÑπÔ∏è Criterio B:</strong> Premia chi investe di pi√π in macchinari e impianti.
                    </div>
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>Rapporto Inv. Operativo</h3>
                            <div class="result-value" id="griglia_invop">-</div>
                            <div class="result-benchmark">Max 20 punti</div>
                            <span class="result-status status-good" id="griglia_invop_punti">0 punti</span>
                        </div>
                    </div>
                    <table class="occupancy-table">
                        <thead><tr><th>Rapporto</th><th>% Operativa</th><th>Punti</th><th>Status</th></tr></thead>
                        <tbody id="griglia_b_dettaglio"></tbody>
                    </table>
                </div>
                
                <div class="section">
                    <h2>C) Risultati Economici Attesi</h2>
                    <div class="results-grid">
                        <div class="result-card"><h3>ROS</h3><div class="result-value" id="griglia_ros">-</div><span class="result-status status-good" id="griglia_ros_punti">0 punti</span></div>
                        <div class="result-card"><h3>ROI</h3><div class="result-value" id="griglia_roi">-</div><span class="result-status status-good" id="griglia_roi_punti">0 punti</span></div>
                        <div class="result-card"><h3>EBITDA Margin</h3><div class="result-value" id="griglia_ebitda">-</div><span class="result-status status-good" id="griglia_ebitda_punti">0 punti</span></div>
                        <div class="result-card"><h3>Tasso Saturazione</h3><div class="result-value" id="griglia_sat">-</div><span class="result-status status-good" id="griglia_sat_punti">0 punti</span></div>
                    </div>
                    <div style="text-align: center; margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 10px;">
                        <h3 style="margin-bottom: 10px;">Subtotale Risultati Economici</h3>
                        <div style="font-size: 36px; font-weight: bold; color: #667eea;" id="griglia_c_tot">0 punti</div>
                        <div style="color: #666;">Max 16 punti</div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>D) Qualit√† Progettuale (Max 14 punti)</h2>
                    <div class="checkbox-group">
                        <label>
                            <input type="radio" name="qualita_prog" value="14" onchange="aggiornaQualitaProgettuale()">
                            <strong>Restauro conservativo</strong> (14 punti)
                        </label>
                        <label>
                            <input type="radio" name="qualita_prog" value="10" onchange="aggiornaQualitaProgettuale()">
                            <strong>Manutenzione straordinaria</strong> (10 punti)
                        </label>
                        <label>
                            <input type="radio" name="qualita_prog" value="7" onchange="aggiornaQualitaProgettuale()">
                            <strong>Ristrutturazione parziale</strong> (7 punti)
                        </label>
                        <label>
                            <input type="radio" name="qualita_prog" value="5" onchange="aggiornaQualitaProgettuale()">
                            <strong>Ammodernamento</strong> (5 punti)
                        </label>
                        <label>
                            <input type="radio" name="qualita_prog" value="0" checked onchange="aggiornaQualitaProgettuale()">
                            <strong>Nessun intervento rilevante</strong> (0 punti)
                        </label>
                    </div>
                    <p style="margin-top: 15px; text-align: center;">
                        <strong>Punteggio D:</strong> <span id="punteggio_d_display" style="color: #667eea; font-size: 24px; font-weight: bold;">0</span> punti
                    </p>
                    <input type="hidden" id="griglia_d" value="0">
                </div>
                <div class="section">
    <h2>D.3) Efficientamento della Spesa (Max 10 punti)</h2>
    <div class="input-grid">
        <div class="input-group">
            <label>Importo Coperto da Preventivi Vincolanti (‚Ç¨)</label>
            <input type="number" id="importoPreventiviVincolanti" value="0" min="0" step="1000" onchange="calcolaEfficienzaSpesa()">
            <span class="hint">Somma delle spese con preventivi allegati</span>
        </div>
        <div class="input-group">
            <label>Rapporto Preventivi/Totale (%)</label>
            <input type="text" id="rapportoPreventivi" readonly style="background: #f0f0f0;">
        </div>
    </div>
    <div id="punteggio_d3" style="margin-top: 15px; text-align: center;">
        <strong>Punteggio D.3:</strong> <span id="punteggio_d3_display" style="font-size: 24px; color: #667eea;">0</span> punti
    </div>
</div>
                <div class="section">
                    <h2>E) Sostenibilit√† Ambientale (Max 10 punti)</h2>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" name="sostenibilita" value="3" onchange="aggiornaSostenibilitaAmbientale()">
                            <strong>Impianti fotovoltaici</strong> (3 punti)
                        </label>
                        <label>
                            <input type="checkbox" name="sostenibilita" value="3" onchange="aggiornaSostenibilitaAmbientale()">
                            <strong>Sistema recupero acque</strong> (3 punti)
                        </label>
                        <label>
                            <input type="checkbox" name="sostenibilita" value="2" onchange="aggiornaSostenibilitaAmbientale()">
                            <strong>Relamping LED</strong> (2 punti)
                        </label>
                        <label>
                            <input type="checkbox" name="sostenibilita" value="2" onchange="aggiornaSostenibilitaAmbientale()">
                            <strong>Coibentazione termica</strong> (2 punti)
                        </label>
                        <label>
                            <input type="checkbox" name="sostenibilita" value="2" onchange="aggiornaSostenibilitaAmbientale()">
                            <strong>Pompe di calore</strong> (2 punti)
                        </label>
                    </div>
                    <p style="margin-top: 15px; text-align: center;">
                        <strong>Punteggio E:</strong> <span id="punteggio_e_display" style="color: #667eea; font-size: 24px; font-weight: bold;">0</span> punti
                        <span id="punteggio_e_warning" style="color: #ff6b6b; font-weight: bold;"></span>
                    </p>
                    <input type="hidden" id="griglia_e" value="0">
                </div>
                
                <div class="section">
                    <h2>F) Localizzazione (0-10 punti)</h2>
                    <div class="alert alert-info"><strong>‚ÑπÔ∏è Calcolo automatico:</strong> Punteggio calcolato dal Comune selezionato.</div>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>F) Punteggio Localizzazione</label>
                            <input type="number" id="griglia_f" value="0" min="0" max="10" step="1" readonly>
                        </div>
                        <div class="input-group">
                            <label><input type="checkbox" id="overrideF" onchange="toggleOverrideF()"> Abilita modifica manuale</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="calcolaPunteggio()">üéØ Ricalcola Punteggio Totale</button>
    
                <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h2 style="color: white;">üìã Riepilogo Finale Punteggi</h2>
                    <table class="occupancy-table">
                        <thead><tr><th style="background: rgba(255,255,255,0.2);">Criterio</th><th style="background: rgba(255,255,255,0.2); text-align: center;">Ottenuti</th><th style="background: rgba(255,255,255,0.2); text-align: center;">Max</th></tr></thead>
                        <tbody style="background: white; color: #333;">
                            <tr><td>A) Investimento/Occupazione</td><td style="text-align: center; font-weight: bold;" id="final_a">0</td><td style="text-align: center;">6</td></tr>
                            <tr><td>B) Investimento Operativo</td><td style="text-align: center; font-weight: bold;" id="final_b">0</td><td style="text-align: center;">20</td></tr>
                            <tr><td>C) Risultati Economici</td><td style="text-align: center; font-weight: bold;" id="final_c">0</td><td style="text-align: center;">16</td></tr>
                            <tr><td>D) Qualit√† Progettuale</td><td style="text-align: center; font-weight: bold;" id="final_d">0</td><td style="text-align: center;">14</td></tr>
                            <tr><td>E) Sostenibilit√†</td><td style="text-align: center; font-weight: bold;" id="final_e">0</td><td style="text-align: center;">10</td></tr>
                            <tr><td>F) Localizzazione</td><td style="text-align: center; font-weight: bold;" id="final_f">0</td><td style="text-align: center;">10</td></tr>
                            <tr style="background: #ffd700; font-weight: bold; font-size: 18px;"><td><strong>TOTALE</strong></td><td style="text-align: center;" id="final_tot">0</td><td style="text-align: center;">76</td></tr>
                        </tbody>
                    </table>
                </div>
                
<div style="text-align: center; padding: 15px; background: #f5f5f5;">
    <button class="btn btn-warning" onclick="resetCompleto()" style="font-size: 12px;">
        üîÑ RESET COMPLETO - Nuovo Calcolo
    </button>
    <span style="margin-left: 20px; font-size: 13px; color: #666;">
        ‚ö†Ô∏è Attenzione: canceller√† tutti i dati inseriti
    </span>
</div>
            </div>
        </div>
    </div>
    
    <script>
        // ========== VARIABILI GLOBALI ==========
        const comuniCsv = `PROVINCIA;SIGLA PROVINCIA;CODICE CATASTALE;COMUNE;Punteggio totale;Isola minore;Ricettivit√† turistica;Area rurale
CATANIA;CT;A025;ACI BONACCORSI;0;0;0;0
CATANIA;CT;A026;ACI CASTELLO;0;0;0;0
CATANIA;CT;A027;ACI CATENA;0;0;0;0
CATANIA;CT;A029;ACI SANT'ANTONIO;0;0;0;0
CATANIA;CT;A028;ACIREALE;0;0;0;0
CATANIA;CT;A056;ADRANO;1;0;1;0
CATANIA;CT;A766;BELPASSO;1;0;1;0
CATANIA;CT;A841;BIANCAVILLA;1;0;1;0
CATANIA;CT;B202;BRONTE;2;0;1;1
CATANIA;CT;B384;CALATABIANO;0;0;0;0
CATANIA;CT;B428;CALTAGIRONE;2;0;1;1
CATANIA;CT;B561;CAMPOROTONDO ETNEO;1;0;1;0
CATANIA;CT;C091;CASTEL DI IUDICA;2;0;1;1
CATANIA;CT;C297;CASTIGLIONE DI SICILIA;2;0;1;1
CATANIA;CT;C351;CATANIA;0;0;0;0
CATANIA;CT;D623;FIUMEFREDDO DI SICILIA;0;0;0;0
CATANIA;CT;E017;GIARRE;0;0;0;0
CATANIA;CT;E133;GRAMMICHELE;1;0;1;0
CATANIA;CT;E156;GRAVINA DI CATANIA;0;0;0;0
CATANIA;CT;E578;LICODIA EUBEA;2;0;1;1
CATANIA;CT;E602;LINGUAGLOSSA;2;0;1;1
CATANIA;CT;E854;MALETTO;2;0;1;1
CATANIA;CT;M283;MANIACE;2;0;1;1
CATANIA;CT;F004;MASCALI;0;0;0;0
CATANIA;CT;F005;MASCALUCIA;0;0;0;0
CATANIA;CT;M271;MAZZARRONE;2;0;1;1
CATANIA;CT;F209;MILITELLO IN VAL DI CATANIA;2;0;1;1
CATANIA;CT;F214;MILO;1;0;0;1
CATANIA;CT;F217;MINEO;2;0;1;1
CATANIA;CT;F231;MIRABELLA IMBACCARI;1;0;1;0
CATANIA;CT;F250;MISTERBIANCO;1;0;1;0
CATANIA;CT;F781;MOTTA SANT'ANASTASIA;1;0;1;0
CATANIA;CT;F890;NICOLOSI;0;0;0;0
CATANIA;CT;G253;PALAGONIA;1;0;1;0
CATANIA;CT;G371;PATERNO';1;0;1;0
CATANIA;CT;G402;PEDARA;0;0;0;0
CATANIA;CT;G597;PIEDIMONTE ETNEO;1;0;0;1
CATANIA;CT;H154;RADDUSA;2;0;1;1
CATANIA;CT;M287;RAGALNA;2;0;1;1
CATANIA;CT;H168;RAMACCA;2;0;1;1
CATANIA;CT;H175;RANDAZZO;2;0;1;1
CATANIA;CT;H325;RIPOSTO;0;0;0;0
CATANIA;CT;H805;SAN CONO;1;0;1;0
CATANIA;CT;H922;SAN GIOVANNI LA PUNTA;0;0;0;0
CATANIA;CT;H940;SAN GREGORIO DI CATANIA;0;0;0;0
CATANIA;CT;I035;SAN MICHELE DI GANZARIA;2;0;1;1
CATANIA;CT;I098;SAN PIETRO CLARENZA;1;0;1;0
CATANIA;CT;I240;SANTA MARIA DI LICODIA;1;0;1;0
CATANIA;CT;I314;SANTA VENERINA;0;0;0;0
CATANIA;CT;I202;SANT'AGATA LI BATTIATI;1;0;1;0
CATANIA;CT;I216;SANT'ALFIO;2;0;1;1
CATANIA;CT;I548;SCORDIA;1;0;1;0
CATANIA;CT;L355;TRECASTAGNI;0;0;0;0
CATANIA;CT;L369;TREMESTIERI ETNEO;1;0;1;0
CATANIA;CT;L658;VALVERDE;0;0;0;0
CATANIA;CT;L828;VIAGRANDE;0;0;0;0
CATANIA;CT;M100;VIZZINI;2;0;1;1
CATANIA;CT;M139;ZAFFERANA ETNEA;2;0;1;1
ENNA;EN;A070;AGIRA;2;0;1;1
ENNA;EN;A098;AIDONE;2;0;1;1
ENNA;EN;A478;ASSORO;2;0;1;1
ENNA;EN;A676;BARRAFRANCA;1;0;1;0
ENNA;EN;B381;CALASCIBETTA;2;0;1;1
ENNA;EN;C353;CATENANUOVA;1;0;1;0
ENNA;EN;C471;CENTURIPE;2;0;1;1
ENNA;EN;C480;CERAMI;2;0;1;1
ENNA;EN;C342;ENNA;2;0;1;1
ENNA;EN;D849;GAGLIANO CASTELFERRATO;2;0;1;1
ENNA;EN;E536;LEONFORTE;2;0;1;1
ENNA;EN;F892;NICOSIA;2;0;1;1
ENNA;EN;F900;NISSORIA;2;0;1;1
ENNA;EN;G580;PIAZZA ARMERINA;2;0;1;1
ENNA;EN;G624;PIETRAPERZIA;2;0;1;1
ENNA;EN;H221;REGALBUTO;2;0;1;1
ENNA;EN;I891;SPERLINGA;2;0;1;1
ENNA;EN;L448;TROINA;2;0;1;1
ENNA;EN;L583;VALGUARNERA CAROPEPE;1;0;1;0
ENNA;EN;M011;VILLAROSA;2;0;1;1
SIRACUSA;SR;A494;AUGUSTA;0;0;0;0
SIRACUSA;SR;A522;AVOLA;0;0;0;0
SIRACUSA;SR;B237;BUCCHERI;2;0;1;1
SIRACUSA;SR;B287;BUSCEMI;2;0;1;1
SIRACUSA;SR;B603;CANICATTINI BAGNI;1;0;1;0
SIRACUSA;SR;B787;CARLENTINI;2;0;1;1
SIRACUSA;SR;C006;CASSARO;2;0;1;1
SIRACUSA;SR;D540;FERLA;2;0;1;1
SIRACUSA;SR;D636;FLORIDIA;1;0;1;0
SIRACUSA;SR;D768;FRANCOFONTE;1;0;1;0
SIRACUSA;SR;E532;LENTINI;2;0;1;1
SIRACUSA;SR;F107;MELILLI;2;0;1;1
SIRACUSA;SR;F943;NOTO;1;0;0;1
SIRACUSA;SR;G211;PACHINO;0;0;0;0
SIRACUSA;SR;G267;PALAZZOLO ACREIDE;2;0;1;1
SIRACUSA;SR;M257;PORTOPALO DI CAPO PASSERO;0;0;0;0
SIRACUSA;SR;M279;PRIOLO GARGALLO;1;0;1;0
SIRACUSA;SR;H574;ROSOLINI;1;0;1;0
SIRACUSA;SR;I754;SIRACUSA;0;0;0;0
SIRACUSA;SR;I785;SOLARINO;0;0;0;0
SIRACUSA;SR;I864;SORTINO;2;0;1;1
TRAPANI;TP;A176;ALCAMO;0;0;0;0
TRAPANI;TP;B288;BUSETO PALIZZOLO;2;0;1;1
TRAPANI;TP;B385;CALATAFIMI-SEGESTA;2;0;1;1
TRAPANI;TP;B521;CAMPOBELLO DI MAZARA;1;0;1;0
TRAPANI;TP;C130;CASTELLAMMARE DEL GOLFO;1;0;0;1
TRAPANI;TP;C286;CASTELVETRANO;1;0;0;1
TRAPANI;TP;D234;CUSTONACI;1;0;0;1
TRAPANI;TP;D423;ERICE;0;0;0;0
TRAPANI;TP;D518;FAVIGNANA;2;1;0;1
TRAPANI;TP;E023;GIBELLINA;2;0;1;1
TRAPANI;TP;E974;MARSALA;0;0;0;0
TRAPANI;TP;F061;MAZARA DEL VALLO;1;0;1;0
TRAPANI;TP;G208;PACECO;1;0;1;0
TRAPANI;TP;G315;PANTELLERIA;2;1;0;1
TRAPANI;TP;G347;PARTANNA;2;0;1;1
TRAPANI;TP;M281;PETROSINO;0;0;0;0
TRAPANI;TP;G767;POGGIOREALE;2;0;1;1
TRAPANI;TP;H688;SALAPARUTA;2;0;1;1
TRAPANI;TP;H700;SALEMI;2;0;1;1
TRAPANI;TP;I407;SAN VITO LO CAPO;1;0;0;1
TRAPANI;TP;I291;SANTA NINFA;2;0;1;1
TRAPANI;TP;L331;TRAPANI;0;0;0;0
TRAPANI;TP;G319;VALDERICE;0;0;0;0
TRAPANI;TP;M081;VITA;1;0;1;0
TRAPANI;TP;M432;MISILISCEMI;2;0;1;1
CALTANISSETTA;CL;A049;ACQUAVIVA PLATANI;2;0;1;1
CALTANISSETTA;CL;A957;BOMPENSIERE;2;0;1;1
CALTANISSETTA;CL;B302;BUTERA;2;0;1;1
CALTANISSETTA;CL;B429;CALTANISSETTA;2;0;1;1
CALTANISSETTA;CL;B537;CAMPOFRANCO;2;0;1;1
CALTANISSETTA;CL;D267;DELIA;1;0;1;0
CALTANISSETTA;CL;D960;GELA;1;0;1;0
CALTANISSETTA;CL;E953;MARIANOPOLI;2;0;1;1
CALTANISSETTA;CL;F065;MAZZARINO;2;0;1;1
CALTANISSETTA;CL;E618;MILENA;2;0;1;1
CALTANISSETTA;CL;F489;MONTEDORO;2;0;1;1
CALTANISSETTA;CL;F830;MUSSOMELI;2;0;1;1
CALTANISSETTA;CL;F899;NISCEMI;1;0;1;0
CALTANISSETTA;CL;H245;RESUTTANO;2;0;1;1
CALTANISSETTA;CL;H281;RIESI;1;0;1;0
CALTANISSETTA;CL;H792;SAN CATALDO;1;0;1;0
CALTANISSETTA;CL;I169;SANTA CATERINA VILLARMOSA;2;0;1;1
CALTANISSETTA;CL;I644;SERRADIFALCO;2;0;1;1
CALTANISSETTA;CL;I824;SOMMATINO;1;0;1;0
CALTANISSETTA;CL;L016;SUTERA;2;0;1;1
CALTANISSETTA;CL;L609;VALLELUNGA PRATAMENO;2;0;1;1
CALTANISSETTA;CL;L959;VILLALBA;2;0;1;1
PALERMO;PA;A195;ALIA;2;0;1;1
PALERMO;PA;A202;ALIMENA;2;0;1;1
PALERMO;PA;A203;ALIMINUSA;2;0;1;1
PALERMO;PA;A229;ALTAVILLA MILICIA;0;0;0;0
PALERMO;PA;A239;ALTOFONTE;1;0;1;0
PALERMO;PA;A546;BAGHERIA;0;0;0;0
PALERMO;PA;A592;BALESTRATE;0;0;0;0
PALERMO;PA;A719;BAUCINA;2;0;1;1
PALERMO;PA;A764;BELMONTE MEZZAGNO;1;0;1;0
PALERMO;PA;A882;BISACQUINO;2;0;1;1
PALERMO;PA;M268;BLUFI;2;0;1;1
PALERMO;PA;A946;BOLOGNETTA;2;0;1;1
PALERMO;PA;A958;BOMPIETRO;2;0;1;1
PALERMO;PA;A991;BORGETTO;1;0;1;0
PALERMO;PA;B315;CACCAMO;2;0;1;1
PALERMO;PA;B430;CALTAVUTURO;2;0;1;1
PALERMO;PA;B533;CAMPOFELICE DI FITALIA;2;0;1;1
PALERMO;PA;B532;CAMPOFELICE DI ROCCELLA;0;0;0;0
PALERMO;PA;B535;CAMPOFIORITO;2;0;1;1
PALERMO;PA;B556;CAMPOREALE;2;0;1;1
PALERMO;PA;B645;CAPACI;0;0;0;0
PALERMO;PA;B780;CARINI;0;0;0;0
PALERMO;PA;C067;CASTELBUONO;2;0;1;1
PALERMO;PA;C074;CASTELDACCIA;0;0;0;0
PALERMO;PA;C135;CASTELLANA SICULA;2;0;1;1
PALERMO;PA;C344;CASTRONOVO DI SICILIA;2;0;1;1
PALERMO;PA;C420;CEFALA' DIANA;2;0;1;1
PALERMO;PA;C421;CEFALU';0;0;0;0
PALERMO;PA;C496;CERDA;2;0;1;1
PALERMO;PA;C654;CHIUSA SCLAFANI;2;0;1;1
PALERMO;PA;C696;CIMINNA;2;0;1;1
PALERMO;PA;C708;CINISI;0;0;0;0
PALERMO;PA;C871;COLLESANO;2;0;1;1
PALERMO;PA;C968;CONTESSA ENTELLINA;2;0;1;1
PALERMO;PA;D009;CORLEONE;2;0;1;1
PALERMO;PA;D567;FICARAZZI;0;0;0;0
PALERMO;PA;D907;GANGI;2;0;1;1
PALERMO;PA;D977;GERACI SICULO;2;0;1;1
PALERMO;PA;E013;GIARDINELLO;1;0;1;0
PALERMO;PA;E055;GIULIANA;2;0;1;1
PALERMO;PA;E074;GODRANO;2;0;1;1
PALERMO;PA;E149;GRATTERI;2;0;1;1
PALERMO;PA;E337;ISNELLO;2;0;1;1
PALERMO;PA;E350;ISOLA DELLE FEMMINE;0;0;0;0
PALERMO;PA;E459;LASCARI;0;0;0;0
PALERMO;PA;E541;LERCARA FRIDDI;1;0;1;0
PALERMO;PA;E957;MARINEO;1;0;1;0
PALERMO;PA;F184;MEZZOJUSO;2;0;1;1
PALERMO;PA;F246;MISILMERI;1;0;1;0
PALERMO;PA;F377;MONREALE;2;0;1;1
PALERMO;PA;F544;MONTELEPRE;1;0;1;0
PALERMO;PA;F553;MONTEMAGGIORE BELSITO;2;0;1;1
PALERMO;PA;G263;PALAZZO ADRIANO;2;0;1;1
PALERMO;PA;G273;PALERMO;0;0;0;0
PALERMO;PA;G348;PARTINICO;1;0;1;0
PALERMO;PA;G510;PETRALIA SOPRANA;2;0;1;1
PALERMO;PA;G511;PETRALIA SOTTANA;2;0;1;1
PALERMO;PA;G543;PIANA DEGLI ALBANESI;2;0;1;1
PALERMO;PA;G792;POLIZZI GENEROSA;2;0;1;1
PALERMO;PA;G797;POLLINA;1;0;0;1
PALERMO;PA;H070;PRIZZI;2;0;1;1
PALERMO;PA;H422;ROCCAMENA;2;0;1;1
PALERMO;PA;H428;ROCCAPALUMBA;2;0;1;1
PALERMO;PA;H797;SAN CIPIRELLO;1;0;1;0
PALERMO;PA;H933;SAN GIUSEPPE JATO;1;0;1;0
PALERMO;PA;I028;SAN MAURO CASTELVERDE;2;0;1;1
PALERMO;PA;I174;SANTA CRISTINA GELA;2;0;1;1
PALERMO;PA;I188;SANTA FLAVIA;0;0;0;0
PALERMO;PA;I534;SCIARA;2;0;1;1
PALERMO;PA;I538;SCILLATO;2;0;1;1
PALERMO;PA;I541;SCLAFANI BAGNI;2;0;1;1
PALERMO;PA;L112;TERMINI IMERESE;1;0;1;0
PALERMO;PA;L131;TERRASINI;0;0;0;0
PALERMO;PA;L282;TORRETTA;1;0;1;0
PALERMO;PA;L317;TRABIA;0;0;0;0
PALERMO;PA;L332;TRAPPETO;0;0;0;0
PALERMO;PA;L519;USTICA;1;1;0;0
PALERMO;PA;L603;VALLEDOLMO;2;0;1;1
PALERMO;PA;L740;VENTIMIGLIA DI SICILIA;2;0;1;1
PALERMO;PA;L837;VICARI;2;0;1;1
PALERMO;PA;L916;VILLABATE;1;0;1;0
PALERMO;PA;L951;VILLAFRATI;2;0;1;1
MESSINA;ME;M211;ACQUEDOLCI;0;0;0;0
MESSINA;ME;A177;ALCARA LI FUSI;2;0;1;1
MESSINA;ME;A194;ALI';2;0;1;1
MESSINA;ME;A201;ALI' TERME;0;0;0;0
MESSINA;ME;A313;ANTILLO;2;0;1;1
MESSINA;ME;A638;BARCELLONA POZZO DI GOTTO;1;0;1;0
MESSINA;ME;A698;BASICO';2;0;1;1
MESSINA;ME;B198;BROLO;0;0;0;0
MESSINA;ME;B660;CAPIZZI;2;0;1;1
MESSINA;ME;B666;CAPO D'ORLANDO;0;0;0;0
MESSINA;ME;B695;CAPRI LEONE;0;0;0;0
MESSINA;ME;B804;CARONIA;2;0;1;1
MESSINA;ME;B918;CASALVECCHIO SICULO;2;0;1;1
MESSINA;ME;C094;CASTEL DI LUCIO;2;0;1;1
MESSINA;ME;C051;CASTELL'UMBERTO;1;0;1;0
MESSINA;ME;C210;CASTELMOLA;1;0;0;1
MESSINA;ME;C347;CASTROREALE;2;0;1;1
MESSINA;ME;C568;CESARO';2;0;1;1
MESSINA;ME;C956;CONDRO';2;0;1;1
MESSINA;ME;D474;FALCONE;0;0;0;0
MESSINA;ME;D569;FICARRA;2;0;1;1
MESSINA;ME;D622;FIUMEDINISI;2;0;1;1
MESSINA;ME;D635;FLORESTA;2;0;1;1
MESSINA;ME;D661;FONDACHELLI-FANTINA;2;0;1;1
MESSINA;ME;D733;FORZA D'AGRO';1;0;0;1
MESSINA;ME;D765;FRANCAVILLA DI SICILIA;2;0;1;1
MESSINA;ME;D793;FRAZZANO';2;0;1;1
MESSINA;ME;D824;FURCI SICULO;0;0;0;0
MESSINA;ME;D825;FURNARI;0;0;0;0
MESSINA;ME;D844;GAGGI;0;0;0;0
MESSINA;ME;D861;GALATI MAMERTINO;2;0;1;1
MESSINA;ME;D885;GALLODORO;2;0;1;1
MESSINA;ME;E014;GIARDINI-NAXOS;0;0;0;0
MESSINA;ME;E043;GIOIOSA MAREA;0;0;0;0
MESSINA;ME;E142;GRANITI;1;0;0;1
MESSINA;ME;E233;GUALTIERI SICAMINO';2;0;1;1
MESSINA;ME;E374;ITALA;2;0;1;1
MESSINA;ME;E523;LENI;2;1;0;1
MESSINA;ME;E555;LETOJANNI;0;0;0;0
MESSINA;ME;E571;LIBRIZZI;2;0;1;1
MESSINA;ME;E594;LIMINA;2;0;1;1
MESSINA;ME;E606;LIPARI;2;1;0;1
MESSINA;ME;E674;LONGI;2;0;1;1
MESSINA;ME;E855;MALFA;2;1;0;1
MESSINA;ME;E869;MALVAGNA;2;0;1;1
MESSINA;ME;E876;MANDANICI;2;0;1;1
MESSINA;ME;F066;MAZZARRA' SANT'ANDREA;1;0;1;0
MESSINA;ME;F147;MERI';1;0;1;0
MESSINA;ME;F158;MESSINA;0;0;0;0
MESSINA;ME;F206;MILAZZO;0;0;0;0
MESSINA;ME;F210;MILITELLO ROSMARINO;2;0;1;1
MESSINA;ME;F242;MIRTO;2;0;1;1
MESSINA;ME;F251;MISTRETTA;2;0;1;1
MESSINA;ME;F277;MOIO ALCANTARA;2;0;1;1
MESSINA;ME;F359;MONFORTE SAN GIORGIO;2;0;1;1
MESSINA;ME;F368;MONGIUFFI MELIA;2;0;1;1
MESSINA;ME;F395;MONTAGNAREALE;2;0;1;1
MESSINA;ME;F400;MONTALBANO ELICONA;2;0;1;1
MESSINA;ME;F772;MOTTA CAMASTRA;2;0;1;1
MESSINA;ME;F773;MOTTA D'AFFERMO;2;0;1;1
MESSINA;ME;F848;NASO;2;0;1;1
MESSINA;ME;F901;NIZZA DI SICILIA;1;0;1;0
MESSINA;ME;F951;NOVARA DI SICILIA;2;0;1;1
MESSINA;ME;G036;OLIVERI;0;0;0;0
MESSINA;ME;G209;PACE DEL MELA;1;0;1;0
MESSINA;ME;G234;PAGLIARA;2;0;1;1
MESSINA;ME;G377;PATTI;0;0;0;0
MESSINA;ME;G522;PETTINEO;2;0;1;1
MESSINA;ME;G699;PIRAINO;0;0;0;0
MESSINA;ME;H151;RACCUJA;2;0;1;1
MESSINA;ME;H228;REITANO;2;0;1;1
MESSINA;ME;H405;ROCCAFIORITA;2;0;1;1
MESSINA;ME;H433;ROCCALUMERA;0;0;0;0
MESSINA;ME;H458;ROCCELLA VALDEMONE;2;0;1;1
MESSINA;ME;H677;ROD√å MILICI;2;0;1;1
MESSINA;ME;H750;ROMETTA;1;0;1;0
MESSINA;ME;I080;SAN FILIPPO DEL MELA;1;0;1;0
MESSINA;ME;I138;SAN FRATELLO;2;0;1;1
MESSINA;ME;I210;SAN MARCO D'ALUNZIO;2;0;1;1
MESSINA;ME;I248;SAN PIER NICETO;2;0;1;1
MESSINA;ME;I281;SAN PIERO PATTI;2;0;1;1
MESSINA;ME;I298;SAN SALVATORE DI FITALIA;2;0;1;1
MESSINA;ME;I345;SANT'AGATA DI MILITELLO;0;0;0;0
MESSINA;ME;I184;SANTA DOMENICA VITTORIA;2;0;1;1
MESSINA;ME;I217;SANT'ALESSIO SICULO;0;0;0;0
MESSINA;ME;I270;SANTA LUCIA DEL MELA;1;0;1;0
MESSINA;ME;I291;SANTA MARINA SALINA;2;1;0;1
MESSINA;ME;I332;SANTA TERESA DI RIVA;0;0;0;0
MESSINA;ME;I330;SANT'ANGELO DI BROLO;2;0;1;1
MESSINA;ME;I396;SAN TEODORO;2;0;1;1
MESSINA;ME;I678;SAVOCA;2;0;1;1
MESSINA;ME;I718;SCALETTA ZANCLEA;0;0;0;0
MESSINA;ME;I883;SINAGRA;2;0;1;1
MESSINA;ME;L010;SPADAFORA;1;0;1;0
MESSINA;ME;L186;TAORMINA;0;0;0;0
MESSINA;ME;L367;TERME VIGLIATORE;0;0;0;0
MESSINA;ME;L447;TORREGROTTA;1;0;1;0
MESSINA;ME;L466;TORRENOVA;1;0;1;0
MESSINA;ME;L493;TORTORICI;2;0;1;1
MESSINA;ME;L569;TRIPI;2;0;1;1
MESSINA;ME;L578;TUSA;2;0;1;1
MESSINA;ME;L582;UCRIA;2;0;1;1
MESSINA;ME;L783;VALDINA;1;0;1;0
MESSINA;ME;L997;VENETICO;1;0;1;0
MESSINA;ME;M035;VILLAFRANCA TIRRENA;1;0;1;0
AGRIGENTO;AG;A061;AGRIGENTO;0;0;0;0
AGRIGENTO;AG;A176;ALESSANDRIA DELLA ROCCA;2;0;1;1
AGRIGENTO;AG;A351;ARAGONA;2;0;1;1
AGRIGENTO;AG;A896;BIVONA;2;0;1;1
AGRIGENTO;AG;B275;BURGIO;2;0;1;1
AGRIGENTO;AG;B377;CALAMONACI;2;0;1;1
AGRIGENTO;AG;B427;CALTABELLOTTA;2;0;1;1
AGRIGENTO;AG;B460;CAMASTRA;2;0;1;1
AGRIGENTO;AG;B486;CAMMARATA;2;0;1;1
AGRIGENTO;AG;B520;CAMPOBELLO DI LICATA;2;0;1;1
AGRIGENTO;AG;B602;CANICATTI';1;0;1;0
AGRIGENTO;AG;C275;CASTELTERMINI;2;0;1;1
AGRIGENTO;AG;C341;CASTROFILIPPO;2;0;1;1
AGRIGENTO;AG;C356;CATTOLICA ERACLEA;2;0;1;1
AGRIGENTO;AG;C668;CIANCIANA;2;0;1;1
AGRIGENTO;AG;C928;COMITINI;2;0;1;1
AGRIGENTO;AG;D514;FAVARA;1;0;1;0
AGRIGENTO;AG;E209;GROTTE;1;0;1;0
AGRIGENTO;AG;E390;JOPPOLO GIANCAXIO;2;0;1;1
AGRIGENTO;AG;E431;LAMPEDUSA E LINOSA;1;1;0;0
AGRIGENTO;AG;E573;LICATA;1;0;1;0
AGRIGENTO;AG;E714;LUCCA SICULA;2;0;1;1
AGRIGENTO;AG;F126;MENFI;1;0;0;1
AGRIGENTO;AG;F414;MONTALLEGRO;2;0;1;1
AGRIGENTO;AG;F655;MONTEVAGO;2;0;1;1
AGRIGENTO;AG;F845;NARO;2;0;1;1
AGRIGENTO;AG;G282;PALMA DI MONTECHIARO;1;0;1;0
AGRIGENTO;AG;F299;PORTO EMPEDOCLE;0;0;0;0
AGRIGENTO;AG;H148;RACALMUTO;2;0;1;1
AGRIGENTO;AG;H159;RAFFADALI;1;0;1;0
AGRIGENTO;AG;H194;RAVANUSA;1;0;1;0
AGRIGENTO;AG;H205;REALMONTE;0;0;0;0
AGRIGENTO;AG;H269;RIBERA;2;0;1;1
AGRIGENTO;AG;H743;SAMBUCA DI SICILIA;2;0;1;1
AGRIGENTO;AG;H778;SAN BIAGIO PLATANI;2;0;1;1
AGRIGENTO;AG;H914;SAN GIOVANNI GEMINI;1;0;1;0
AGRIGENTO;AG;I185;SANTA ELISABETTA;2;0;1;1
AGRIGENTO;AG;I224;SANTA MARGHERITA DI BELICE;2;0;1;1
AGRIGENTO;AG;I290;SANT'ANGELO MUXARO;2;0;1;1
AGRIGENTO;AG;I356;SANTO STEFANO QUISQUINA;2;0;1;1
AGRIGENTO;AG;I533;SCIACCA;0;0;0;0
AGRIGENTO;AG;I723;SICULIANA;1;0;0;1
AGRIGENTO;AG;L944;VILLAFRANCA SICULA;2;0;1;1
RAGUSA;RG;A014;ACATE;2;0;1;1
RAGUSA;RG;C612;CHIARAMONTE GULFI;2;0;1;1
RAGUSA;RG;C927;COMISO;1;0;1;0
RAGUSA;RG;E016;GIARRATANA;2;0;1;1
RAGUSA;RG;E366;ISPICA;1;0;0;1
RAGUSA;RG;F258;MODICA;0;0;0;0
RAGUSA;RG;F610;MONTEROSSO ALMO;2;0;1;1
RAGUSA;RG;G953;POZZALLO;0;0;0;0
RAGUSA;RG;H163;RAGUSA;0;0;0;0
RAGUSA;RG;I178;SANTA CROCE CAMERINA;0;0;0;0
RAGUSA;RG;I535;SCICLI;0;0;0;0
RAGUSA;RG;M088;VITTORIA;1;0;1;0`;

        let localizzazioneData = [];
        let risultati = {};

        

function validaPercentuali() {
    const perc0 = parseFloat(document.getElementById('percAnno0').value) || 0;
    const perc1 = parseFloat(document.getElementById('percAnno1').value) || 0;
    const perc2 = parseFloat(document.getElementById('percAnno2').value) || 0;
    const somma = perc0 + perc1 + perc2;
    
    // Aggiorna il valore della somma
    const sommaPercEl = document.getElementById('sommaPerc');
    if (sommaPercEl) {
        sommaPercEl.textContent = somma.toFixed(1);
    }
    
    // Gestisci alert e stile input
    const alertWarning = document.getElementById('alertPercentuali');
    const alertOk = document.getElementById('alertPercentualiOk');
    const inputs = [
        document.getElementById('percAnno0'),
        document.getElementById('percAnno1'),
        document.getElementById('percAnno2')
    ];
    
    if (Math.abs(somma - 100) < 0.01) {
        // SOMMA CORRETTA = 100%
        if (alertWarning) alertWarning.style.display = 'none';
        if (alertOk) alertOk.style.display = 'block';
        
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '#4caf50';
                input.style.background = '#f1f8f4';
            }
        });
    } else {
        // SOMMA ERRATA ‚â† 100%
        if (alertWarning) alertWarning.style.display = 'block';
        if (alertOk) alertOk.style.display = 'none';
        
        inputs.forEach(input => {
            if (input) {
                input.style.borderColor = '#ff6b6b';
                input.style.background = '#fff5f5';
            }
        });
    }
    
    // AGGIORNA DISPLAY VISUALE
    const display0 = document.getElementById('display_perc_0');
    const display1 = document.getElementById('display_perc_1');
    const display2 = document.getElementById('display_perc_2');
    
    if (display0) display0.textContent = perc0.toFixed(0) + '%';
    if (display1) display1.textContent = perc1.toFixed(0) + '%';
    if (display2) display2.textContent = perc2.toFixed(0) + '%';
    
    // AGGIORNA BARRA PROGRESSIVA
    const barra0 = document.getElementById('barra_perc_0');
    const barra1 = document.getElementById('barra_perc_1');
    const barra2 = document.getElementById('barra_perc_2');
    
    if (barra0) {
        barra0.style.width = perc0 + '%';
        barra0.textContent = perc0 > 0 ? perc0.toFixed(0) + '%' : '';
    }
    if (barra1) {
        barra1.style.width = perc1 + '%';
        barra1.textContent = perc1 > 0 ? perc1.toFixed(0) + '%' : '';
    }
    if (barra2) {
        barra2.style.width = perc2 + '%';
        barra2.textContent = perc2 > 0 ? perc2.toFixed(0) + '%' : '';
    }
    
    // Ricalcola tempistica se esiste
    if (typeof calcolaTotaliTempistica === 'function') {
        calcolaTotaliTempistica();
    }
    
    return Math.abs(somma - 100) < 0.01;
}

// ========== PARSING CSV COMUNI ==========
        function parseComuniCsv() {
            const lines = comuniCsv.split(/\r?\n/).filter(l => l.trim() !== '');
            lines.shift();
            localizzazioneData = lines.map(line => {
                const cols = line.split(';');
                return {
                    provincia: cols[0].trim(),
                    sigla: cols[1].trim(),
                    codice: cols[2].trim(),
                    comune: cols[3].trim(),
                    punteggio: parseInt(cols[4].trim(), 10) || 0,
                    isola: parseInt(cols[5].trim(), 10) === 1,
                    ricettivita: parseInt(cols[6].trim(), 10) === 1,
                    area_rurale: parseInt(cols[7].trim(), 10) === 1
                };
            });
        }

        function populateComuneSelect() {
            const sel = document.getElementById('comuneSelect');
            sel.options.length = 1;
            const sorted = localizzazioneData.slice().sort((a,b) => a.comune.localeCompare(b.comune, 'it'));
            for (const entry of sorted) {
                const opt = document.createElement('option');
                opt.value = entry.codice;
                opt.text = `${entry.comune} (${entry.sigla})`;
                sel.appendChild(opt);
            }
        }

        function lookupLocalizzazioneByCode(codice) {
            return localizzazioneData.find(e => e.codice === codice) || null;
        }

        function computeFPointsFromEntry(entry) {
            if (!entry) return { points: 0, detail: 'Comune non trovato' };
            const flags = [entry.isola, entry.ricettivita, entry.area_rurale];
            const count = flags.filter(Boolean).length;
            let points = count >= 2 ? 8 : (count === 1 ? 4 : 0);
            const areas = [];
            if (entry.isola) areas.push('Isola minore');
            if (entry.ricettivita) areas.push('Ricettivit√† turistica');
            if (entry.area_rurale) areas.push('Area rurale');
            const detail = areas.length ? areas.join(', ') : 'Nessuna area speciale';
            return { points, detail };
        }

        function applyLocalizzazioneLookup() {
            const sel = document.getElementById('comuneSelect');
            const codice = sel.value;
            const entry = lookupLocalizzazioneByCode(codice);
            const res = computeFPointsFromEntry(entry);
            document.getElementById('comuneLookupResult').value = entry ? `${res.detail} ‚Äî Punteggio: ${entry.punteggio}` : 'Non presente';
            const override = document.getElementById('overrideF').checked;
            if (!override) document.getElementById('griglia_f').value = res.points;
         }

        function toggleOverrideF() {
            const cb = document.getElementById('overrideF');
            document.getElementById('griglia_f').readOnly = !cb.checked;
            if (!cb.checked) applyLocalizzazioneLookup();
        }

        function aggiornaQualitaProgettuale() {
            const selected = document.querySelector('input[name="qualita_prog"]:checked');
            const punti = selected ? parseInt(selected.value) : 0;
            document.getElementById('punteggio_d_display').textContent = punti;
            document.getElementById('griglia_d').value = punti;
            if (typeof calcolaPunteggio === 'function') calcolaPunteggio();
        }

        function aggiornaSostenibilitaAmbientale() {
            const checkboxes = document.querySelectorAll('input[name="sostenibilita"]:checked');
            let totale = 0;
            checkboxes.forEach(cb => { totale += parseInt(cb.value); });
            if (totale > 10) {
                document.getElementById('punteggio_e_warning').textContent = ' (max 10, limitato)';
                totale = 10;
            } else {
                document.getElementById('punteggio_e_warning').textContent = '';
            }
            document.getElementById('punteggio_e_display').textContent = totale;
            document.getElementById('griglia_e').value = totale;
            if (typeof calcolaPunteggio === 'function') calcolaPunteggio();
        }

        function validaContributo() {
            const regime = document.getElementById('regimeAiuto').value;
            const contributo = parseFloat(document.getElementById('contributoRichiesto').value) || 0;
            const investimento = parseFloat(document.getElementById('investimentoTotale').value) || 0;
            let maxContributo = regime === 'esenzione' ? 3500000 : 300000;
            const contributoInput = document.getElementById('contributoRichiesto');
            if (contributo < 50000 || contributo > maxContributo) {
                contributoInput.style.borderColor = '#ff6b6b';
                contributoInput.style.background = '#fff5f5';
            } else {
                contributoInput.style.borderColor = '#4caf50';
                contributoInput.style.background = 'white';
            }
        }

        function showTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach((tab, i) => { 
                tab.classList.toggle('active', i === index); 
                contents[i].classList.toggle('active', i === index); 
            });
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function updateFormVisibility() {
            const stato = document.getElementById('impresaStato').value;
            document.getElementById('datiConfronto').style.display = stato === 'attiva' ? 'block' : 'none';
        }

function calcolaOccupazione() {
    console.log('üè® Calcolo occupazione camere...');
    
    // ========== LEGGI DATI BASE ==========
    const numCamere = parseInt(document.getElementById('numCamere')?.value) || 0;
    const giorniApertura = parseInt(document.getElementById('giorniApertura')?.value) || 365;
    
    console.log(`Camere disponibili: ${numCamere}`);
    console.log(`Giorni apertura annui: ${giorniApertura}`);
    
    // Aggiorna box info
    const infoCamere = document.getElementById('info_camere_disponibili');
    const infoGiorni = document.getElementById('info_giorni_apertura');
    const infoCapacita = document.getElementById('info_capacita_totale');
    
    if (infoCamere) infoCamere.textContent = numCamere;
    if (infoGiorni) infoGiorni.textContent = giorniApertura;
    if (infoCapacita) infoCapacita.textContent = (numCamere * giorniApertura).toLocaleString('it-IT');
    
    // ========== LEGGI DATI STAGIONI ==========
    const stagioni = ['Alta', 'Media', 'Bassa'];
    
    let totaleGiorni = 0;
    let totaleCamereVendute = 0;
    let totaleCapacita = 0;
    
    stagioni.forEach(stagione => {
        const giorniInput = document.getElementById(`giorni${stagione}`);
        const camereInput = document.getElementById(`camere${stagione}`);
        
        const giorni = parseInt(giorniInput?.value) || 0;
        const camereVendute = parseInt(camereInput?.value) || 0;
        
        // Calcola capacit√† periodo (camere √ó giorni)
        const capacitaPeriodo = numCamere * giorni;
        
        // Calcola % occupazione
        const percOccupazione = capacitaPeriodo > 0 ? (camereVendute / capacitaPeriodo * 100) : 0;
        
        console.log(`${stagione} Stagione:`);
        console.log(`  Giorni: ${giorni}`);
        console.log(`  Camere vendute: ${camereVendute}`);
        console.log(`  Capacit√† periodo: ${capacitaPeriodo}`);
        console.log(`  % Occupazione: ${percOccupazione.toFixed(2)}%`);
        
        // Aggiorna UI
        const capacitaCell = document.getElementById(`capacita${stagione}`);
        const occCell = document.getElementById(`occ${stagione}`);
        const row = document.getElementById(`row_${stagione.toLowerCase()}`);
        
        if (capacitaCell) {
            capacitaCell.textContent = capacitaPeriodo.toLocaleString('it-IT');
        }
        
        if (occCell) {
            occCell.textContent = percOccupazione.toFixed(1) + '%';
            
            // Colora in base alla % occupazione
            if (percOccupazione >= 70) {
                occCell.style.background = '#c8e6c9';
                occCell.style.color = '#2e7d32';
            } else if (percOccupazione >= 50) {
                occCell.style.background = '#fff3e0';
                occCell.style.color = '#ef6c00';
            } else if (percOccupazione > 0) {
                occCell.style.background = '#ffebee';
                occCell.style.color = '#c62828';
            } else {
                occCell.style.background = '#f5f5f5';
                occCell.style.color = '#999';
            }
        }
        
        // Accumula totali
        totaleGiorni += giorni;
        totaleCamereVendute += camereVendute;
        totaleCapacita += capacitaPeriodo;
    });
    
    // ========== CALCOLA OCCUPAZIONE MEDIA ANNUA ==========
    const occMediaAnnua = totaleCapacita > 0 ? (totaleCamereVendute / totaleCapacita * 100) : 0;
    
    console.log('Totali:');
    console.log(`  Giorni: ${totaleGiorni}`);
    console.log(`  Camere vendute: ${totaleCamereVendute}`);
    console.log(`  Capacit√† totale: ${totaleCapacita}`);
    console.log(`  % Occupazione media: ${occMediaAnnua.toFixed(2)}%`);
    
    // ========== AGGIORNA RIGA TOTALI ==========
    const giorniTotaliCell = document.getElementById('giorniTotali');
    const camereTotaliCell = document.getElementById('camereTotali');
    const capacitaTotaleCell = document.getElementById('capacitaTotale');
    const occMediaTotaleCell = document.getElementById('occMediaTotale');
    
    if (giorniTotaliCell) giorniTotaliCell.textContent = totaleGiorni;
    if (camereTotaliCell) camereTotaliCell.textContent = totaleCamereVendute.toLocaleString('it-IT');
    if (capacitaTotaleCell) capacitaTotaleCell.textContent = totaleCapacita.toLocaleString('it-IT');
    if (occMediaTotaleCell) {
        occMediaTotaleCell.textContent = occMediaAnnua.toFixed(1) + '%';
    }
    
    // ========== VALIDAZIONE GIORNI STAGIONI ==========
    const alertGiorni = document.getElementById('alert_giorni_stagioni');
    const alertGiorniOk = document.getElementById('alert_giorni_ok');
    const alertGiorniMsg = document.getElementById('alert_giorni_msg');
    
    if (totaleGiorni !== giorniApertura) {
        if (alertGiorni && alertGiorniMsg) {
            alertGiorni.style.display = 'block';
            if (alertGiorniOk) alertGiorniOk.style.display = 'none';
            
            alertGiorniMsg.innerHTML = 
                `La somma dei giorni delle stagioni (${totaleGiorni}) non corrisponde ai giorni di apertura annui (${giorniApertura}). ` +
                `Differenza: <strong>${Math.abs(totaleGiorni - giorniApertura)} giorni</strong>`;
        }
        
        // Colora riga totali in giallo
        if (giorniTotaliCell) {
            giorniTotaliCell.style.background = '#fff3cd';
            giorniTotaliCell.style.color = '#856404';
        }
    } else {
        if (alertGiorni) alertGiorni.style.display = 'none';
        if (alertGiorniOk) alertGiorniOk.style.display = 'block';
        
        // Colora riga totali in verde
        if (giorniTotaliCell) {
            giorniTotaliCell.style.background = '#d4edda';
            giorniTotaliCell.style.color = '#155724';
        }
    }
    
    console.log('‚úÖ Calcolo occupazione completato');
    
    // ========== RETURN PER calcolaFatturatoTotale() ==========
    return {
        camereTotali: totaleCamereVendute,
        camereAlta: parseInt(document.getElementById('camereAlta')?.value) || 0,
        camereMedia: parseInt(document.getElementById('camereMedia')?.value) || 0,
        camereBassa: parseInt(document.getElementById('camereBassa')?.value) || 0,
        occAlta: parseFloat(document.getElementById('occAlta')?.textContent) || 0,
        occMedia: parseFloat(document.getElementById('occMedia')?.textContent) || 0,
        occBassa: parseFloat(document.getElementById('occBassa')?.textContent) || 0,
        occMediaAnnua: occMediaAnnua,
        capacitaTotale: totaleCapacita
    };
}

        function calcolaFatturatoTotale() {
            const occ = calcolaOccupazione();
            const adr = parseFloat(document.getElementById('adr').value) || 0;
            const fattCamere = occ.camereTotali * adr;
            const fattRist = parseFloat(document.getElementById('fattRistorazione').value) || 0;
            const altriRic = parseFloat(document.getElementById('altriRicavi').value) || 0;
            const totale = fattCamere + fattRist + altriRic;
            document.getElementById('fatturatoTotale').value = '‚Ç¨ ' + totale.toLocaleString('it-IT', {minimumFractionDigits: 2});
            return {fattCamere, fattRist, altriRic, totale};
        }

        // ========== CALCOLO INDICI PRINCIPALE ==========
        function calcola() {
            // LEGGE DATI DAL QUADRO L (anno 202x+2)
            const fatturatoTotale = (parseFloat(document.getElementById('l_fatt_2').value) || 0) * 1000;
            const altriRicavi = (parseFloat(document.getElementById('l_altri_ric_2').value) || 0) * 1000;
            const valoreProduzione = (parseFloat(document.getElementById('l_val_prod_2').textContent) || 0) * 1000;
            const risultatoOperativo = (parseFloat(document.getElementById('l_ris_op_2').textContent) || 0) * 1000;
            const ebitda = (parseFloat(document.getElementById('l_ebitda_2').textContent) || 0) * 1000;
            const mol = (parseFloat(document.getElementById('l_mol_2').textContent) || 0) * 1000;
            const risultatoNetto = (parseFloat(document.getElementById('l_ris_netto_2').textContent) || 0) * 1000;
            
            // Legge TOTALE ATTIVO dallo Stato Patrimoniale (anno 202x+2)
            const totaleAttivo = (parseFloat(document.getElementById('sp_totale_att_2').textContent) || 0) * 1000;
            
            // LEGGE DATI DA TAB 1
            const statoImpresa = document.getElementById('impresaStato').value;
            const numCamere = parseFloat(document.getElementById('numCamere').value) || 0;
            const giorniApertura = parseFloat(document.getElementById('giorniApertura').value) || 0;
            const camereDisponibili = numCamere * giorniApertura;
            const dipendentiAttuali = parseFloat(document.getElementById('dipendentiAttuali').value) || 0;
            const dipendentiPrevisti = parseFloat(document.getElementById('dipendentiPrevisti').value) || 0;
            const nuoviDipendenti = dipendentiPrevisti - dipendentiAttuali;
            const investimentoTotale = parseFloat(document.getElementById('investimentoTotale').value) || 0;
            const investimentiOperativi = parseFloat(document.getElementById('investimentiOperativi').value) || 0;
            const investimentiImmobiliari = parseFloat(document.getElementById('investimentiImmobiliari').value) || 0;
            
            // CALCOLO OCCUPAZIONE
            const occ = calcolaOccupazione();
            const camereVendute = occ.camereTotali;
            const tor = camereDisponibili > 0 ? (camereVendute / camereDisponibili) * 100 : 0;
            
            // CALCOLO FATTURATO CAMERE
            const adr = parseFloat(document.getElementById('adr').value) || 0;
            const fattCamere = camereVendute * adr;
            
            // LEGGE COSTI DA TAB 2
            const costiMaterie = parseFloat(document.getElementById('costiMaterie').value) || 0;
            const costoPersonale = parseFloat(document.getElementById('costoPersonale').value) || 0;
            const costiServizi = parseFloat(document.getElementById('costiServizi').value) || 0;
            const costiBeni = parseFloat(document.getElementById('costiBeni').value) || 0;
            const costiMarketing = parseFloat(document.getElementById('costiMarketing').value) || 0;
            const speseGenerali = parseFloat(document.getElementById('speseGenerali').value) || 0;
            const costiOperativi = costiMaterie + costoPersonale + costiServizi + costiBeni + costiMarketing + speseGenerali;
            
            const ammImmateriali = parseFloat(document.getElementById('ammImmateriali').value) || 0;
            const ammMateriali = parseFloat(document.getElementById('ammMateriali').value) || 0;
            const ammortamentiTot = ammImmateriali + ammMateriali;
            
            const oneriFin = parseFloat(document.getElementById('oneriFin').value) || 0;
            const imposte = parseFloat(document.getElementById('imposte').value) || 0;
            
            // CALCOLO INDICI CORRETTI
            // ROS = EBIT / Fatturato
            const ros = fatturatoTotale > 0 ? (risultatoOperativo / fatturatoTotale) * 100 : 0;
            
            // ROI = EBIT / Totale Attivo
            const roi = totaleAttivo > 0 ? (risultatoOperativo / totaleAttivo) * 100 : 0;
            
           // EBITDA Margin = EBITDA / Fatturato (come da bando)
            const ebitdaMargin = fatturatoTotale > 0 ? (ebitda / fatturatoTotale) * 100 : 0;
            // ARROTONDA GLI INDICI PER IL CALCOLO DEL PUNTEGGIO
            const rosArrotondato = Math.round(ros);
            const roiArrotondato = Math.round(roi);
            const ebitdaMarginArrotondato = Math.round(ebitdaMargin);
            const torArrotondato = Math.round(tor);
            
            // INDICI OPERATIVI
            const revpar = camereDisponibili > 0 ? fattCamere / camereDisponibili : 0;
            const goppar = camereDisponibili > 0 ? mol / camereDisponibili : 0;
            const laborCost = fatturatoTotale > 0 ? (costoPersonale / fatturatoTotale) * 100 : 0;
            const produttivita = dipendentiPrevisti > 0 ? fatturatoTotale / dipendentiPrevisti : 0;
            const invPerOccupazione = nuoviDipendenti > 0 ? investimentoTotale / nuoviDipendenti : (dipendentiPrevisti > 0 ? investimentoTotale / dipendentiPrevisti : 0);
            const rapportoInvOperativo = investimentoTotale > 0 ? investimentiOperativi / investimentoTotale : 0;
            
            // SALVA RISULTATI (usa valori arrotondati)
            risultati = {
            statoImpresa, numCamere, camereDisponibili, camereVendute, dipendentiAttuali, dipendentiPrevisti, nuoviDipendenti,
            investimentoTotale, investimentiOperativi, investimentiImmobiliari, fatturatoTotale, fattCamere, costiOperativi, mol, ebitda,
            ammortamentiTot, risultatoOperativo, oneriFin, imposte, risultatoNetto, 
            ros: rosArrotondato,  // USA VALORE ARROTONDATO
            roi: roiArrotondato,  // USA VALORE ARROTONDATO
            ebitdaMargin: ebitdaMarginArrotondato,  // USA VALORE ARROTONDATO
            tor: torArrotondato,  // USA VALORE ARROTONDATO
            revpar, adr, goppar,
            laborCost: Math.round(laborCost),  // ARROTONDA ANCHE QUESTO
            produttivita, invPerOccupazione, rapportoInvOperativo, totaleAttivo
            };
            
            mostraRisultati();
            calcolaPunteggio();
            
            alert('‚úÖ Calcolo completato! Indici calcolati dal Quadro L.\n\nROS = EBIT / Fatturato = ' + ros.toFixed(2) + '%\nROI = EBIT / Totale Attivo = ' + roi.toFixed(2) + '%');
        }

        function mostraRisultati() {
            const r = risultati;
            
            function getStatus(value, thresholds) {
                let className = 'status-poor', text = 'Migliorabile';
                if (value >= thresholds.excellent) { className = 'status-excellent'; text = 'Eccellente'; }
                else if (value >= thresholds.good) { className = 'status-good'; text = 'Buono'; }
                else if (value >= thresholds.sufficient) { className = 'status-warning'; text = 'Sufficiente'; }
                return {className, text};
            }
            
            // ROS
            document.getElementById('rosValue').textContent = (r.ros||0).toFixed(2) + '%';
            const rosStatus = getStatus(r.ros || 0, {excellent:20, good:15, sufficient:10});
            document.getElementById('rosStatus').textContent = rosStatus.text;
            document.getElementById('rosStatus').className = 'result-status ' + rosStatus.className;
            
            // ROI
            document.getElementById('roiValue').textContent = (r.roi||0).toFixed(2) + '%';
            const roiStatus = getStatus(r.roi || 0, {excellent:15, good:10, sufficient:5});
            document.getElementById('roiStatus').textContent = roiStatus.text;
            document.getElementById('roiStatus').className = 'result-status ' + roiStatus.className;
            
            // EBITDA
            document.getElementById('ebitdaValue').textContent = (r.ebitdaMargin||0).toFixed(2) + '%';
            const ebitdaStatus = getStatus(r.ebitdaMargin || 0, {excellent:30, good:20, sufficient:15});
            document.getElementById('ebitdaStatus').textContent = ebitdaStatus.text;
            document.getElementById('ebitdaStatus').className = 'result-status ' + ebitdaStatus.className;
            
            // MOL
            document.getElementById('molValue').textContent = '‚Ç¨' + (r.mol||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            
            // TOR
            document.getElementById('torValue').textContent = (r.tor||0).toFixed(2) + '%';
            const torStatus = getStatus(r.tor || 0, {excellent:70, good:60, sufficient:50});
            document.getElementById('torStatus').textContent = torStatus.text;
            document.getElementById('torStatus').className = 'result-status ' + torStatus.className;
            
            // ALTRI INDICI
            document.getElementById('revparValue').textContent = '‚Ç¨' + (r.revpar||0).toFixed(2);
            document.getElementById('adrResultValue').textContent = '‚Ç¨' + (r.adr||0).toFixed(2);
            document.getElementById('gopparValue').textContent = '‚Ç¨' + (r.goppar||0).toFixed(2);
            
            document.getElementById('laborValue').textContent = (r.laborCost||0).toFixed(2) + '%';
            document.getElementById('laborStatus').textContent = r.laborCost <= 35 ? 'Ottimo' : (r.laborCost <= 45 ? 'Buono' : 'Alto');
            document.getElementById('laborStatus').className = 'result-status ' + (r.laborCost <= 35 ? 'status-excellent' : (r.laborCost <= 45 ? 'status-good' : 'status-warning'));
            
            document.getElementById('prodValue').textContent = '‚Ç¨' + (r.produttivita||0).toLocaleString('it-IT', {minimumFractionDigits: 0});
            document.getElementById('prodStatus').textContent = r.produttivita >= 80000 ? 'Eccellente' : (r.produttivita >= 60000 ? 'Buono' : 'Sufficiente');
            
            document.getElementById('invOccValue').textContent = '‚Ç¨' + (r.invPerOccupazione||0).toLocaleString('it-IT', {minimumFractionDigits: 0});
            const soglia = r.statoImpresa === 'inattiva' ? 150000 : 350000;
            document.getElementById('invOccStatus').textContent = r.invPerOccupazione <= soglia ? 'Ottimo' : 'Alto';
            
            document.getElementById('satValue').textContent = (r.tor||0).toFixed(2) + '%';
            document.getElementById('satStatus').textContent = r.tor >= 70 ? 'Ottimo' : (r.tor >= 50 ? 'Buono' : 'Migliorabile');
            
            // RIEPILOGO
            document.getElementById('recap_fatt').textContent = '‚Ç¨' + (r.fatturatoTotale||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_costi').textContent = '‚Ç¨' + (r.costiOperativi||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_mol').textContent = '‚Ç¨' + (r.mol||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_amm').textContent = '‚Ç¨' + (r.ammortamentiTot||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_ebitda').textContent = '‚Ç¨' + (r.ebitda||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_risop').textContent = '‚Ç¨' + (r.risultatoOperativo||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_fin').textContent = '‚Ç¨' + (r.oneriFin||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_imp').textContent = '‚Ç¨' + (r.imposte||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
            document.getElementById('recap_netto').textContent = '‚Ç¨' + (r.risultatoNetto||0).toLocaleString('it-IT', {minimumFractionDigits: 2});
        }

        function mostraVariazioni(rosPrec, roiPrec, ebitdaPrec, rosRegime, roiRegime, ebitdaRegime, 
                         varRos, varRoi, varEbitda, puntiRos, puntiRoi, puntiEbitda) {
    
    // Mostra il box variazioni solo per imprese attive
    const boxVariazioni = document.getElementById('boxVariazioni');
    if (boxVariazioni) {
        boxVariazioni.style.display = 'block';
    }
    
    // ROS
    document.getElementById('var_ros_prec').textContent = rosPrec.toFixed(0) + '%';
    document.getElementById('var_ros_regime').textContent = rosRegime.toFixed(0) + '%';
    document.getElementById('var_ros_assoluta').textContent = (rosRegime - rosPrec > 0 ? '+' : '') + (rosRegime - rosPrec).toFixed(0) + '%';
    document.getElementById('var_ros_perc').textContent = (varRos > 0 ? '+' : '') + varRos.toFixed(1) + '%';
    document.getElementById('var_ros_punti').textContent = puntiRos + ' pt';
    
    // Colora la variazione
    const rosPercCell = document.getElementById('var_ros_perc');
    if (varRos > 10) {
        rosPercCell.style.color = '#155724';
        rosPercCell.style.background = '#d4edda';
        rosPercCell.style.padding = '2px 8px';
        rosPercCell.style.borderRadius = '4px';
    } else if (varRos >= 5) {
        rosPercCell.style.color = '#0c5460';
        rosPercCell.style.background = '#d1ecf1';
        rosPercCell.style.padding = '2px 8px';
        rosPercCell.style.borderRadius = '4px';
    } else if (varRos > 0) {
        rosPercCell.style.color = '#856404';
        rosPercCell.style.background = '#fff3cd';
        rosPercCell.style.padding = '2px 8px';
        rosPercCell.style.borderRadius = '4px';
    } else {
        rosPercCell.style.color = '#721c24';
        rosPercCell.style.background = '#f8d7da';
        rosPercCell.style.padding = '2px 8px';
        rosPercCell.style.borderRadius = '4px';
    }
    
    // ROI
    document.getElementById('var_roi_prec').textContent = roiPrec.toFixed(0) + '%';
    document.getElementById('var_roi_regime').textContent = roiRegime.toFixed(0) + '%';
    document.getElementById('var_roi_assoluta').textContent = (roiRegime - roiPrec > 0 ? '+' : '') + (roiRegime - roiPrec).toFixed(0) + '%';
    document.getElementById('var_roi_perc').textContent = (varRoi > 0 ? '+' : '') + varRoi.toFixed(1) + '%';
    document.getElementById('var_roi_punti').textContent = puntiRoi + ' pt';
    
    // Colora la variazione ROI
    const roiPercCell = document.getElementById('var_roi_perc');
    if (varRoi > 10) {
        roiPercCell.style.color = '#155724';
        roiPercCell.style.background = '#d4edda';
        roiPercCell.style.padding = '2px 8px';
        roiPercCell.style.borderRadius = '4px';
    } else if (varRoi >= 5) {
        roiPercCell.style.color = '#0c5460';
        roiPercCell.style.background = '#d1ecf1';
        roiPercCell.style.padding = '2px 8px';
        roiPercCell.style.borderRadius = '4px';
    } else if (varRoi > 0) {
        roiPercCell.style.color = '#856404';
        roiPercCell.style.background = '#fff3cd';
        roiPercCell.style.padding = '2px 8px';
        roiPercCell.style.borderRadius = '4px';
    } else {
        roiPercCell.style.color = '#721c24';
        roiPercCell.style.background = '#f8d7da';
        roiPercCell.style.padding = '2px 8px';
        roiPercCell.style.borderRadius = '4px';
    }
    
    // EBITDA
    document.getElementById('var_ebitda_prec').textContent = ebitdaPrec.toFixed(0) + '%';
    document.getElementById('var_ebitda_regime').textContent = ebitdaRegime.toFixed(0) + '%';
    document.getElementById('var_ebitda_assoluta').textContent = (ebitdaRegime - ebitdaPrec > 0 ? '+' : '') + (ebitdaRegime - ebitdaPrec).toFixed(0) + '%';
    document.getElementById('var_ebitda_perc').textContent = (varEbitda > 0 ? '+' : '') + varEbitda.toFixed(1) + '%';
    document.getElementById('var_ebitda_punti').textContent = puntiEbitda + ' pt';
    
    // Colora la variazione EBITDA
    const ebitdaPercCell = document.getElementById('var_ebitda_perc');
    if (varEbitda > 20) {
        ebitdaPercCell.style.color = '#155724';
        ebitdaPercCell.style.background = '#d4edda';
        ebitdaPercCell.style.padding = '2px 8px';
        ebitdaPercCell.style.borderRadius = '4px';
    } else if (varEbitda >= 8) {
        ebitdaPercCell.style.color = '#0c5460';
        ebitdaPercCell.style.background = '#d1ecf1';
        ebitdaPercCell.style.padding = '2px 8px';
        ebitdaPercCell.style.borderRadius = '4px';
    } else if (varEbitda > 0) {
        ebitdaPercCell.style.color = '#856404';
        ebitdaPercCell.style.background = '#fff3cd';
        ebitdaPercCell.style.padding = '2px 8px';
        ebitdaPercCell.style.borderRadius = '4px';
    } else {
        ebitdaPercCell.style.color = '#721c24';
        ebitdaPercCell.style.background = '#f8d7da';
        ebitdaPercCell.style.padding = '2px 8px';
        ebitdaPercCell.style.borderRadius = '4px';
    }
}
        // ========== QUADRO H ==========
       function popolaQuadroH() {
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üöÄ INIZIO popolaQuadroH() - VERSIONE CORRETTA');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    // ========== STEP 1: LEGGI INVESTIMENTI PROPOSTI (NON AMMESSI) ==========
    console.log('üìã STEP 1: Lettura investimenti proposti...');
    
    const voci = ['edile', 'impianti', 'macchinari', 'attrezzature', 'arredi', 'tecniche', 'consulenze', 'informatiche'];
    
    let totaleInvestimenti = 0;
    let totaleIva = 0;
    let investimentiPerVoce = {};
    let ivaPerVoce = {};
    let categoriaPerVoce = {};
    
    voci.forEach(voce => {
        // Legge INVESTIMENTO PROPOSTO (al netto IVA)
        const investimento = parseFloat(document.getElementById(`inv_${voce}_investimento`)?.value) || 0;
        const iva = parseFloat(document.getElementById(`inv_${voce}_iva`)?.value) || 0;
        
        // Determina categoria (MAT o IMM)
        let categoria = '';
        
        if (voce === 'edile' || voce === 'tecniche') {
            // Leggi dal SELECT
            const categoriaSelect = document.getElementById(`inv_${voce}_categoria`);
            categoria = categoriaSelect ? categoriaSelect.value : 'MAT';
        } else {
            // Categoria fissa
            if (voce === 'attrezzature') {
                categoria = 'MAT';
            } else if (voce === 'consulenze' || voce === 'informatiche') {
                categoria = 'IMM';
            }
        }
        
        investimentiPerVoce[voce] = investimento;
        ivaPerVoce[voce] = iva;
        categoriaPerVoce[voce] = categoria;
        
        totaleInvestimenti += investimento;
        totaleIva += iva;
        
        console.log(`  ${voce}:`);
        console.log(`    Investimento: ‚Ç¨${investimento.toLocaleString('it-IT')}`);
        console.log(`    IVA: ‚Ç¨${iva.toLocaleString('it-IT')}`);
        console.log(`    Categoria: ${categoria}`);
    });
    
    console.log(`Totale investimenti: ‚Ç¨${totaleInvestimenti.toLocaleString('it-IT')}`);
    console.log(`Totale IVA: ‚Ç¨${totaleIva.toLocaleString('it-IT')}`);
    
    if (totaleInvestimenti === 0) {
        console.error('‚ö†Ô∏è ATTENZIONE: Investimenti totali = 0!');
        alert('‚ö†Ô∏è Attenzione: Gli investimenti sono 0!\n\nCompila prima il "Dettaglio Investimenti".');
        return;
    }
    
    // ========== STEP 2: VALIDA PERCENTUALI TEMPORALI ==========
    console.log('üìä STEP 2: Validazione percentuali temporali...');
    
    const percAnno0El = document.getElementById('percAnno0');
    const percAnno1El = document.getElementById('percAnno1');
    const percAnno2El = document.getElementById('percAnno2');
    
    if (!percAnno0El || !percAnno1El || !percAnno2El) {
        console.error('‚ùå ERRORE: Campi percentuali non trovati!');
        alert('‚ùå ERRORE: Campi percentuali non trovati!');
        return;
    }
    
    if (!validaPercentuali()) {
        console.warn('‚ö†Ô∏è Percentuali non valide');
        alert('‚ö†Ô∏è Attenzione: La somma delle percentuali deve essere 100%!');
        return;
    }
    
    const perc0 = parseFloat(percAnno0El.value) / 100;
    const perc1 = parseFloat(percAnno1El.value) / 100;
    const perc2 = parseFloat(percAnno2El.value) / 100;
    
    console.log(`Percentuali: Anno0=${(perc0*100).toFixed(0)}%, Anno1=${(perc1*100).toFixed(0)}%, Anno2=${(perc2*100).toFixed(0)}%`);
    
    // ========== STEP 3: CLASSIFICA MATERIALI E IMMATERIALI ==========
    console.log('üèóÔ∏è STEP 3: Classificazione materiali/immateriali...');
    
    let totMateriali = 0;
    let totImmateriali = 0;
    
    voci.forEach(voce => {
        const investimento = investimentiPerVoce[voce];
        const categoria = categoriaPerVoce[voce];
        
        if (categoria === 'MAT') {
            totMateriali += investimento;
        } else if (categoria === 'IMM') {
            totImmateriali += investimento;
        }
    });
    
    console.log(`Materiali totali: ‚Ç¨${totMateriali.toLocaleString('it-IT')}`);
    console.log(`Immateriali totali: ‚Ç¨${totImmateriali.toLocaleString('it-IT')}`);
    console.log('Dettaglio classificazione:');
    voci.forEach(voce => {
        console.log(`  - ${voce}: ${categoriaPerVoce[voce]} (‚Ç¨${investimentiPerVoce[voce].toLocaleString('it-IT')})`);
    });
    
    // ========== STEP 4: APPLICA PERCENTUALI TEMPORALI ==========
    console.log('üìÖ STEP 4: Applicazione percentuali temporali...');
    
    const matAnno0 = Math.round(totMateriali * perc0);
    const matAnno1 = Math.round(totMateriali * perc1);
    const matAnno2 = Math.round(totMateriali * perc2);
    
    const immAnno0 = Math.round(totImmateriali * perc0);
    const immAnno1 = Math.round(totImmateriali * perc1);
    const immAnno2 = Math.round(totImmateriali * perc2);
    
    const ivaAnno0 = Math.round(totaleIva * perc0);
    const ivaAnno1 = Math.round(totaleIva * perc1);
    const ivaAnno2 = Math.round(totaleIva * perc2);
    
    console.log('Anno 0:');
    console.log(`  Materiali: ‚Ç¨${matAnno0.toLocaleString('it-IT')}`);
    console.log(`  Immateriali: ‚Ç¨${immAnno0.toLocaleString('it-IT')}`);
    console.log(`  IVA: ‚Ç¨${ivaAnno0.toLocaleString('it-IT')}`);
    
    console.log('Anno 1:');
    console.log(`  Materiali: ‚Ç¨${matAnno1.toLocaleString('it-IT')}`);
    console.log(`  Immateriali: ‚Ç¨${immAnno1.toLocaleString('it-IT')}`);
    console.log(`  IVA: ‚Ç¨${ivaAnno1.toLocaleString('it-IT')}`);
    
    console.log('Anno 2:');
    console.log(`  Materiali: ‚Ç¨${matAnno2.toLocaleString('it-IT')}`);
    console.log(`  Immateriali: ‚Ç¨${immAnno2.toLocaleString('it-IT')}`);
    console.log(`  IVA: ‚Ç¨${ivaAnno2.toLocaleString('it-IT')}`);
    
    // ========== STEP 5: POPOLA QUADRO H ==========
    console.log('üìù STEP 5: Popolamento Quadro H...');
    
    const campiQuadroH = [
        { id: 'h_materiali_0', value: matAnno0, desc: 'Materiali Anno 0' },
        { id: 'h_materiali_1', value: matAnno1, desc: 'Materiali Anno 1' },
        { id: 'h_materiali_2', value: matAnno2, desc: 'Materiali Anno 2' },
        { id: 'h_immateriali_0', value: immAnno0, desc: 'Immateriali Anno 0' },
        { id: 'h_immateriali_1', value: immAnno1, desc: 'Immateriali Anno 1' },
        { id: 'h_immateriali_2', value: immAnno2, desc: 'Immateriali Anno 2' },
        { id: 'h_iva_0', value: ivaAnno0, desc: 'IVA Anno 0' },
        { id: 'h_iva_1', value: ivaAnno1, desc: 'IVA Anno 1' },
        { id: 'h_iva_2', value: ivaAnno2, desc: 'IVA Anno 2' }
    ];
    
    let popolatiCorrettamente = 0;
    let campiMancanti = [];
    
    campiQuadroH.forEach(campo => {
        const elemento = document.getElementById(campo.id);
        if (elemento) {
            elemento.value = campo.value;
            console.log(`  ‚úì ${campo.desc}: ‚Ç¨${campo.value.toLocaleString('it-IT')}`);
            popolatiCorrettamente++;
        } else {
            console.error(`  ‚úó ${campo.desc} (${campo.id}): NON TROVATO`);
            campiMancanti.push(campo);
        }
    });
    
    if (campiMancanti.length > 0) {
        console.error('‚ùå ERRORE: Campi mancanti nel Quadro H');
        alert(`‚ùå ERRORE: Alcuni campi del Quadro H non sono stati trovati:\n\n${campiMancanti.map(c => `‚Ä¢ ${c.id}`).join('\n')}`);
        return;
    }
    
    // ========== STEP 6: CALCOLA TOTALI ==========
    console.log('üî¢ STEP 6: Calcolo totali Quadro H...');
    
    if (typeof calcolaTotaliQuadroH === 'function') {
        calcolaTotaliQuadroH();
        console.log('  ‚úì calcolaTotaliQuadroH() eseguita');
    } else {
        console.warn('  ‚ö†Ô∏è Funzione calcolaTotaliQuadroH non trovata');
    }
    
    // ========== STEP 7: ALERT FINALE ==========
    console.log('‚úÖ FINE popolaQuadroH() - COMPLETATO');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    alert(`‚úÖ Quadro H popolato correttamente!

üìä CLASSIFICAZIONE:
- Immobilizzazioni Materiali: ‚Ç¨${totMateriali.toLocaleString('it-IT')}
- Immobilizzazioni Immateriali: ‚Ç¨${totImmateriali.toLocaleString('it-IT')}
- IVA: ‚Ç¨${totaleIva.toLocaleString('it-IT')}

üìÖ DISTRIBUZIONE TEMPORALE:
- Anno 0 (${(perc0*100).toFixed(0)}%): ‚Ç¨${(matAnno0 + immAnno0 + ivaAnno0).toLocaleString('it-IT')}
- Anno 1 (${(perc1*100).toFixed(0)}%): ‚Ç¨${(matAnno1 + immAnno1 + ivaAnno1).toLocaleString('it-IT')}
- Anno 2 (${(perc2*100).toFixed(0)}%): ‚Ç¨${(matAnno2 + immAnno2 + ivaAnno2).toLocaleString('it-IT')}

üîç DETTAGLIO CLASSIFICAZIONE:
${voci.map(v => `‚Ä¢ ${v.charAt(0).toUpperCase() + v.slice(1)}: ${categoriaPerVoce[v]} - ‚Ç¨${investimentiPerVoce[v].toLocaleString('it-IT')}`).join('\n')}`);
}

function calcolaTotaliQuadroH() {
    let totFabbTotale = 0;
    let totFontiTotale = 0;
    let bilanciatoPerAnno = [true, true, true]; // Flag per ogni anno
    let differenzeAnni = [0, 0, 0]; // Differenze per ogni anno
    
    for (let anno = 0; anno <= 2; anno++) {
        const immateriali = parseFloat(document.getElementById(`h_immateriali_${anno}`).value) || 0;
        const materiali = parseFloat(document.getElementById(`h_materiali_${anno}`).value) || 0;
        const iva = parseFloat(document.getElementById(`h_iva_${anno}`).value) || 0;
        const totFabb = immateriali + materiali + iva;
        
        const fabbCell = document.getElementById(`h_fabb_${anno}`);
        fabbCell.textContent = totFabb.toLocaleString('it-IT', {minimumFractionDigits: 0});
        
        const capitale = parseFloat(document.getElementById(`h_capitale_${anno}`).value) || 0;
        const contributo = parseFloat(document.getElementById(`h_contributo_${anno}`).value) || 0;
        const finMlt = parseFloat(document.getElementById(`h_fin_mlt_${anno}`).value) || 0;
        const finBt = parseFloat(document.getElementById(`h_fin_bt_${anno}`).value) || 0;
        const altre = parseFloat(document.getElementById(`h_altre_${anno}`).value) || 0;
        const totFonti = capitale + contributo + finMlt + finBt + altre;
        
        const fontiCell = document.getElementById(`h_fonti_${anno}`);
        fontiCell.textContent = totFonti.toLocaleString('it-IT', {minimumFractionDigits: 0});
        
        // VERIFICA BILANCIAMENTO PER QUESTO ANNO
        const diff = totFonti - totFabb;
        differenzeAnni[anno] = diff;
        
        if (Math.abs(diff) < 1) {
            // Bilanciato: verde
            fabbCell.style.background = '#d4edda';
            fabbCell.style.color = '#155724';
            fontiCell.style.background = '#d4edda';
            fontiCell.style.color = '#155724';
            bilanciatoPerAnno[anno] = true;
        } else {
            // Non bilanciato: rosso
            fabbCell.style.background = '#f8d7da';
            fabbCell.style.color = '#721c24';
            fontiCell.style.background = '#f8d7da';
            fontiCell.style.color = '#721c24';
            bilanciatoPerAnno[anno] = false;
        }
        
        totFabbTotale += totFabb;
        totFontiTotale += totFonti;
    }
    
    // TOTALI COLONNE FINALI
    let totImmateriali = 0, totMateriali = 0, totIva = 0;
    let totCapitale = 0, totContributo = 0, totFinMlt = 0, totFinBt = 0, totAltre = 0;
    
    for (let anno = 0; anno <= 2; anno++) {
        totImmateriali += parseFloat(document.getElementById(`h_immateriali_${anno}`).value) || 0;
        totMateriali += parseFloat(document.getElementById(`h_materiali_${anno}`).value) || 0;
        totIva += parseFloat(document.getElementById(`h_iva_${anno}`).value) || 0;
        totCapitale += parseFloat(document.getElementById(`h_capitale_${anno}`).value) || 0;
        totContributo += parseFloat(document.getElementById(`h_contributo_${anno}`).value) || 0;
        totFinMlt += parseFloat(document.getElementById(`h_fin_mlt_${anno}`).value) || 0;
        totFinBt += parseFloat(document.getElementById(`h_fin_bt_${anno}`).value) || 0;
        totAltre += parseFloat(document.getElementById(`h_altre_${anno}`).value) || 0;
    }
    
    document.getElementById('h_immateriali_tot').textContent = totImmateriali.toLocaleString('it-IT');
    document.getElementById('h_materiali_tot').textContent = totMateriali.toLocaleString('it-IT');
    document.getElementById('h_iva_tot').textContent = totIva.toLocaleString('it-IT');
    document.getElementById('h_fabb_tot').textContent = totFabbTotale.toLocaleString('it-IT');
    
    document.getElementById('h_capitale_tot').textContent = totCapitale.toLocaleString('it-IT');
    document.getElementById('h_contributo_tot').textContent = totContributo.toLocaleString('it-IT');
    document.getElementById('h_fin_mlt_tot').textContent = totFinMlt.toLocaleString('it-IT');
    document.getElementById('h_fin_bt_tot').textContent = totFinBt.toLocaleString('it-IT');
    document.getElementById('h_altre_tot').textContent = totAltre.toLocaleString('it-IT');
    document.getElementById('h_fonti_tot').textContent = totFontiTotale.toLocaleString('it-IT');
    
    // MOSTRA ALERT IN BASE ALLA SITUAZIONE
    const tuttiOk = bilanciatoPerAnno.every(x => x);
    
    if (tuttiOk) {
        document.getElementById('h_alert_bilancio').style.display = 'none';
        document.getElementById('h_alert_success').style.display = 'block';
    } else {
        document.getElementById('h_alert_bilancio').style.display = 'block';
        document.getElementById('h_alert_success').style.display = 'none';
        
        // Costruisci messaggio dettagliato
        let messaggioDettaglio = '';
        for (let anno = 0; anno <= 2; anno++) {
            if (!bilanciatoPerAnno[anno]) {
                const annoLabel = anno === 0 ? 'Anno Avvio' : `Anno +${anno}`;
                const segno = differenzeAnni[anno] > 0 ? '+' : '';
                messaggioDettaglio += `<br>‚Ä¢ ${annoLabel}: ${segno}${differenzeAnni[anno].toLocaleString('it-IT', {minimumFractionDigits: 2})} ‚Ç¨`;
            }
        }
        
        document.getElementById('h_diff').innerHTML = messaggioDettaglio;
    }
// Aggiungi alla fine della funzione calcolaTotaliQuadroH()

// Popola tabella verifica dettagliata
for (let anno = 0; anno <= 2; anno++) {
    const fabb = parseFloat(document.getElementById(`h_fabb_${anno}`).textContent.replace(/[,.]/g, '')) || 0;
    const fonti = parseFloat(document.getElementById(`h_fonti_${anno}`).textContent.replace(/[,.]/g, '')) || 0;
    const diff = fonti - fabb;
    
    document.getElementById(`verif_fabb_${anno}`).textContent = fabb.toLocaleString('it-IT') + ' ‚Ç¨';
    document.getElementById(`verif_fonti_${anno}`).textContent = fonti.toLocaleString('it-IT') + ' ‚Ç¨';
    document.getElementById(`verif_diff_${anno}`).textContent = diff.toLocaleString('it-IT', {minimumFractionDigits: 2}) + ' ‚Ç¨';
    
    const statoCell = document.getElementById(`verif_stato_${anno}`);
    const rowCell = document.getElementById(`verifica_anno_${anno}`);
    
    if (Math.abs(diff) < 1) {
        statoCell.innerHTML = '<strong style="color: #155724;">‚úì OK</strong>';
        rowCell.style.background = '#d4edda';
    } else {
        statoCell.innerHTML = '<strong style="color: #721c24;">‚úó KO</strong>';
        rowCell.style.background = '#f8d7da';
    }
}

// Totali tabella verifica
document.getElementById('verif_fabb_tot').textContent = totFabbTotale.toLocaleString('it-IT') + ' ‚Ç¨';
document.getElementById('verif_fonti_tot').textContent = totFontiTotale.toLocaleString('it-IT') + ' ‚Ç¨';
document.getElementById('verif_diff_tot').textContent = (totFontiTotale - totFabbTotale).toLocaleString('it-IT', {minimumFractionDigits: 2}) + ' ‚Ç¨';

const diffTot = totFontiTotale - totFabbTotale;
const statoTotCell = document.getElementById('verif_stato_tot');
if (Math.abs(diffTot) < 1) {
    statoTotCell.innerHTML = '<strong style="color: #155724;">‚úì OK</strong>';
} else {
    statoTotCell.innerHTML = '<strong style="color: #721c24;">‚úó KO</strong>';
}
}

        function calcolaTotaliTempistica() {
    const voci = ['consulenze', 'progettazione', 'immobili', 'opere', 'software', 'macchinari'];
    let totImporto = 0, tot0 = 0, tot1 = 0, tot2 = 0, totFinale = 0;
    
    // Legge le percentuali
    const perc0 = (parseFloat(document.getElementById('percAnno0').value) || 0) / 100;
    const perc1 = (parseFloat(document.getElementById('percAnno1').value) || 0) / 100;
    const perc2 = (parseFloat(document.getElementById('percAnno2').value) || 0) / 100;
    
    voci.forEach(voce => {
        const importo = parseFloat(document.getElementById(`temp_${voce}`).value) || 0;
        
        // Applica automaticamente le percentuali
        const v0 = Math.round(importo * perc0);
        const v1 = Math.round(importo * perc1);
        const v2 = Math.round(importo * perc2);
        
        // Aggiorna i campi (ora sono readonly)
        document.getElementById(`temp_${voce}_0`).value = v0;
        document.getElementById(`temp_${voce}_1`).value = v1;
        document.getElementById(`temp_${voce}_2`).value = v2;
        
        const totVoce = v0 + v1 + v2;
        document.getElementById(`temp_${voce}_tot`).textContent = totVoce.toLocaleString('it-IT');
        
        totImporto += importo;
        tot0 += v0;
        tot1 += v1;
        tot2 += v2;
        totFinale += totVoce;
    });
    
    document.getElementById('temp_tot_importo').textContent = totImporto.toLocaleString('it-IT');
    document.getElementById('temp_tot_0').textContent = tot0.toLocaleString('it-IT');
    document.getElementById('temp_tot_1').textContent = tot1.toLocaleString('it-IT');
    document.getElementById('temp_tot_2').textContent = tot2.toLocaleString('it-IT');
    document.getElementById('temp_tot_finale').textContent = totFinale.toLocaleString('it-IT');
}

     function popolaQuadroL() {
    console.log('üìä Inizio popolaQuadroL() - SOLO ANNO A REGIME');
    
    // ========== LEGGI DATI BASE ==========
    const occ = calcolaOccupazione();
    const adr = parseFloat(document.getElementById('adr')?.value) || 0;
    const fattCamere = occ.camereTotali * adr;
    const fattRist = parseFloat(document.getElementById('fattRistorazione')?.value) || 0;
    const altriRicBase = parseFloat(document.getElementById('altriRicavi')?.value) || 0;
    const quotaContributo = parseFloat(document.getElementById('quotaContributoAnnua')?.value) || 0;
    const fatturatoTotale = fattCamere;
    
    // ========== LEGGI COSTI ==========
    const materie = (parseFloat(document.getElementById('costiMaterie')?.value) || 0) / 1000;
    const costiServizi = parseFloat(document.getElementById('costiServizi')?.value) || 0;
    const costiBeni = parseFloat(document.getElementById('costiBeni')?.value) || 0;
    const costiMarketing = parseFloat(document.getElementById('costiMarketing')?.value) || 0;
    const speseGenerali = parseFloat(document.getElementById('speseGenerali')?.value) || 0;
    const serviziTotali = (costiServizi + costiBeni + costiMarketing + speseGenerali) / 1000;
    const personale = (parseFloat(document.getElementById('costoPersonale')?.value) || 0) / 1000;
    
    // ========== AMMORTAMENTI ==========
    const ammImmBase = (parseFloat(document.getElementById('ammImmateriali')?.value) || 0) / 1000;
    const ammMatBase = (parseFloat(document.getElementById('ammMateriali')?.value) || 0) / 1000;
    const ammImmInv = (parseFloat(document.getElementById('ammImmaterialiInvestimenti')?.value) || 0) / 1000;
    const ammMatInv = (parseFloat(document.getElementById('ammMaterialiInvestimenti')?.value) || 0) / 1000;
    const ammImmTotale = ammImmBase + ammImmInv;
    const ammMatTotale = ammMatBase + ammMatInv;
    
    const oneriFin = (parseFloat(document.getElementById('oneriFin')?.value) || 0) / 1000;
    const imposte = (parseFloat(document.getElementById('imposte')?.value) || 0) / 1000;
    
    // ========== STATO IMPRESA ==========
    const statoImpresa = document.getElementById('impresaStato')?.value || 'inattiva';
    
    // ========== POPOLA SOLO ANNO A REGIME (202x+2) ==========
    console.log(`‚úÖ Popolo solo anno a regime per impresa ${statoImpresa}`);
    
    // ANNO PRECEDENTE (solo per attive)
    if (statoImpresa === 'attiva') {
        const fattPrec = (parseFloat(document.getElementById('fattPrecedente')?.value) || 0) / 1000;
        document.getElementById('l_fatt_prec').value = fattPrec.toFixed(1);
    }
    
    // ANNO A REGIME (202x+2) - UGUALE PER TUTTI
    document.getElementById('l_fatt_2').value = (fatturatoTotale / 1000).toFixed(1);
    document.getElementById('l_altri_ric_2').value = ((altriRicBase + fattRist + quotaContributo) / 1000).toFixed(1);
    document.getElementById('l_materie_2').value = materie.toFixed(1);
    document.getElementById('l_servizi_2').value = serviziTotali.toFixed(1);
    document.getElementById('l_personale_2').value = personale.toFixed(1);
    document.getElementById('l_amm_imm_2').value = ammImmTotale.toFixed(1);
    document.getElementById('l_amm_mat_2').value = ammMatTotale.toFixed(1);
    document.getElementById('l_gest_fin_2').value = (-oneriFin).toFixed(1);
    document.getElementById('l_imposte_2').value = imposte.toFixed(1);
    
    // ========== POPOLA STATO PATRIMONIALE ==========
    popolaStatoPatrimonialeAutomatico();
    
    // ========== CALCOLA TOTALI ==========
    if (typeof calcolaTotaliQuadroL === 'function') {
        calcolaTotaliQuadroL();
    }
    
    console.log('‚úÖ Fine popolaQuadroL()');
    
    alert(`‚úÖ Quadro L popolato correttamente!\n\nüìä ANNO A REGIME (202x+2):\n‚Ä¢ Fatturato: ‚Ç¨${(fatturatoTotale/1000).toFixed(1)}k\n‚Ä¢ Ammortamenti totali: ‚Ç¨${(ammImmTotale + ammMatTotale).toFixed(1)}k`);
}
function popolaStatoPatrimonialeAutomatico() {
    console.log('üè¶ Popolamento automatico Stato Patrimoniale anno a regime');
    
    const voci = ['edile', 'impianti', 'macchinari', 'attrezzature', 'arredi', 'tecniche', 'consulenze', 'informatiche'];
    
    // ========== CALCOLA VALORI NETTI IMMOBILIZZAZIONI ==========
    let immImmaterialiNette = 0;
    let immMaterialiNette = 0;
    let terreniEdile = 0; // Parte edile va qui
    let impiantiMacchinariNetti = 0;
    let attrezzatureArrediNetti = 0;
    
    voci.forEach(voce => {
        const investimento = parseFloat(document.getElementById(`inv_${voce}_investimento`)?.value) || 0;
        const aliquota = parseFloat(document.getElementById(`inv_${voce}_aliquota`)?.value) || 0;
        const categoria = voce === 'edile' || voce === 'tecniche' 
            ? document.getElementById(`inv_${voce}_categoria`)?.value 
            : (voce === 'consulenze' || voce === 'informatiche' ? 'IMM' : 'MAT');
        
        if (investimento > 0 && aliquota > 0) {
            // Valore netto = investimento - ammortamento 1 anno
            const ammortamento = investimento * aliquota / 100;
            const valoreNetto = investimento - ammortamento;
            
            console.log(`  ${voce}: inv=${investimento}, amm=${ammortamento}, netto=${valoreNetto}, cat=${categoria}`);
            
            // Classifica per categoria
            if (categoria === 'IMM') {
                immImmaterialiNette += valoreNetto;
            } else if (categoria === 'MAT') {
                if (voce === 'edile') {
                    terreniEdile += valoreNetto;
                } else if (voce === 'impianti' || voce === 'macchinari') {
                    impiantiMacchinariNetti += valoreNetto;
                } else if (voce === 'attrezzature' || voce === 'arredi') {
                    attrezzatureArrediNetti += valoreNetto;
                }
            }
        }
    });
    
    console.log('üìä Totali calcolati:');
    console.log(`  Immateriali nette: ${immImmaterialiNette.toFixed(2)}`);
    console.log(`  Terreni/Edile: ${terreniEdile.toFixed(2)}`);
    console.log(`  Impianti/Macchinari: ${impiantiMacchinariNetti.toFixed(2)}`);
    console.log(`  Attrezzature/Arredi: ${attrezzatureArrediNetti.toFixed(2)}`);
    
    // ========== POPOLA ANNO A REGIME (202x+2) ==========
    // Immobilizzazioni Immateriali
    const immImmEl = document.getElementById('sp_imm_imm_2');
    if (immImmEl) {
        immImmEl.value = (immImmaterialiNette / 1000).toFixed(1);
        console.log(`‚úì Immob. Immateriali popolate: ${immImmEl.value}k`);
    }
    
    // Terreni e fabbricati
    const terreniEl = document.getElementById('sp_terreni_2');
    if (terreniEl) {
        terreniEl.value = (terreniEdile / 1000).toFixed(1);
        console.log(`‚úì Terreni/Fabbricati popolati: ${terreniEl.value}k`);
    }
    
    // Impianti e macchinari
    const impiantiEl = document.getElementById('sp_impianti_2');
    if (impiantiEl) {
        impiantiEl.value = (impiantiMacchinariNetti / 1000).toFixed(1);
        console.log(`‚úì Impianti/Macchinari popolati: ${impiantiEl.value}k`);
    }
    
    // Attrezzature, arredi e altri beni
    const attrezzatureEl = document.getElementById('sp_attrezzature_2');
    if (attrezzatureEl) {
        attrezzatureEl.value = (attrezzatureArrediNetti / 1000).toFixed(1);
        console.log(`‚úì Attrezzature/Arredi popolati: ${attrezzatureEl.value}k`);
    }
    
    // ========== POPOLA UTILI (PERDITE) DAL RISULTATO NETTO ==========
    const risultatoNetto = parseFloat(document.getElementById('l_ris_netto_2')?.textContent) || 0;
    const utiliEl = document.getElementById('sp_utili_2');
    if (utiliEl) {
        utiliEl.value = risultatoNetto.toFixed(1);
        console.log(`‚úì Utili (perdite) popolati: ${utiliEl.value}k (da risultato netto CE)`);
    }
    
    // ========== RISCONTI PASSIVI (Contributo residuo) ==========
    const contributoResiduo = (parseFloat(document.getElementById('contributoResiduoRisconti')?.value) || 0) / 1000;
    const riscontiPassEl = document.getElementById('sp_ratei_pass_2');
    if (riscontiPassEl) {
        riscontiPassEl.value = contributoResiduo.toFixed(1);
        console.log(`‚úì Risconti passivi popolati: ${riscontiPassEl.value}k`);
    }
    
    // ========== RICALCOLA TOTALI STATO PATRIMONIALE ==========
    if (typeof calcolaTotaliStatoPatrimoniale === 'function') {
        calcolaTotaliStatoPatrimoniale();
        console.log('‚úì Totali Stato Patrimoniale ricalcolati');
    }
    
    console.log('‚úÖ Stato Patrimoniale popolato automaticamente');
}
        function calcolaTotaliQuadroL() {
            const anni = ['prec', '0', '1', '2'];
            
            anni.forEach(anno => {
                const fatt = parseFloat(document.getElementById(`l_fatt_${anno}`).value) || 0;
                const altriRic = parseFloat(document.getElementById(`l_altri_ric_${anno}`).value) || 0;
                const valProd = fatt + altriRic;
                document.getElementById(`l_val_prod_${anno}`).textContent = valProd.toFixed(1);
                
                const materie = parseFloat(document.getElementById(`l_materie_${anno}`).value) || 0;
                const rimanenze = parseFloat(document.getElementById(`l_rimanenze_${anno}`).value) || 0;
                const servizi = parseFloat(document.getElementById(`l_servizi_${anno}`).value) || 0;
                const personale = parseFloat(document.getElementById(`l_personale_${anno}`).value) || 0;
                
                const mol = valProd - materie - rimanenze - servizi - personale;
                document.getElementById(`l_mol_${anno}`).textContent = mol.toFixed(1);
                
                const svalutazioni = parseFloat(document.getElementById(`l_svalutazioni_${anno}`).value) || 0;
                const ebitda = mol - svalutazioni;
                document.getElementById(`l_ebitda_${anno}`).textContent = ebitda.toFixed(1);
                
                const ammImm = parseFloat(document.getElementById(`l_amm_imm_${anno}`).value) || 0;
                const ammMat = parseFloat(document.getElementById(`l_amm_mat_${anno}`).value) || 0;
                const risOp = ebitda - ammImm - ammMat;
                document.getElementById(`l_ris_op_${anno}`).textContent = risOp.toFixed(1);
                
                const gestFin = parseFloat(document.getElementById(`l_gest_fin_${anno}`).value) || 0;
                const gestStr = parseFloat(document.getElementById(`l_gest_str_${anno}`).value) || 0;
                const risLordo = risOp + gestFin + gestStr;
                document.getElementById(`l_ris_lordo_${anno}`).textContent = risLordo.toFixed(1);
                
                const imposte = parseFloat(document.getElementById(`l_imposte_${anno}`).value) || 0;
                const risNetto = risLordo - imposte;
                document.getElementById(`l_ris_netto_${anno}`).textContent = risNetto.toFixed(1);

                // ========== COLLEGA RISULTATO NETTO A UTILI (solo anno 2) ==========
        if (anno === '2') {
            const utiliEl = document.getElementById('sp_utili_2');
            if (utiliEl) {
                utiliEl.value = risNetto.toFixed(1);
                console.log(`üîó Utili aggiornati automaticamente: ${risNetto.toFixed(1)}k`);
            }
        }
            });
        }

        function calcolaTotaliStatoPatrimoniale() {
            const anni = ['prec', '0', '1', '2'];
            
            anni.forEach(anno => {
                const immImm = parseFloat(document.getElementById(`sp_imm_imm_${anno}`).value) || 0;
                document.getElementById(`sp_tot_imm_${anno}`).textContent = immImm.toFixed(1);
                
                const terreni = parseFloat(document.getElementById(`sp_terreni_${anno}`).value) || 0;
                const impianti = parseFloat(document.getElementById(`sp_impianti_${anno}`).value) || 0;
                const attrezzature = parseFloat(document.getElementById(`sp_attrezzature_${anno}`).value) || 0;
                const totMat = terreni + impianti + attrezzature;
                document.getElementById(`sp_tot_mat_${anno}`).textContent = totMat.toFixed(1);
                
                const partec = parseFloat(document.getElementById(`sp_partec_${anno}`).value) || 0;
                const titoli = parseFloat(document.getElementById(`sp_titoli_${anno}`).value) || 0;
                const totFin = partec + titoli;
                document.getElementById(`sp_tot_fin_${anno}`).textContent = totFin.toFixed(1);
                
                const attFisso = immImm + totMat + totFin;
                document.getElementById(`sp_att_fisso_${anno}`).textContent = attFisso.toFixed(1);
                
                const crediti = parseFloat(document.getElementById(`sp_crediti_${anno}`).value) || 0;
                const liquidita = parseFloat(document.getElementById(`sp_liquidita_${anno}`).value) || 0;
                const rateiAtt = parseFloat(document.getElementById(`sp_ratei_att_${anno}`).value) || 0;
                const attCirc = crediti + liquidita + rateiAtt;
                document.getElementById(`sp_att_circ_${anno}`).textContent = attCirc.toFixed(1);
                
                const totaleAtt = attFisso + attCirc;
                document.getElementById(`sp_totale_att_${anno}`).textContent = totaleAtt.toFixed(1);
                
                const capitale = parseFloat(document.getElementById(`sp_capitale_${anno}`).value) || 0;
                const riserve = parseFloat(document.getElementById(`sp_riserve_${anno}`).value) || 0;
                const utili = parseFloat(document.getElementById(`sp_utili_${anno}`).value) || 0;
                const patrNetto = capitale + riserve + utili;
                document.getElementById(`sp_patr_netto_${anno}`).textContent = patrNetto.toFixed(1);
                
                const tfr = parseFloat(document.getElementById(`sp_tfr_${anno}`).value) || 0;
                const fondi = parseFloat(document.getElementById(`sp_fondi_${anno}`).value) || 0;
                const totFondi = tfr + fondi;
                document.getElementById(`sp_tot_fondi_${anno}`).textContent = totFondi.toFixed(1);
                
                const debitiMlt = parseFloat(document.getElementById(`sp_debiti_mlt_${anno}`).value) || 0;
                document.getElementById(`sp_pass_cons_${anno}`).textContent = debitiMlt.toFixed(1);
                
                const debitiBt = parseFloat(document.getElementById(`sp_debiti_bt_${anno}`).value) || 0;
                const fornitori = parseFloat(document.getElementById(`sp_fornitori_${anno}`).value) || 0;
                const rateiPass = parseFloat(document.getElementById(`sp_ratei_pass_${anno}`).value) || 0;
                const passCorr = debitiBt + fornitori + rateiPass;
                document.getElementById(`sp_pass_corr_${anno}`).textContent = passCorr.toFixed(1);
                
                const totalePas = patrNetto + totFondi + debitiMlt + passCorr;
                document.getElementById(`sp_totale_pass_${anno}`).textContent = totalePas.toFixed(1);
                
                const diff = Math.abs(totaleAtt - totalePas);
                if (diff < 0.1) {
                    document.getElementById('sp_alert_quadratura').style.display = 'none';
                    document.getElementById('sp_alert_success').style.display = 'block';
                } else {
                    document.getElementById('sp_alert_quadratura').style.display = 'block';
                    document.getElementById('sp_alert_success').style.display = 'none';
                }
            });
        }

        // ========== PUNTEGGIO ==========
        function calcolaPunteggio() {
            if (!risultati || !('investimentoTotale' in risultati)) {
                alert('‚ö†Ô∏è Devi prima calcolare gli indici dal Quadro L!');
                return;
            }
            
            const r = risultati;
            let punteggi = {a: 0, b: 0, c: 0, d: 0, e: 0, f: 0};
            
            // CRITERIO A
            let ulaRilevanti = r.statoImpresa === 'inattiva' ? (r.dipendentiPrevisti || 0) : (r.dipendentiPrevisti - r.dipendentiAttuali > 0 ? r.dipendentiPrevisti - r.dipendentiAttuali : 0);
            
            if (ulaRilevanti > 0 && r.investimentoTotale > 0) {
                const investimentoPerULA = r.investimentoTotale / ulaRilevanti;
                const soglia = r.statoImpresa === 'inattiva' ? 150000 : 350000;
                
                if (investimentoPerULA <= soglia) {
                    punteggi.a = 2;
                    if (investimentoPerULA <= soglia / 1.5) punteggi.a = 4;
                    if (investimentoPerULA <= soglia / 2) punteggi.a = 6;
                }
                
                document.getElementById('griglia_invula').textContent = '‚Ç¨' + Math.round(investimentoPerULA).toLocaleString('it-IT');
                document.getElementById('griglia_invula_punti').textContent = punteggi.a + ' punti';
                
                const dettaglioA = [
                    {criterio: r.statoImpresa === 'inattiva' ? '‚â• 1 ULA ogni ‚Ç¨150k' : '‚â• 1 ULA ogni ‚Ç¨350k', soglia, punti: 2, achieved: investimentoPerULA <= soglia},
                    {criterio: r.statoImpresa === 'inattiva' ? '‚â• 1,5 ULA ogni ‚Ç¨150k' : '‚â• 1,5 ULA ogni ‚Ç¨350k', soglia: Math.round(soglia * 0.67), punti: 4, achieved: investimentoPerULA <= soglia * 0.67},
                    {criterio: r.statoImpresa === 'inattiva' ? '‚â• 2 ULA ogni ‚Ç¨150k' : '‚â• 2 ULA ogni ‚Ç¨350k', soglia: Math.round(soglia * 0.5), punti: 6, achieved: investimentoPerULA <= soglia * 0.5}
                ];
                
                let htmlA = '';
                dettaglioA.forEach(item => {
                    htmlA += `<tr style="${item.achieved ? 'background: #d4edda;' : ''}"><td>${item.criterio}</td><td>‚Ç¨${item.soglia.toLocaleString('it-IT')}</td><td>${item.punti}</td><td>${item.achieved ? '‚úì Raggiunto' : '‚úó Non raggiunto'}</td></tr>`;
                });
                document.getElementById('griglia_a_dettaglio').innerHTML = htmlA;
            }
            
            // CRITERIO B
                if (r.investimentiOperativi > 0 && r.investimentoTotale > 0) {
                const rapportoB = r.investimentoTotale / r.investimentiOperativi;
                if (rapportoB <= 1.5) punteggi.b = 20;
                else if (rapportoB <= 2.0) punteggi.b = 16;
                else if (rapportoB <= 2.5) punteggi.b = 10;
                else if (rapportoB <= 3.0) punteggi.b = 7;
                
                document.getElementById('griglia_invop').textContent = rapportoB.toFixed(2);
                document.getElementById('griglia_invop_punti').textContent = punteggi.b + ' punti';
                
                const percOperativa = (r.investimentiOperativi / r.investimentoTotale * 100).toFixed(1);
                const dettaglioB = [
                    {rapporto: '> 3.0', percOperativa: '< 33%', punti: 0, achieved: rapportoB > 3.0},
                    {rapporto: '‚â§ 3.0', percOperativa: '‚â• 33%', punti: 7, achieved: rapportoB <= 3.0 && rapportoB > 2.5},
                    {rapporto: '‚â§ 2.5', percOperativa: '‚â• 40%', punti: 10, achieved: rapportoB <= 2.5 && rapportoB > 2.0},
                    {rapporto: '‚â§ 2.0', percOperativa: '‚â• 50%', punti: 16, achieved: rapportoB <= 2.0 && rapportoB > 1.5},
                    {rapporto: '‚â§ 1.5', percOperativa: '‚â• 67%', punti: 20, achieved: rapportoB <= 1.5}
                ];
                
                let htmlB = '';
                dettaglioB.forEach(item => {
                    htmlB += `<tr style="${item.achieved ? 'background: #d4edda;' : ''}"><td>${item.rapporto}</td><td>${item.percOperativa}</td><td>${item.punti}</td><td>${item.achieved ? '‚úì Raggiunto' : '‚úó Non raggiunto'}</td></tr>`;
                });
                document.getElementById('griglia_b_dettaglio').innerHTML = htmlB;
            }
            
// CRITERIO C
let puntiRos = 0, puntiRoi = 0, puntiEbitda = 0, puntiSat = 0;

// C.1 - ROS
if (r.statoImpresa === 'inattiva') {
    // Impresa inattiva: valore assoluto anno a regime (gi√† arrotondato)
    if (r.ros > 20) puntiRos = 4; 
    else if (r.ros >= 10) puntiRos = 2;
    
    console.log(`ROS Inattiva: ${r.ros}% (arrotondato) ‚Üí ${puntiRos} punti`);
} else {
    // Impresa attiva: variazione percentuale rispetto anno precedente
    const fattPrec = (parseFloat(document.getElementById('l_fatt_prec').value) || 0) * 1000;
    const risOpPrec = (parseFloat(document.getElementById('l_ris_op_prec').textContent) || 0) * 1000;
    const rosPrec = fattPrec > 0 ? (risOpPrec / fattPrec) * 100 : 0;
    const rosPrecArrotondato = Math.round(rosPrec);  // ARROTONDA ANCHE IL PRECEDENTE
    
    // Formula bando con valori arrotondati
    let variazionePercRos;
    if (rosPrecArrotondato <= 0 && r.ros > 0) {
        variazionePercRos = 100; // Da ‚â§0 a >0 = miglioramento massimo
    } else if (rosPrecArrotondato > 0) {
        variazionePercRos = ((r.ros - rosPrecArrotondato) / rosPrecArrotondato) * 100;
    } else {
        variazionePercRos = 0; // Entrambi ‚â§0
    }
    
    if (variazionePercRos > 10) puntiRos = 4; 
    else if (variazionePercRos >= 5) puntiRos = 2;
    
    console.log(`ROS Attiva: ${rosPrecArrotondato}% ‚Üí ${r.ros}% (variazione: ${variazionePercRos.toFixed(2)}%) ‚Üí ${puntiRos} punti`);
}

// C.2 - ROI
if (r.statoImpresa === 'inattiva') {
    // Impresa inattiva: valore assoluto anno a regime (gi√† arrotondato)
    if (r.roi > 15) puntiRoi = 4; 
    else if (r.roi >= 5) puntiRoi = 2;
    
    console.log(`ROI Inattiva: ${r.roi}% (arrotondato) ‚Üí ${puntiRoi} punti`);
} else {
    // Impresa attiva: variazione percentuale rispetto anno precedente
    const totAttPrec = (parseFloat(document.getElementById('sp_totale_att_prec').textContent) || 0) * 1000;
    const risOpPrec = (parseFloat(document.getElementById('l_ris_op_prec').textContent) || 0) * 1000;
    const roiPrec = totAttPrec > 0 ? (risOpPrec / totAttPrec) * 100 : 0;
    const roiPrecArrotondato = Math.round(roiPrec);  // ARROTONDA ANCHE IL PRECEDENTE
    
    // Formula bando con valori arrotondati
    let variazionePercRoi;
    if (roiPrecArrotondato <= 0 && r.roi > 0) {
        variazionePercRoi = 100; // Da ‚â§0 a >0 = miglioramento massimo
    } else if (roiPrecArrotondato > 0) {
        variazionePercRoi = ((r.roi - roiPrecArrotondato) / roiPrecArrotondato) * 100;
    } else {
        variazionePercRoi = 0; // Entrambi ‚â§0
    }
    
    if (variazionePercRoi > 10) puntiRoi = 4; 
    else if (variazionePercRoi >= 5) puntiRoi = 2;
    
    console.log(`ROI Attiva: ${roiPrecArrotondato}% ‚Üí ${r.roi}% (variazione: ${variazionePercRoi.toFixed(2)}%) ‚Üí ${puntiRoi} punti`);
}

// C.3 - EBITDA Margin
if (r.statoImpresa === 'inattiva') {
    // Impresa inattiva: valore assoluto anno a regime (gi√† arrotondato)
    if (r.ebitdaMargin > 30) puntiEbitda = 4; 
    else if (r.ebitdaMargin >= 15) puntiEbitda = 2;
    
    console.log(`EBITDA Margin Inattiva: ${r.ebitdaMargin}% (arrotondato) ‚Üí ${puntiEbitda} punti`);
} else {
    // Impresa attiva: variazione percentuale rispetto anno precedente
    const fattPrec = (parseFloat(document.getElementById('l_fatt_prec').value) || 0) * 1000;
    const ebitdaPrec = (parseFloat(document.getElementById('l_ebitda_prec').textContent) || 0) * 1000;
    const ebitdaMarginPrec = fattPrec > 0 ? (ebitdaPrec / fattPrec) * 100 : 0;
    const ebitdaMarginPrecArrotondato = Math.round(ebitdaMarginPrec);  // ARROTONDA ANCHE IL PRECEDENTE
    
    // Formula bando con valori arrotondati
    let variazionePercEbitda;
    if (ebitdaMarginPrecArrotondato <= 0 && r.ebitdaMargin > 0) {
        variazionePercEbitda = 100; // Da ‚â§0 a >0 = miglioramento massimo
    } else if (ebitdaMarginPrecArrotondato > 0) {
        variazionePercEbitda = ((r.ebitdaMargin - ebitdaMarginPrecArrotondato) / ebitdaMarginPrecArrotondato) * 100;
    } else {
        variazionePercEbitda = 0; // Entrambi ‚â§0
    }
    
    if (variazionePercEbitda > 20) puntiEbitda = 4; 
    else if (variazionePercEbitda >= 8) puntiEbitda = 2;
    
    console.log(`EBITDA Margin Attiva: ${ebitdaMarginPrecArrotondato}% ‚Üí ${r.ebitdaMargin}% (variazione: ${variazionePercEbitda.toFixed(2)}%) ‚Üí ${puntiEbitda} punti`);
}
            
            if (r.tor > 70) puntiSat = 4; else if (r.tor >= 50) puntiSat = 2;
            
            punteggi.c = puntiRos + puntiRoi + puntiEbitda + puntiSat;
            
            document.getElementById('griglia_ros').textContent = (r.ros || 0).toFixed(2) + '%';
            document.getElementById('griglia_ros_punti').textContent = puntiRos + ' punti';
            document.getElementById('griglia_roi').textContent = (r.roi || 0).toFixed(2) + '%';
            document.getElementById('griglia_roi_punti').textContent = puntiRoi + ' punti';
            document.getElementById('griglia_ebitda').textContent = (r.ebitdaMargin || 0).toFixed(2) + '%';
            document.getElementById('griglia_ebitda_punti').textContent = puntiEbitda + ' punti';
            document.getElementById('griglia_sat').textContent = (r.tor || 0).toFixed(2) + '%';
            document.getElementById('griglia_sat_punti').textContent = puntiSat + ' punti';
            document.getElementById('griglia_c_tot').textContent = punteggi.c + ' punti';
            
            // CRITERI D, E, F
            punteggi.d = parseFloat(document.getElementById('griglia_d').value) || 0;
            if (punteggi.d > 14) punteggi.d = 14;
            
            punteggi.e = parseFloat(document.getElementById('griglia_e').value) || 0;
            if (punteggi.e > 10) punteggi.e = 10;
            
            punteggi.f = parseFloat(document.getElementById('griglia_f').value) || 0;
            
            const totale = punteggi.a + punteggi.b + punteggi.c + punteggi.d + punteggi.e + punteggi.f;
            
            document.getElementById('punteggioTotale').textContent = totale;
            document.getElementById('final_a').textContent = punteggi.a;
            document.getElementById('final_b').textContent = punteggi.b;
            document.getElementById('final_c').textContent = punteggi.c;
            document.getElementById('final_d').textContent = punteggi.d;
            document.getElementById('final_e').textContent = punteggi.e;
            document.getElementById('final_f').textContent = punteggi.f;
            document.getElementById('final_tot').textContent = totale;
            
            const scoreCard = document.querySelector('.score-card');
            if (totale >= 70) scoreCard.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
            else if (totale >= 50) scoreCard.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            else scoreCard.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';

            // Dopo il calcolo di tutti i punti del criterio C, aggiungi:

// Se impresa attiva, mostra il box variazioni
if (r.statoImpresa === 'attiva') {
    // Calcola i valori precedenti (se non gi√† calcolati)
    const fattPrec = (parseFloat(document.getElementById('l_fatt_prec').value) || 0) * 1000;
    const risOpPrec = (parseFloat(document.getElementById('l_ris_op_prec').textContent) || 0) * 1000;
    const totAttPrec = (parseFloat(document.getElementById('sp_totale_att_prec').textContent) || 0) * 1000;
    const ebitdaPrec = (parseFloat(document.getElementById('l_ebitda_prec').textContent) || 0) * 1000;
    
    const rosPrecCalc = fattPrec > 0 ? Math.round((risOpPrec / fattPrec) * 100) : 0;
    const roiPrecCalc = totAttPrec > 0 ? Math.round((risOpPrec / totAttPrec) * 100) : 0;
    const ebitdaPrecCalc = fattPrec > 0 ? Math.round((ebitdaPrec / fattPrec) * 100) : 0;
    
    let variazioneRos;
if (rosPrecCalc <= 0 && r.ros > 0) {
    variazioneRos = 100;
} else if (rosPrecCalc > 0) {
    variazioneRos = ((r.ros - rosPrecCalc) / rosPrecCalc) * 100;
} else {
    variazioneRos = 0;
}

let variazioneRoi;
if (roiPrecCalc <= 0 && r.roi > 0) {
    variazioneRoi = 100;
} else if (roiPrecCalc > 0) {
    variazioneRoi = ((r.roi - roiPrecCalc) / roiPrecCalc) * 100;
} else {
    variazioneRoi = 0;
}

let variazioneEbitda;
if (ebitdaPrecCalc <= 0 && r.ebitdaMargin > 0) {
    variazioneEbitda = 100;
} else if (ebitdaPrecCalc > 0) {
    variazioneEbitda = ((r.ebitdaMargin - ebitdaPrecCalc) / ebitdaPrecCalc) * 100;
} else {
    variazioneEbitda = 0;
}
    
    mostraVariazioni(
        rosPrecCalc, roiPrecCalc, ebitdaPrecCalc,  // Valori precedenti
        r.ros, r.roi, r.ebitdaMargin,              // Valori regime
        variazioneRos, variazioneRoi, variazioneEbitda,  // Variazioni %
        puntiRos, puntiRoi, puntiEbitda            // Punti ottenuti
    );
} else {
    // Nascondi box variazioni per imprese inattive
    const boxVariazioni = document.getElementById('boxVariazioni');
    if (boxVariazioni) {
        boxVariazioni.style.display = 'none';
    }
}
        }

        // ========== EXPORT ==========
        function exportQuadroH() {
    const wb = XLSX.utils.book_new();
    
    // ========== FOGLIO 1: PIANO FINANZIARIO (Fabbisogni e Fonti) ==========
    const dataFinanziario = [
        ['QUADRO H - PIANO FINANZIARIO PER LA COPERTURA DEGLI INVESTIMENTI', '', '', '', ''],
        ['', '', '', '', ''],
        ['FABBISOGNI (Impieghi)', 'Anno Avvio', '+1', '+2', 'TOTALE'],
        ['Investimenti immateriali', 
            document.getElementById('h_immateriali_0').value, 
            document.getElementById('h_immateriali_1').value, 
            document.getElementById('h_immateriali_2').value, 
            document.getElementById('h_immateriali_tot').textContent],
        ['Investimenti materiali', 
            document.getElementById('h_materiali_0').value, 
            document.getElementById('h_materiali_1').value, 
            document.getElementById('h_materiali_2').value, 
            document.getElementById('h_materiali_tot').textContent],
        ['IVA sugli investimenti', 
            document.getElementById('h_iva_0').value, 
            document.getElementById('h_iva_1').value, 
            document.getElementById('h_iva_2').value, 
            document.getElementById('h_iva_tot').textContent],
        ['TOTALE FABBISOGNI', 
            document.getElementById('h_fabb_0').textContent, 
            document.getElementById('h_fabb_1').textContent, 
            document.getElementById('h_fabb_2').textContent, 
            document.getElementById('h_fabb_tot').textContent],
        ['', '', '', '', ''],
        ['FONTI (Copertura Finanziaria)', 'Anno Avvio', '+1', '+2', 'TOTALE'],
        ['Incremento Capitale Sociale', 
            document.getElementById('h_capitale_0').value, 
            document.getElementById('h_capitale_1').value, 
            document.getElementById('h_capitale_2').value, 
            document.getElementById('h_capitale_tot').textContent],
        ['Contributo c/impianti', 
            document.getElementById('h_contributo_0').value, 
            document.getElementById('h_contributo_1').value, 
            document.getElementById('h_contributo_2').value, 
            document.getElementById('h_contributo_tot').textContent],
        ['Finanziamenti a m/l termine', 
            document.getElementById('h_fin_mlt_0').value, 
            document.getElementById('h_fin_mlt_1').value, 
            document.getElementById('h_fin_mlt_2').value, 
            document.getElementById('h_fin_mlt_tot').textContent],
        ['Finanziamenti a breve termine', 
            document.getElementById('h_fin_bt_0').value, 
            document.getElementById('h_fin_bt_1').value, 
            document.getElementById('h_fin_bt_2').value, 
            document.getElementById('h_fin_bt_tot').textContent],
        ['Altre Disponibilit√†', 
            document.getElementById('h_altre_0').value, 
            document.getElementById('h_altre_1').value, 
            document.getElementById('h_altre_2').value, 
            document.getElementById('h_altre_tot').textContent],
        ['TOTALE FONTI', 
            document.getElementById('h_fonti_0').textContent, 
            document.getElementById('h_fonti_1').textContent, 
            document.getElementById('h_fonti_2').textContent, 
            document.getElementById('h_fonti_tot').textContent],
        ['', '', '', '', ''],
        ['VERIFICA BILANCIAMENTO', '', '', '', ''],
        ['Differenza (Fonti - Fabbisogni)', '', '', '', 
            (parseFloat(document.getElementById('h_fonti_tot').textContent.replace(/[,.]/g, '')) - 
             parseFloat(document.getElementById('h_fabb_tot').textContent.replace(/[,.]/g, ''))).toLocaleString('it-IT')]
    ];
    
    const wsFinanziario = XLSX.utils.aoa_to_sheet(dataFinanziario);
    
    // Formattazione colonne
    wsFinanziario['!cols'] = [
        {wch: 35}, // Descrizione
        {wch: 15}, // Anno 0
        {wch: 15}, // Anno 1
        {wch: 15}, // Anno 2
        {wch: 15}  // Totale
    ];
    
    XLSX.utils.book_append_sheet(wb, wsFinanziario, 'Piano Finanziario');
    
    // ========== FOGLIO 2: TEMPISTICA REALIZZAZIONE ==========
    const dataTempistica = [
        ['TEMPISTICA PREVISTA PER LA REALIZZAZIONE DEL PROGRAMMA', '', '', '', '', ''],
        ['', '', '', '', '', ''],
        ['Descrizione Investimento', 'Importo da realizzare', 'Anno avvio', '+1', '+2', 'TOTALE'],
        ['Consulenze specialistiche e studi', 
            document.getElementById('temp_consulenze').value,
            document.getElementById('temp_consulenze_0').value,
            document.getElementById('temp_consulenze_1').value,
            document.getElementById('temp_consulenze_2').value,
            document.getElementById('temp_consulenze_tot').textContent],
        ['Oneri progettazione, direzione lavori', 
            document.getElementById('temp_progettazione').value,
            document.getElementById('temp_progettazione_0').value,
            document.getElementById('temp_progettazione_1').value,
            document.getElementById('temp_progettazione_2').value,
            document.getElementById('temp_progettazione_tot').textContent],
        ['Acquisto suolo, fabbricati, immobili', 
            document.getElementById('temp_immobili').value,
            document.getElementById('temp_immobili_0').value,
            document.getElementById('temp_immobili_1').value,
            document.getElementById('temp_immobili_2').value,
            document.getElementById('temp_immobili_tot').textContent],
        ['Opere murarie e assimilabili', 
            document.getElementById('temp_opere').value,
            document.getElementById('temp_opere_0').value,
            document.getElementById('temp_opere_1').value,
            document.getElementById('temp_opere_2').value,
            document.getElementById('temp_opere_tot').textContent],
        ['Programmi informatici', 
            document.getElementById('temp_software').value,
            document.getElementById('temp_software_0').value,
            document.getElementById('temp_software_1').value,
            document.getElementById('temp_software_2').value,
            document.getElementById('temp_software_tot').textContent],
        ['Macchinari, impianti, arredi', 
            document.getElementById('temp_macchinari').value,
            document.getElementById('temp_macchinari_0').value,
            document.getElementById('temp_macchinari_1').value,
            document.getElementById('temp_macchinari_2').value,
            document.getElementById('temp_macchinari_tot').textContent],
        ['TOTALE', 
            document.getElementById('temp_tot_importo').textContent,
            document.getElementById('temp_tot_0').textContent,
            document.getElementById('temp_tot_1').textContent,
            document.getElementById('temp_tot_2').textContent,
            document.getElementById('temp_tot_finale').textContent]
    ];
    
    const wsTempistica = XLSX.utils.aoa_to_sheet(dataTempistica);
    
    wsTempistica['!cols'] = [
        {wch: 40}, // Descrizione
        {wch: 18}, // Importo
        {wch: 15}, // Anno 0
        {wch: 15}, // Anno 1
        {wch: 15}, // Anno 2
        {wch: 15}  // Totale
    ];
    
    XLSX.utils.book_append_sheet(wb, wsTempistica, 'Tempistica');
    
    // Salva il file
    XLSX.writeFile(wb, 'Quadro_H_Completo.xlsx');
}

        function exportQuadroL() {
    const wb = XLSX.utils.book_new();
    
    // ========== FOGLIO 1: CONTO ECONOMICO ==========
    const dataCE = [
        ['QUADRO L - DATI DI BILANCIO (importi in migliaia di euro)', '', '', '', ''],
        ['', '', '', '', ''],
        ['CONTO ECONOMICO', 'Es. Precedente', '202x', '202x+1', '202x+2'],
        ['Fatturato', 
            document.getElementById('l_fatt_prec').value,
            document.getElementById('l_fatt_0').value,
            document.getElementById('l_fatt_1').value,
            document.getElementById('l_fatt_2').value],
        ['Altri ricavi', 
            document.getElementById('l_altri_ric_prec').value,
            document.getElementById('l_altri_ric_0').value,
            document.getElementById('l_altri_ric_1').value,
            document.getElementById('l_altri_ric_2').value],
        ['Valore della produzione', 
            document.getElementById('l_val_prod_prec').textContent,
            document.getElementById('l_val_prod_0').textContent,
            document.getElementById('l_val_prod_1').textContent,
            document.getElementById('l_val_prod_2').textContent],
        ['Acquisto materie prime e sussidiarie', 
            document.getElementById('l_materie_prec').value,
            document.getElementById('l_materie_0').value,
            document.getElementById('l_materie_1').value,
            document.getElementById('l_materie_2').value],
        ['Variazione rimanenze', 
            document.getElementById('l_rimanenze_prec').value,
            document.getElementById('l_rimanenze_0').value,
            document.getElementById('l_rimanenze_1').value,
            document.getElementById('l_rimanenze_2').value],
        ['Servizi e Godimento beni di terzi', 
            document.getElementById('l_servizi_prec').value,
            document.getElementById('l_servizi_0').value,
            document.getElementById('l_servizi_1').value,
            document.getElementById('l_servizi_2').value],
        ['Personale', 
            document.getElementById('l_personale_prec').value,
            document.getElementById('l_personale_0').value,
            document.getElementById('l_personale_1').value,
            document.getElementById('l_personale_2').value],
        ['MOL', 
            document.getElementById('l_mol_prec').textContent,
            document.getElementById('l_mol_0').textContent,
            document.getElementById('l_mol_1').textContent,
            document.getElementById('l_mol_2').textContent],
        ['Svalutazioni e accantonamenti', 
            document.getElementById('l_svalutazioni_prec').value,
            document.getElementById('l_svalutazioni_0').value,
            document.getElementById('l_svalutazioni_1').value,
            document.getElementById('l_svalutazioni_2').value],
        ['EBITDA', 
            document.getElementById('l_ebitda_prec').textContent,
            document.getElementById('l_ebitda_0').textContent,
            document.getElementById('l_ebitda_1').textContent,
            document.getElementById('l_ebitda_2').textContent],
        ['Ammortamenti imm. Immateriali', 
            document.getElementById('l_amm_imm_prec').value,
            document.getElementById('l_amm_imm_0').value,
            document.getElementById('l_amm_imm_1').value,
            document.getElementById('l_amm_imm_2').value],
        ['Ammortamenti imm. Materiali', 
            document.getElementById('l_amm_mat_prec').value,
            document.getElementById('l_amm_mat_0').value,
            document.getElementById('l_amm_mat_1').value,
            document.getElementById('l_amm_mat_2').value],
        ['Risultato Operativo (EBIT)', 
            document.getElementById('l_ris_op_prec').textContent,
            document.getElementById('l_ris_op_0').textContent,
            document.getElementById('l_ris_op_1').textContent,
            document.getElementById('l_ris_op_2').textContent],
        ['(+/-) Gestione finanziaria', 
            document.getElementById('l_gest_fin_prec').value,
            document.getElementById('l_gest_fin_0').value,
            document.getElementById('l_gest_fin_1').value,
            document.getElementById('l_gest_fin_2').value],
        ['(+/-) Gestione straordinaria', 
            document.getElementById('l_gest_str_prec').value,
            document.getElementById('l_gest_str_0').value,
            document.getElementById('l_gest_str_1').value,
            document.getElementById('l_gest_str_2').value],
        ['Risultato lordo', 
            document.getElementById('l_ris_lordo_prec').textContent,
            document.getElementById('l_ris_lordo_0').textContent,
            document.getElementById('l_ris_lordo_1').textContent,
            document.getElementById('l_ris_lordo_2').textContent],
        ['Imposte sul reddito', 
            document.getElementById('l_imposte_prec').value,
            document.getElementById('l_imposte_0').value,
            document.getElementById('l_imposte_1').value,
            document.getElementById('l_imposte_2').value],
        ['Risultato netto', 
            document.getElementById('l_ris_netto_prec').textContent,
            document.getElementById('l_ris_netto_0').textContent,
            document.getElementById('l_ris_netto_1').textContent,
            document.getElementById('l_ris_netto_2').textContent]
    ];
    
    const wsCE = XLSX.utils.aoa_to_sheet(dataCE);
    wsCE['!cols'] = [{wch: 35}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, wsCE, 'Conto Economico');
    
    // ========== FOGLIO 2: STATO PATRIMONIALE - ATTIVO ==========
    const dataAttivo = [
        ['STATO PATRIMONIALE - ATTIVO (importi in migliaia di euro)', '', '', '', ''],
        ['', '', '', '', ''],
        ['ATTIVO', 'Es. Precedente', '202x', '202x+1', '202x+2'],
        ['Immobilizzazioni immateriali', 
            document.getElementById('sp_imm_imm_prec').value,
            document.getElementById('sp_imm_imm_0').value,
            document.getElementById('sp_imm_imm_1').value,
            document.getElementById('sp_imm_imm_2').value],
        ['Tot. Immobilizzazioni Immateriali nette', 
            document.getElementById('sp_tot_imm_prec').textContent,
            document.getElementById('sp_tot_imm_0').textContent,
            document.getElementById('sp_tot_imm_1').textContent,
            document.getElementById('sp_tot_imm_2').textContent],
        ['Terreni e fabbricati', 
            document.getElementById('sp_terreni_prec').value,
            document.getElementById('sp_terreni_0').value,
            document.getElementById('sp_terreni_1').value,
            document.getElementById('sp_terreni_2').value],
        ['Impianti e macchinari', 
            document.getElementById('sp_impianti_prec').value,
            document.getElementById('sp_impianti_0').value,
            document.getElementById('sp_impianti_1').value,
            document.getElementById('sp_impianti_2').value],
        ['Attrezzature, arredi e altri beni', 
            document.getElementById('sp_attrezzature_prec').value,
            document.getElementById('sp_attrezzature_0').value,
            document.getElementById('sp_attrezzature_1').value,
            document.getElementById('sp_attrezzature_2').value],
        ['Tot. Immobilizzazioni Materiali nette', 
            document.getElementById('sp_tot_mat_prec').textContent,
            document.getElementById('sp_tot_mat_0').textContent,
            document.getElementById('sp_tot_mat_1').textContent,
            document.getElementById('sp_tot_mat_2').textContent],
        ['Partecipazioni', 
            document.getElementById('sp_partec_prec').value,
            document.getElementById('sp_partec_0').value,
            document.getElementById('sp_partec_1').value,
            document.getElementById('sp_partec_2').value],
        ['Altri titoli immobilizzati', 
            document.getElementById('sp_titoli_prec').value,
            document.getElementById('sp_titoli_0').value,
            document.getElementById('sp_titoli_1').value,
            document.getElementById('sp_titoli_2').value],
        ['Tot. Immobilizzazioni Finanziarie', 
            document.getElementById('sp_tot_fin_prec').textContent,
            document.getElementById('sp_tot_fin_0').textContent,
            document.getElementById('sp_tot_fin_1').textContent,
            document.getElementById('sp_tot_fin_2').textContent],
        ['TOTALE ATTIVO FISSO', 
            document.getElementById('sp_att_fisso_prec').textContent,
            document.getElementById('sp_att_fisso_0').textContent,
            document.getElementById('sp_att_fisso_1').textContent,
            document.getElementById('sp_att_fisso_2').textContent],
        ['Crediti', 
            document.getElementById('sp_crediti_prec').value,
            document.getElementById('sp_crediti_0').value,
            document.getElementById('sp_crediti_1').value,
            document.getElementById('sp_crediti_2').value],
        ['Disponibilit√† liquide', 
            document.getElementById('sp_liquidita_prec').value,
            document.getElementById('sp_liquidita_0').value,
            document.getElementById('sp_liquidita_1').value,
            document.getElementById('sp_liquidita_2').value],
        ['Ratei e risconti attivi', 
            document.getElementById('sp_ratei_att_prec').value,
            document.getElementById('sp_ratei_att_0').value,
            document.getElementById('sp_ratei_att_1').value,
            document.getElementById('sp_ratei_att_2').value],
        ['TOTALE ATTIVO CIRCOLANTE', 
            document.getElementById('sp_att_circ_prec').textContent,
            document.getElementById('sp_att_circ_0').textContent,
            document.getElementById('sp_att_circ_1').textContent,
            document.getElementById('sp_att_circ_2').textContent],
        ['TOTALE ATTIVO', 
            document.getElementById('sp_totale_att_prec').textContent,
            document.getElementById('sp_totale_att_0').textContent,
            document.getElementById('sp_totale_att_1').textContent,
            document.getElementById('sp_totale_att_2').textContent]
    ];
    
    const wsAttivo = XLSX.utils.aoa_to_sheet(dataAttivo);
    wsAttivo['!cols'] = [{wch: 40}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, wsAttivo, 'Stato Patrimoniale - Attivo');
    
    // ========== FOGLIO 3: STATO PATRIMONIALE - PASSIVO ==========
    const dataPassivo = [
        ['STATO PATRIMONIALE - PASSIVO E NETTO (importi in migliaia di euro)', '', '', '', ''],
        ['', '', '', '', ''],
        ['PASSIVO E NETTO', 'Es. Precedente', '202x', '202x+1', '202x+2'],
        ['Capitale sociale', 
            document.getElementById('sp_capitale_prec').value,
            document.getElementById('sp_capitale_0').value,
            document.getElementById('sp_capitale_1').value,
            document.getElementById('sp_capitale_2').value],
        ['Riserve', 
            document.getElementById('sp_riserve_prec').value,
            document.getElementById('sp_riserve_0').value,
            document.getElementById('sp_riserve_1').value,
            document.getElementById('sp_riserve_2').value],
        ['Utili (perdite)', 
            document.getElementById('sp_utili_prec').value,
            document.getElementById('sp_utili_0').value,
            document.getElementById('sp_utili_1').value,
            document.getElementById('sp_utili_2').value],
        ['PATRIMONIO NETTO', 
            document.getElementById('sp_patr_netto_prec').textContent,
            document.getElementById('sp_patr_netto_0').textContent,
            document.getElementById('sp_patr_netto_1').textContent,
            document.getElementById('sp_patr_netto_2').textContent],
        ['Fondo indennit√† TFR', 
            document.getElementById('sp_tfr_prec').value,
            document.getElementById('sp_tfr_0').value,
            document.getElementById('sp_tfr_1').value,
            document.getElementById('sp_tfr_2').value],
        ['Altri fondi rischi e oneri', 
            document.getElementById('sp_fondi_prec').value,
            document.getElementById('sp_fondi_0').value,
            document.getElementById('sp_fondi_1').value,
            document.getElementById('sp_fondi_2').value],
        ['FONDI', 
            document.getElementById('sp_tot_fondi_prec').textContent,
            document.getElementById('sp_tot_fondi_0').textContent,
            document.getElementById('sp_tot_fondi_1').textContent,
            document.getElementById('sp_tot_fondi_2').textContent],
        ['Debiti m/l termine', 
            document.getElementById('sp_debiti_mlt_prec').value,
            document.getElementById('sp_debiti_mlt_0').value,
            document.getElementById('sp_debiti_mlt_1').value,
            document.getElementById('sp_debiti_mlt_2').value],
        ['PASSIVITA\' CONSOLIDATE', 
            document.getElementById('sp_pass_cons_prec').textContent,
            document.getElementById('sp_pass_cons_0').textContent,
            document.getElementById('sp_pass_cons_1').textContent,
            document.getElementById('sp_pass_cons_2').textContent],
        ['Debiti breve termine', 
            document.getElementById('sp_debiti_bt_prec').value,
            document.getElementById('sp_debiti_bt_0').value,
            document.getElementById('sp_debiti_bt_1').value,
            document.getElementById('sp_debiti_bt_2').value],
        ['Debiti v/fornitori', 
            document.getElementById('sp_fornitori_prec').value,
            document.getElementById('sp_fornitori_0').value,
            document.getElementById('sp_fornitori_1').value,
            document.getElementById('sp_fornitori_2').value],
        ['Ratei e risconti passivi', 
            document.getElementById('sp_ratei_pass_prec').value,
            document.getElementById('sp_ratei_pass_0').value,
            document.getElementById('sp_ratei_pass_1').value,
            document.getElementById('sp_ratei_pass_2').value],
        ['PASSIVITA\' CORRENTI', 
            document.getElementById('sp_pass_corr_prec').textContent,
            document.getElementById('sp_pass_corr_0').textContent,
            document.getElementById('sp_pass_corr_1').textContent,
            document.getElementById('sp_pass_corr_2').textContent],
        ['TOTALE PASSIVO', 
            document.getElementById('sp_totale_pass_prec').textContent,
            document.getElementById('sp_totale_pass_0').textContent,
            document.getElementById('sp_totale_pass_1').textContent,
            document.getElementById('sp_totale_pass_2').textContent]
    ];
    
    const wsPassivo = XLSX.utils.aoa_to_sheet(dataPassivo);
    wsPassivo['!cols'] = [{wch: 40}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}];
    XLSX.utils.book_append_sheet(wb, wsPassivo, 'Stato Patrimoniale - Passivo');
    
    // Salva il file
    XLSX.writeFile(wb, 'Quadro_L_Completo.xlsx');
}

        function exportPDF() {
            alert('Funzione PDF: usa Stampa ‚Üí Salva come PDF dal browser');
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const data = [
                ['Riepilogo Business Plan', ''],
                ['Denominazione', document.getElementById('denominazioneCliente').value || '-'],
                ['Investimento Totale', document.getElementById('investimentoTotale').value || '0'],
                ['Fatturato Totale', risultati.fatturatoTotale || 0],
                ['ROS (%)', risultati.ros ? risultati.ros.toFixed(2) : 0],
                ['ROI (%)', risultati.roi ? risultati.roi.toFixed(2) : 0],
                ['Punteggio Totale', document.getElementById('punteggioTotale').textContent || 0]
            ];
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Riepilogo');
            XLSX.writeFile(wb, 'business_plan_completo.xlsx');
        }

        // ========== INIT ==========
document.addEventListener('DOMContentLoaded', function() {
    parseComuniCsv();
    populateComuneSelect();
    
    // ========== LISTENER OCCUPAZIONE CAMERE (NUOVA LOGICA) ==========
    // Campi che influenzano il calcolo dell'occupazione
    const campiOccupazione = [
        'numCamere',           // o 'numeroCamere' se usi questo ID
        'giorniApertura',
        'giorniAlta',
        'camereAlta',          // NUOVO: input camere vendute
        'giorniMedia',
        'camereMedia',         // NUOVO: input camere vendute
        'giorniBassa',
        'camereBassa'          // NUOVO: input camere vendute
    ];
    
    campiOccupazione.forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.addEventListener('input', calcolaOccupazione);
            console.log(`‚úì Listener aggiunto a ${id}`);
        } else {
            console.warn(`‚ö†Ô∏è Elemento non trovato: ${id}`);
        }
    });
    
    // ========== LISTENER FATTURATO ==========
    ['adr', 'fattRistorazione', 'altriRicavi'].forEach(id => {
        const elemento = document.getElementById(id);
        if (elemento) {
            elemento.addEventListener('input', calcolaFatturatoTotale);
        }
    });
    
    // ========== LISTENER COMUNE ==========
    const comuneSelect = document.getElementById('comuneSelect');
    if (comuneSelect) {
        comuneSelect.addEventListener('change', applyLocalizzazioneLookup);
    }
    
    // ========== CALCOLI INIZIALI ==========
    console.log('üöÄ Esecuzione calcoli iniziali...');
    
    if (typeof calcolaOccupazione === 'function') {
        calcolaOccupazione();
        console.log('‚úì calcolaOccupazione() eseguita');
    } else {
        console.error('‚úó Funzione calcolaOccupazione non trovata');
    }
    
    if (typeof calcolaFatturatoTotale === 'function') {
        calcolaFatturatoTotale();
        console.log('‚úì calcolaFatturatoTotale() eseguita');
    }
    
    if (typeof updateFormVisibility === 'function') {
        updateFormVisibility();
        console.log('‚úì updateFormVisibility() eseguita');
    }
    
    if (typeof applyLocalizzazioneLookup === 'function') {
        applyLocalizzazioneLookup();
        console.log('‚úì applyLocalizzazioneLookup() eseguita');
    }
    
    console.log('‚úÖ Inizializzazione completata');
});
function calcolaDettaglioInvestimenti() {
    console.log('üöÄ Inizio calcolaDettaglioInvestimenti()');
    
    const voci = ['edile', 'impianti', 'macchinari', 'attrezzature', 'arredi', 'tecniche', 'consulenze', 'informatiche'];
    
    let totInvestimento = 0;
    let totIva = 0;
    let totTotale = 0;
    let totAmmesso = 0;
    let totContributo = 0;
    
    // ========== STEP 1: LEGGI TUTTI I VALORI E CALCOLA TOTALI ==========
    console.log('üìä STEP 1: Leggo valori input...');
    
    let investimentiProposti = {};
    
    voci.forEach(voce => {
        // Leggi investimento (al netto IVA)
        const investimentoInput = document.getElementById(`inv_${voce}_investimento`);
        const ivaInput = document.getElementById(`inv_${voce}_iva`);
        
        const investimento = investimentoInput ? (parseFloat(investimentoInput.value) || 0) : 0;
        const iva = ivaInput ? (parseFloat(ivaInput.value) || 0) : 0;
        const totale = investimento + iva;
        
        console.log(`  ${voce}: investimento=${investimento}, iva=${iva}, totale=${totale}`);
        
        // AGGIORNA SUBITO IL TOTALE
        const totaleCell = document.getElementById(`inv_${voce}_totale`);
        if (totaleCell) {
            totaleCell.textContent = totale.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            console.log(`  ‚úì ${voce} totale aggiornato: ${totaleCell.textContent}`);
        } else {
            console.error(`  ‚úó Cella inv_${voce}_totale NON TROVATA`);
        }
        
        investimentiProposti[voce] = investimento;
        totInvestimento += investimento;
        totIva += iva;
        totTotale += totale;
    });
    
    console.log(`Totale investimento proposto: ${totInvestimento}`);
    
    // ========== STEP 2: CALCOLA LIMITI ==========
    console.log('üìè STEP 2: Calcolo limiti...');
    
    const limiti = {
        edile: 70,
        tecniche: 4,
        consulenze: 2,
        informatiche: 20
    };
    
    let limiti_calcolati = {};
    Object.keys(limiti).forEach(voce => {
        limiti_calcolati[voce] = (totInvestimento * limiti[voce] / 100);
        console.log(`  Limite ${voce}: ${limiti_calcolati[voce].toFixed(2)} (${limiti[voce]}% di ${totInvestimento})`);
    });
    
    // ========== STEP 3: CALCOLA IMPORTI AMMESSI ==========
    console.log('‚úÖ STEP 3: Calcolo importi ammessi...');
    
    let importiAmmessi = {};
    let errori = [];
    
    voci.forEach(voce => {
        const investimento = investimentiProposti[voce];
        let importoAmmesso = investimento; // Default: tutto ammesso
        
        // Applica limiti solo se esistono per questa voce
        if (voce !== 'attrezzature' && limiti[voce]) {
            const maxAmmissibile = limiti_calcolati[voce];
            
            if (investimento > maxAmmissibile) {
                importoAmmesso = maxAmmissibile;
                console.log(`  ${voce}: RIDOTTO da ${investimento.toFixed(2)} a ${importoAmmesso.toFixed(2)}`);
                
                const percRichiesta = totInvestimento > 0 ? (investimento / totInvestimento * 100) : 0;
                const nomeVoce = voce.charAt(0).toUpperCase() + voce.slice(1);
                
                errori.push({
                    voce: nomeVoce,
                    richiesto: investimento,
                    ammesso: maxAmmissibile,
                    percRichiesta: percRichiesta,
                    limite: limiti[voce]
                });
            } else {
                console.log(`  ${voce}: OK - ${importoAmmesso.toFixed(2)} (entro limite)`);
            }
        } else {
            console.log(`  ${voce}: ${importoAmmesso.toFixed(2)} (no limite)`);
        }
        
        importiAmmessi[voce] = importoAmmesso;
        totAmmesso += importoAmmesso;
        
        // AGGIORNA SUBITO LA CELLA AMMESSO
        const ammessoCell = document.getElementById(`inv_${voce}_ammesso`);
        if (ammessoCell) {
            ammessoCell.textContent = importoAmmesso.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Colora la cella
            if (investimento > importoAmmesso + 0.01) {
                ammessoCell.style.background = '#fff3cd';
                ammessoCell.style.color = '#856404';
            } else {
                ammessoCell.style.background = '#f0fff0';
                ammessoCell.style.color = '#155724';
            }
            
            console.log(`  ‚úì ${voce} ammesso aggiornato: ${ammessoCell.textContent}`);
        } else {
            console.error(`  ‚úó Cella inv_${voce}_ammesso NON TROVATA`);
        }
    });
    
    console.log(`Totale ammesso: ${totAmmesso}`);
        // ========== STEP 3.5: CALCOLA CONTRIBUTO AUTOMATICO ==========
    console.log('üí∞ STEP 3.5: Calcolo contributo automatico...');
    
    const modalitaContributo = document.getElementById('modalitaContributo');
    const regime = document.getElementById('regimeAiuto');
    
    if (modalitaContributo && regime && regime.value) {
        let intensitaMassima = 0;
        let contributoMin = 0;
        let contributoMax = 0;
        
        // Determina parametri in base al regime
        if (regime.value === 'de_minimis') {
            intensitaMassima = 80;
            contributoMin = 50000;
            contributoMax = 300000;
            console.log('  Regime: De Minimis (80%, min 50k, max 300k)');
        } else if (regime.value === 'gber') {
            const dimensioneEl = document.getElementById('dimensioneImpresa');
            const dimensione = dimensioneEl ? dimensioneEl.value : 'mpi';
            
            if (dimensione === 'mpi') {
                intensitaMassima = 60;
                console.log('  Regime: GBER Micro/Piccola (60%)');
            } else if (dimensione === 'media') {
                intensitaMassima = 50;
                console.log('  Regime: GBER Media (50%)');
            } else if (dimensione === 'grande') {
                intensitaMassima = 40;
                console.log('  Regime: GBER Grande (40%)');
            }
            
            contributoMin = 0;
            contributoMax = 3500000;
        }
        
        let contributoCalcolato = 0;
        
        if (modalitaContributo.value === 'automatico') {
            console.log('  Modalit√†: AUTOMATICO - Applico intensit√† massima');
            
            // CALCOLO AUTOMATICO: Applica intensit√† massima
            voci.forEach(voce => {
                const ammesso = importiAmmessi[voce];
                const contributo = ammesso * intensitaMassima / 100;
                
                const inputContributo = document.getElementById(`inv_${voce}_contributo`);
                if (inputContributo) {
                    inputContributo.value = contributo.toFixed(2);
                    inputContributo.readOnly = true;
                    inputContributo.style.background = '#f0f0f0';
                    inputContributo.style.cursor = 'not-allowed';
                    
                    console.log(`    ${voce}: ammesso=${ammesso.toFixed(2)} ‚Üí contributo=${contributo.toFixed(2)}`);
                }
                
                contributoCalcolato += contributo;
            });
            
            console.log(`  Contributo totale calcolato: ${contributoCalcolato.toFixed(2)}`);
            
            // Verifica massimale e riduce se necessario
            const alertRegime = document.getElementById('alert_regime');
            const alertRegimeOk = document.getElementById('alert_regime_ok');
            const alertRegimeMsg = document.getElementById('alert_regime_msg');
            const alertRegimeOkMsg = document.getElementById('alert_regime_ok_msg');
            
            if (contributoCalcolato > contributoMax && contributoMax > 0) {
                console.log(`  ‚ö†Ô∏è Contributo supera massimale ${contributoMax}`);
                
                const fattoreRiduzione = contributoMax / contributoCalcolato;
                const contributoOriginale = contributoCalcolato;
                contributoCalcolato = 0;
                
                voci.forEach(voce => {
                    const ammesso = importiAmmessi[voce];
                    const contributoBase = ammesso * intensitaMassima / 100;
                    const contributoRidotto = contributoBase * fattoreRiduzione;
                    
                    const inputContributo = document.getElementById(`inv_${voce}_contributo`);
                    if (inputContributo) {
                        inputContributo.value = contributoRidotto.toFixed(2);
                    }
                    
                    contributoCalcolato += contributoRidotto;
                });
                
                console.log(`  Contributo ridotto a: ${contributoCalcolato.toFixed(2)}`);
                
                if (alertRegime && alertRegimeMsg) {
                    alertRegime.style.display = 'block';
                    if (alertRegimeOk) alertRegimeOk.style.display = 'none';
                    alertRegimeMsg.innerHTML = 
                        `Il contributo calcolato (‚Ç¨${contributoOriginale.toLocaleString('it-IT', {minimumFractionDigits: 2})}) ` +
                        `supera il massimale di ‚Ç¨${contributoMax.toLocaleString('it-IT')}. ` +
                        `<br>Contributo ridotto automaticamente a ‚Ç¨${contributoCalcolato.toLocaleString('it-IT', {minimumFractionDigits: 2})} ` +
                        `(intensit√† effettiva: ${(contributoCalcolato / totAmmesso * 100).toFixed(2)}%)`;
                }
            } else if (regime.value === 'de_minimis' && contributoCalcolato < contributoMin && contributoCalcolato > 0) {
                console.log(`  ‚ö†Ô∏è Contributo sotto minimo ${contributoMin}`);
                
                if (alertRegime && alertRegimeMsg) {
                    alertRegime.style.display = 'block';
                    if (alertRegimeOk) alertRegimeOk.style.display = 'none';
                    alertRegimeMsg.innerHTML = 
                        `Il contributo calcolato (‚Ç¨${contributoCalcolato.toLocaleString('it-IT', {minimumFractionDigits: 2})}) ` +
                        `√® inferiore al minimo di ‚Ç¨${contributoMin.toLocaleString('it-IT')} richiesto dal regime De Minimis.`;
                }
            } else if (contributoCalcolato > 0) {
                console.log(`  ‚úÖ Contributo OK`);
                
                if (alertRegime) alertRegime.style.display = 'none';
                if (alertRegimeOk && alertRegimeOkMsg) {
                    alertRegimeOk.style.display = 'block';
                    alertRegimeOkMsg.textContent = 
                        `Intensit√† ${intensitaMassima}% applicata correttamente. ` +
                        `Contributo: ‚Ç¨${contributoCalcolato.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
                }
            }
        } else {
            console.log('  Modalit√†: MANUALE - Abilito input');
            
            // MODALIT√Ä MANUALE: Abilita input e valida
            voci.forEach(voce => {
                const inputContributo = document.getElementById(`inv_${voce}_contributo`);
                if (inputContributo) {
                    inputContributo.readOnly = false;
                    inputContributo.style.background = 'white';
                    inputContributo.style.cursor = 'text';
                    
                    const contributo = parseFloat(inputContributo.value) || 0;
                    contributoCalcolato += contributo;
                }
            });
            
            console.log(`  Contributo totale manuale: ${contributoCalcolato.toFixed(2)}`);
            
            // VALIDAZIONE contributo manuale
            const intensitaEffettiva = totAmmesso > 0 ? (contributoCalcolato / totAmmesso * 100) : 0;
            let erroriRegime = [];
            
            const alertRegime = document.getElementById('alert_regime');
            const alertRegimeOk = document.getElementById('alert_regime_ok');
            const alertRegimeMsg = document.getElementById('alert_regime_msg');
            const alertRegimeOkMsg = document.getElementById('alert_regime_ok_msg');
            
            // Verifica intensit√† massima
            if (intensitaEffettiva > intensitaMassima && contributoCalcolato > 0) {
                erroriRegime.push(
                    `Intensit√† effettiva ${intensitaEffettiva.toFixed(2)}% supera il massimo ${intensitaMassima}% consentito dal regime`
                );
                console.log(`  ‚ö†Ô∏è ${erroriRegime[erroriRegime.length - 1]}`);
            }
            
            // Verifica massimale
            if (contributoCalcolato > contributoMax && contributoMax > 0) {
                erroriRegime.push(
                    `Contributo ‚Ç¨${contributoCalcolato.toLocaleString('it-IT', {minimumFractionDigits: 2})} ` +
                    `supera il massimale di ‚Ç¨${contributoMax.toLocaleString('it-IT')}`
                );
                console.log(`  ‚ö†Ô∏è ${erroriRegime[erroriRegime.length - 1]}`);
            }
            
            // Verifica minimo (solo de minimis)
            if (regime.value === 'de_minimis' && contributoCalcolato < contributoMin && contributoCalcolato > 0) {
                erroriRegime.push(
                    `Contributo ‚Ç¨${contributoCalcolato.toLocaleString('it-IT', {minimumFractionDigits: 2})} ` +
                    `√® inferiore al minimo di ‚Ç¨${contributoMin.toLocaleString('it-IT')}`
                );
                console.log(`  ‚ö†Ô∏è ${erroriRegime[erroriRegime.length - 1]}`);
            }
            
            if (erroriRegime.length > 0) {
                if (alertRegime && alertRegimeMsg) {
                    alertRegime.style.display = 'block';
                    if (alertRegimeOk) alertRegimeOk.style.display = 'none';
                    alertRegimeMsg.innerHTML = erroriRegime.join('<br>');
                }
            } else if (contributoCalcolato > 0) {
                if (alertRegime) alertRegime.style.display = 'none';
                if (alertRegimeOk && alertRegimeOkMsg) {
                    alertRegimeOk.style.display = 'block';
                    alertRegimeOkMsg.textContent = 
                        `Contributo conforme al regime selezionato (Intensit√†: ${intensitaEffettiva.toFixed(2)}%)`;
                }
                console.log(`  ‚úÖ Contributo manuale OK`);
            }
        }
    } else {
        console.log('  ‚ö†Ô∏è Regime non selezionato o modalit√† non disponibile');
    }
    // ========== STEP 4: CALCOLA PERCENTUALI ==========
    console.log('üìä STEP 4: Calcolo percentuali...');
    
    voci.forEach(voce => {
        const investimento = investimentiProposti[voce];
        const percCell = document.getElementById(`inv_${voce}_perc`);
        const row = document.getElementById(`row_${voce}`);
        
        if (totInvestimento > 0) {
            const perc = (investimento / totInvestimento * 100);
            
            if (voce !== 'attrezzature') {
                if (percCell) percCell.textContent = perc.toFixed(2) + '%';
                
                if (limiti[voce] && perc > limiti[voce]) {
                    if (percCell) {
                        percCell.style.color = '#721c24';
                        percCell.style.fontWeight = 'bold';
                    }
                    if (row) row.style.background = '#f8d7da';
                } else if (perc > 0) {
                    if (percCell) {
                        percCell.style.color = '#155724';
                        percCell.style.fontWeight = 'bold';
                    }
                    if (row) row.style.background = '#d4edda';
                } else {
                    if (percCell) {
                        percCell.style.color = '#666';
                        percCell.style.fontWeight = 'normal';
                    }
                    if (row) row.style.background = 'white';
                }
            } else {
                if (percCell) percCell.textContent = perc.toFixed(2) + '%';
                if (percCell) {
                    percCell.style.color = '#666';
                    percCell.style.fontWeight = 'normal';
                }
                if (row) row.style.background = perc > 0 ? '#f8f9fa' : 'white';
            }
        } else {
            if (percCell) percCell.textContent = '0%';
            if (row) row.style.background = 'white';
        }
    });
    
    // ========== STEP 5: LEGGI CONTRIBUTI E CALCOLA TOTALE ==========
    console.log('üí∞ STEP 5: Calcolo contributi...');
    
    voci.forEach(voce => {
        const contributoInput = document.getElementById(`inv_${voce}_contributo`);
        const contributo = contributoInput ? (parseFloat(contributoInput.value) || 0) : 0;
        totContributo += contributo;
    });
    
    // ========== STEP 6: AGGIORNA TOTALI GENERALI ==========
    console.log('üìã STEP 6: Aggiorno totali...');
    
    const totInvEl = document.getElementById('inv_tot_investimento');
    const totIvaEl = document.getElementById('inv_tot_iva');
    const totTotaleEl = document.getElementById('inv_tot_totale');
    const totAmmessoEl = document.getElementById('inv_tot_ammesso');
    const totContributoEl = document.getElementById('inv_tot_contributo');
    
    if (totInvEl) {
        totInvEl.textContent = totInvestimento.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úì Totale investimento aggiornato');
    }
    
    if (totIvaEl) {
        totIvaEl.textContent = totIva.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úì Totale IVA aggiornato');
    }
    
    if (totTotaleEl) {
        totTotaleEl.textContent = totTotale.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úì Totale con IVA aggiornato');
    }
    
    if (totAmmessoEl) {
        totAmmessoEl.textContent = totAmmesso.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úì Totale ammesso aggiornato');
    }
    
    if (totContributoEl) {
        totContributoEl.textContent = totContributo.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        console.log('‚úì Totale contributo aggiornato');
    }
    
    // ========== STEP 7: ALERT VALIDAZIONE LIMITI ==========
    const alertLimiti = document.getElementById('alert_limiti');
    const alertOk = document.getElementById('alert_limiti_ok');
    
    if (errori.length > 0 && alertLimiti) {
        alertLimiti.style.display = 'block';
        if (alertOk) alertOk.style.display = 'none';
        
        const ul = document.getElementById('alert_limiti_dettaglio');
        if (ul) {
            ul.innerHTML = '';
            errori.forEach(err => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${err.voce}:</strong> Richiesto ‚Ç¨${err.richiesto.toLocaleString('it-IT', {minimumFractionDigits: 2})} ` +
                              `(${err.percRichiesta.toFixed(2)}% sul totale) ‚Üí ` +
                              `Ammesso <strong>‚Ç¨${err.ammesso.toLocaleString('it-IT', {minimumFractionDigits: 2})}</strong> ` +
                              `(max ${err.limite}% di ‚Ç¨${totInvestimento.toLocaleString('it-IT', {minimumFractionDigits: 2})})`;
                ul.appendChild(li);
            });
        }
    } else if (alertLimiti) {
        alertLimiti.style.display = 'none';
        if (alertOk && totAmmesso > 0) {
            alertOk.style.display = 'block';
        }
    }
    
    // ========== STEP 8: BOX INVESTIMENTO AMMISSIBILE ==========
    const displayBox = document.getElementById('investimento_ammissibile_display');
    if (displayBox) {
        displayBox.textContent = '‚Ç¨ ' + totInvestimento.toLocaleString('it-IT', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    // ========== STEP 9: RIEPILOGO ==========
    const riepImmob = document.getElementById('riepilogo_immobiliari');
    const riepOper = document.getElementById('riepilogo_operativi');
    const riepContr = document.getElementById('riepilogo_contributo');
    
   if (riepImmob) {
    const totImmob = (importiAmmessi['edile'] || 0) + (importiAmmessi['tecniche'] || 0);
    riepImmob.textContent = '‚Ç¨' + totImmob.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
    
    if (riepOper) {
    const totOper = (importiAmmessi['impianti'] || 0) + 
                    (importiAmmessi['macchinari'] || 0) + 
                    (importiAmmessi['attrezzature'] || 0) + 
                    (importiAmmessi['arredi'] || 0) + 
                    (importiAmmessi['informatiche'] || 0) +
                    (importiAmmessi['consulenze'] || 0);
    riepOper.textContent = '‚Ç¨' + totOper.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
}
    
    if (riepContr) {
        riepContr.textContent = '‚Ç¨' + totContributo.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
    }
   console.log('üèóÔ∏è STEP 9.5: Calcolo ammortamenti e contributo c/impianti...');

let amm_immateriali_totale = 0;
let amm_materiali_totale = 0;
let quota_contributo_totale = 0;

voci.forEach(voce => {
    // ‚úÖ LEGGI L'INVESTIMENTO PROPOSTO (non l'ammesso)
    const investimento = investimentiProposti[voce];  // ‚úÖ CALCOLA SU INVESTIMENTO
    const ammesso = importiAmmessi[voce];
    const contributo = parseFloat(document.getElementById(`inv_${voce}_contributo`)?.value) || 0;
    const aliquotaEl = document.getElementById(`inv_${voce}_aliquota`);
    const aliquota = aliquotaEl ? (parseFloat(aliquotaEl.value) || 0) : 0;
    
    if (investimento > 0 && aliquota > 0) {  // ‚úÖ VERIFICA SU INVESTIMENTO
        // ‚úÖ CALCOLA AMMORTAMENTO SULL'INVESTIMENTO PROPOSTO
        const ammortamento_annuo = investimento * aliquota / 100;
        
        // Calcola quota contributo (sempre sul contributo effettivo)
        const quota_contributo = contributo * aliquota / 100;
        
        // DETERMINA LA CATEGORIA (MAT o IMM)
        let categoria = '';
        
        // Per edile e tecniche, legge dal SELECT
        if (voce === 'edile' || voce === 'tecniche') {
            const categoriaSelect = document.getElementById(`inv_${voce}_categoria`);
            categoria = categoriaSelect ? categoriaSelect.value : '';
        } else {
            // Per le altre voci, categoria fissa
            if (voce === 'impianti' || voce === 'macchinari' || voce === 'attrezzature' || voce === 'arredi') {
                categoria = 'MAT';
            } else if (voce === 'consulenze' || voce === 'informatiche') {
                categoria = 'IMM';
            }
        }
        
        console.log(`  ${voce}:`);
        console.log(`    Investimento proposto: ‚Ç¨${investimento.toFixed(2)}`);
        console.log(`    Importo ammesso: ‚Ç¨${ammesso.toFixed(2)}`);
        console.log(`    Aliquota: ${aliquota}%`);
        console.log(`    Categoria: ${categoria}`);
        console.log(`    Ammortamento annuo: ‚Ç¨${ammortamento_annuo.toFixed(2)} (su investimento)`);
        console.log(`    Contributo: ‚Ç¨${contributo.toFixed(2)}`);
        console.log(`    Quota contributo annua: ‚Ç¨${quota_contributo.toFixed(2)}`);
        
        // Classifica per categoria
        if (categoria === 'MAT') {
            amm_materiali_totale += ammortamento_annuo;
        } else if (categoria === 'IMM') {
            amm_immateriali_totale += ammortamento_annuo;
        }
        
        quota_contributo_totale += quota_contributo;
    }
});

const amm_totale = amm_immateriali_totale + amm_materiali_totale;
const contributo_residuo = totContributo - quota_contributo_totale;

console.log(`  Totale Amm. Immateriali: ‚Ç¨${amm_immateriali_totale.toFixed(2)}`);
console.log(`  Totale Amm. Materiali: ‚Ç¨${amm_materiali_totale.toFixed(2)}`);
console.log(`  Totale Ammortamenti: ‚Ç¨${amm_totale.toFixed(2)}`);
console.log(`  Quota Contributo Annua: ‚Ç¨${quota_contributo_totale.toFixed(2)}`);
console.log(`  Contributo Residuo: ‚Ç¨${contributo_residuo.toFixed(2)}`);

// Aggiorna box riepilogo
const ammImmEl = document.getElementById('amm_immateriali_calc');
const ammMatEl = document.getElementById('amm_materiali_calc');
const ammTotEl = document.getElementById('amm_totale_calc');
const quotaContribEl = document.getElementById('contributo_quota_annua');
const contributoResEl = document.getElementById('contributo_residuo');
const contributoTotCalcEl = document.getElementById('contributo_totale_calc');

if (ammImmEl) ammImmEl.textContent = '‚Ç¨' + amm_immateriali_totale.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
if (ammMatEl) ammMatEl.textContent = '‚Ç¨' + amm_materiali_totale.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
if (ammTotEl) ammTotEl.textContent = '‚Ç¨' + amm_totale.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
if (quotaContribEl) quotaContribEl.textContent = '‚Ç¨' + quota_contributo_totale.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
if (contributoResEl) contributoResEl.textContent = '‚Ç¨' + contributo_residuo.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});
if (contributoTotCalcEl) contributoTotCalcEl.textContent = '‚Ç¨' + totContributo.toLocaleString('it-IT', {minimumFractionDigits: 0, maximumFractionDigits: 0});

// Salva i valori calcolati in campi nascosti dedicati
let ammImmaterialiInvestimenti = document.getElementById('ammImmaterialiInvestimenti');
let ammMaterialiInvestimenti = document.getElementById('ammMaterialiInvestimenti');
let quotaContributoAnnua = document.getElementById('quotaContributoAnnua');
let contributoResiduoRisconti = document.getElementById('contributoResiduoRisconti');

if (!ammImmaterialiInvestimenti) {
    ammImmaterialiInvestimenti = document.createElement('input');
    ammImmaterialiInvestimenti.type = 'hidden';
    ammImmaterialiInvestimenti.id = 'ammImmaterialiInvestimenti';
    document.body.appendChild(ammImmaterialiInvestimenti);
}

if (!ammMaterialiInvestimenti) {
    ammMaterialiInvestimenti = document.createElement('input');
    ammMaterialiInvestimenti.type = 'hidden';
    ammMaterialiInvestimenti.id = 'ammMaterialiInvestimenti';
    document.body.appendChild(ammMaterialiInvestimenti);
}

if (!quotaContributoAnnua) {
    quotaContributoAnnua = document.createElement('input');
    quotaContributoAnnua.type = 'hidden';
    quotaContributoAnnua.id = 'quotaContributoAnnua';
    document.body.appendChild(quotaContributoAnnua);
}

if (!contributoResiduoRisconti) {
    contributoResiduoRisconti = document.createElement('input');
    contributoResiduoRisconti.type = 'hidden';
    contributoResiduoRisconti.id = 'contributoResiduoRisconti';
    document.body.appendChild(contributoResiduoRisconti);
}

ammImmaterialiInvestimenti.value = amm_immateriali_totale;
ammMaterialiInvestimenti.value = amm_materiali_totale;
quotaContributoAnnua.value = quota_contributo_totale;
contributoResiduoRisconti.value = contributo_residuo;

console.log('‚úÖ Ammortamenti e contributo calcolati (su investimento proposto)');
    
// ========== STEP 10: CAMPI NASCOSTI (SU IMPORTI AMMESSI) ==========
console.log('üìù STEP 10: Aggiorno campi nascosti (importi ammessi)...');

const invTotaleHidden = document.getElementById('investimentoTotale');
const invOperativiHidden = document.getElementById('investimentiOperativi');
const invImmobiliariHidden = document.getElementById('investimentiImmobiliari');
const ivaHidden = document.getElementById('ivaInvestimenti');
const contributoHidden = document.getElementById('contributoRichiesto');

// ‚úÖ Salva il totale AMMESSO (dopo applicazione limiti)
if (invTotaleHidden) {
    invTotaleHidden.value = totAmmesso;
    console.log(`‚úÖ Investimento totale ammesso: ‚Ç¨${totAmmesso.toLocaleString('it-IT')}`);
}

// ‚úÖ Calcola investimenti operativi AMMESSI (include consulenze, esclusi edile e spese tecniche)
if (invOperativiHidden) {
    const totOperativiAmmessi = (importiAmmessi['impianti'] || 0) + 
                                 (importiAmmessi['macchinari'] || 0) + 
                                 (importiAmmessi['attrezzature'] || 0) + 
                                 (importiAmmessi['arredi'] || 0) + 
                                 (importiAmmessi['informatiche'] || 0) +
                                 (importiAmmessi['consulenze'] || 0);
    
    invOperativiHidden.value = totOperativiAmmessi;
    
    console.log(`‚úÖ Investimenti operativi ammessi: ‚Ç¨${totOperativiAmmessi.toLocaleString('it-IT')}`);
    console.log(`   - Impianti (ammessi): ‚Ç¨${(importiAmmessi['impianti'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Macchinari (ammessi): ‚Ç¨${(importiAmmessi['macchinari'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Attrezzature (ammessi): ‚Ç¨${(importiAmmessi['attrezzature'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Arredi (ammessi): ‚Ç¨${(importiAmmessi['arredi'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Informatiche (ammessi): ‚Ç¨${(importiAmmessi['informatiche'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Consulenze (ammessi): ‚Ç¨${(importiAmmessi['consulenze'] || 0).toLocaleString('it-IT')}`);
    console.log(`   ESCLUSI: Parte edile, Spese tecniche`);
}

// ‚úÖ Salva investimenti immobiliari AMMESSI (edile + spese tecniche)
if (invImmobiliariHidden) {
    const totImmobAmmessi = (importiAmmessi['edile'] || 0) + (importiAmmessi['tecniche'] || 0);
    invImmobiliariHidden.value = totImmobAmmessi;
    console.log(`‚úÖ Investimenti immobiliari ammessi: ‚Ç¨${totImmobAmmessi.toLocaleString('it-IT')}`);
    console.log(`   - Parte edile: ‚Ç¨${(importiAmmessi['edile'] || 0).toLocaleString('it-IT')}`);
    console.log(`   - Spese tecniche: ‚Ç¨${(importiAmmessi['tecniche'] || 0).toLocaleString('it-IT')}`);
}

// IVA rimane sul proposto (viene pagata comunque)
if (ivaHidden) {
    ivaHidden.value = totIva;
    console.log(`‚úÖ IVA totale: ‚Ç¨${totIva.toLocaleString('it-IT')}`);
}

// Contributo calcolato
if (contributoHidden) {
    contributoHidden.value = totContributo;
    console.log(`‚úÖ Contributo richiesto: ‚Ç¨${totContributo.toLocaleString('it-IT')}`);
}

// ========== VERIFICA RAPPORTO (PER DEBUG) ==========
console.log('');
console.log('üîç VERIFICA CALCOLO RAPPORTO CRITERIO B:');
console.log(`   Investimento totale ammesso: ‚Ç¨${totAmmesso.toLocaleString('it-IT')}`);
console.log(`   Investimenti operativi ammessi: ‚Ç¨${invOperativiHidden.value.toLocaleString('it-IT')}`);

if (parseFloat(invOperativiHidden.value) > 0) {
    const rapportoB = totAmmesso / parseFloat(invOperativiHidden.value);
    console.log(`   RAPPORTO B = ${totAmmesso.toLocaleString('it-IT')} / ${invOperativiHidden.value.toLocaleString('it-IT')} = ${rapportoB.toFixed(2)}`);
    
    let punteggioPrevisto = 0;
    if (rapportoB <= 1.5) punteggioPrevisto = 20;
    else if (rapportoB <= 2.0) punteggioPrevisto = 16;
    else if (rapportoB <= 2.5) punteggioPrevisto = 10;
    else if (rapportoB <= 3.0) punteggioPrevisto = 7;
    
    console.log(`   Punteggio Criterio B previsto: ${punteggioPrevisto} punti`);
    
    if (rapportoB <= 1.5) {
        console.log(`   ‚úÖ OTTIMO: Investimenti operativi ‚â• 67% del totale`);
    } else if (rapportoB <= 2.0) {
        console.log(`   ‚úÖ BUONO: Investimenti operativi ‚â• 50% del totale`);
    } else if (rapportoB <= 3.0) {
        console.log(`   ‚ö†Ô∏è SUFFICIENTE: Investimenti operativi ‚â• 33% del totale`);
    } else {
        console.log(`   ‚ùå INSUFFICIENTE: Investimenti operativi < 33% del totale`);
    }
} else {
    console.log(`   ‚ö†Ô∏è ATTENZIONE: Nessun investimento operativo ammesso!`);
}
console.log('');

// ========== DEBUG: CONFRONTO PROPOSTI VS AMMESSI ==========
console.log('üìä CONFRONTO PROPOSTI VS AMMESSI:');
voci.forEach(voce => {
    const proposto = investimentiProposti[voce];
    const ammesso = importiAmmessi[voce];
    const diff = proposto - ammesso;
    
    if (diff > 0.01) {
        console.log(`   ${voce}: ‚Ç¨${proposto.toLocaleString('it-IT')} ‚Üí ‚Ç¨${ammesso.toLocaleString('it-IT')} (ridotto di ‚Ç¨${diff.toLocaleString('it-IT')})`);
    } else {
        console.log(`   ${voce}: ‚Ç¨${ammesso.toLocaleString('it-IT')} (‚úì tutto ammesso)`);
    }
});
// ========== DEBUG: VERIFICA INVESTIMENTI OPERATIVI ==========
console.log('üîç DEBUG INVESTIMENTI OPERATIVI:');
console.log(`   investimentiProposti oggetto completo:`, investimentiProposti);
console.log(`   - impianti: ${investimentiProposti['impianti']} (tipo: ${typeof investimentiProposti['impianti']})`);
console.log(`   - macchinari: ${investimentiProposti['macchinari']} (tipo: ${typeof investimentiProposti['macchinari']})`);
console.log(`   - attrezzature: ${investimentiProposti['attrezzature']} (tipo: ${typeof investimentiProposti['attrezzature']})`);
console.log(`   - arredi: ${investimentiProposti['arredi']} (tipo: ${typeof investimentiProposti['arredi']})`);
console.log(`   - informatiche: ${investimentiProposti['informatiche']} (tipo: ${typeof investimentiProposti['informatiche']})`);

// Verifica valori HTML
console.log('üîç DEBUG VALORI INPUT HTML:');
['impianti', 'macchinari', 'attrezzature', 'arredi', 'informatiche'].forEach(voce => {
    const input = document.getElementById(`inv_${voce}_investimento`);
    console.log(`   ${voce}: input=${input ? input.value : 'NON TROVATO'}`);
});

console.log('‚úÖ Fine calcolaDettaglioInvestimenti()');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
}
function aggiornaRegimeAiuto() {
    const regime = document.getElementById('regimeAiuto').value;
    const dimensioneGroup = document.getElementById('dimensioneImpresaGroup');
    const riepilogoBox = document.getElementById('riepilogoRegime');
    
    if (!regime) {
        riepilogoBox.style.display = 'none';
        dimensioneGroup.style.display = 'none';
        return;
    }
    
    // Mostra/nascondi dimensione impresa per GBER
    if (regime === 'gber') {
        dimensioneGroup.style.display = 'block';
    } else {
        dimensioneGroup.style.display = 'none';
    }
    
    // Aggiorna riepilogo regime
    riepilogoBox.style.display = 'block';
    
    let nomeRegime, intensita, massimale, vincoli;
    
    if (regime === 'de_minimis') {
        nomeRegime = 'De Minimis';
        intensita = '80%';
        massimale = 'min ‚Ç¨50.000 - max ‚Ç¨300.000';
        vincoli = '‚Ä¢ Contributo minimo: ‚Ç¨50.000<br>' +
                  '‚Ä¢ Contributo massimo: ‚Ç¨300.000<br>' +
                  '‚Ä¢ Limite triennale per impresa unica: ‚Ç¨300.000 (cumulo aiuti de minimis)';
    } else if (regime === 'gber') {
        const dimensione = document.getElementById('dimensioneImpresa').value;
        nomeRegime = 'In Esenzione (GBER - Art. 14)';
        
        if (dimensione === 'mpi') {
            intensita = '60%';
            nomeRegime += ' - Micro/Piccola';
        } else if (dimensione === 'media') {
            intensita = '50%';
            nomeRegime += ' - Media';
        } else if (dimensione === 'grande') {
            intensita = '40%';
            nomeRegime += ' - Grande';
        }
        
        massimale = 'max ‚Ç¨3.500.000';
        vincoli = '‚Ä¢ Contributo massimo: ‚Ç¨3.500.000<br>' +
                  '‚Ä¢ Aiuti a finalit√† regionale agli investimenti (Art. 14 Reg. 651/2014)<br>' +
                  '‚Ä¢ Intensit√† varia in base alla dimensione dell\'impresa';
    }
    
    document.getElementById('regimeNome').textContent = nomeRegime;
    document.getElementById('intensitaMassima').textContent = intensita;
    document.getElementById('contributoMassimo').textContent = massimale;
    document.getElementById('vincoliRegime').innerHTML = vincoli;
    
    // Ricalcola investimenti con nuovo regime
    calcolaDettaglioInvestimenti();
}
function verificaContributoManuale(voce) {
    console.log(`üîÑ Contributo ${voce} modificato manualmente`);
    calcolaDettaglioInvestimenti();
}
function calcolaEfficienzaSpesa() {
    const totaleInvestimento = parseFloat(document.getElementById('investimentoTotale').value) || 0;
    const importoPreventivi = parseFloat(document.getElementById('importoPreventiviVincolanti').value) || 0;
    
    const rapporto = totaleInvestimento > 0 ? (importoPreventivi / totaleInvestimento) : 0;
    document.getElementById('rapportoPreventivi').value = (rapporto * 100).toFixed(2) + '%';
    
    let punteggio = 0;
    if (rapporto > 0.85) punteggio = 10;
    else if (rapporto > 0.70) punteggio = 7;
    else if (rapporto > 0.50) punteggio = 4;
    
    document.getElementById('punteggio_d3_display').textContent = punteggio;
    document.getElementById('griglia_d3').value = punteggio;
    
    // Ricalcola punteggio totale
    if (typeof calcolaPunteggio === 'function') calcolaPunteggio();
}
function resetCompleto() {
    // Conferma prima di procedere
    if (!confirm('‚ö†Ô∏è ATTENZIONE: Questa operazione canceller√† TUTTI i dati inseriti.\n\nVuoi procedere con il reset completo?')) {
        return;
    }
    
    console.log('üîÑ INIZIO RESET COMPLETO...');
    
    try {
        // ========== RESET VARIABILI GLOBALI ==========
        risultati = {};
        
        // ========== RESET TAB 1: DATI BASE ==========
        // Informazioni Cliente
        document.getElementById('denominazioneCliente').value = '';
        document.getElementById('comuneSelect').selectedIndex = 0;
        document.getElementById('comuneLookupResult').value = '';
        
        // Regime di Aiuto
        document.getElementById('regimeAiuto').selectedIndex = 0;
        document.getElementById('dimensioneImpresa').selectedIndex = 0;
        document.getElementById('modalitaContributo').selectedIndex = 0;
        document.getElementById('dimensioneImpresaGroup').style.display = 'none';
        document.getElementById('riepilogoRegime').style.display = 'none';
        
        // Tipologia Impresa
        document.getElementById('impresaStato').selectedIndex = 0;
        document.getElementById('tipologiaStruttura').selectedIndex = 0;
        
        // Caratteristiche Struttura
        document.getElementById('numCamere').value = '0';
        document.getElementById('giorniApertura').value = '365';
        document.getElementById('dipendentiAttuali').value = '0';
        document.getElementById('dipendentiPrevisti').value = '0';
        
        // Reset Dettaglio Investimenti
        const vociInvestimento = ['edile', 'impianti', 'macchinari', 'attrezzature', 'arredi', 'tecniche', 'consulenze', 'informatiche'];
        vociInvestimento.forEach(voce => {
            const invInput = document.getElementById(`inv_${voce}_investimento`);
            const ivaInput = document.getElementById(`inv_${voce}_iva`);
            const contrInput = document.getElementById(`inv_${voce}_contributo`);
            const aliqInput = document.getElementById(`inv_${voce}_aliquota`);
            
            if (invInput) invInput.value = '0';
            if (ivaInput) ivaInput.value = '0';
            if (contrInput) {
                contrInput.value = '0';
                contrInput.readOnly = false;
                contrInput.style.background = 'white';
            }
            
            // Reset aliquote ai valori default
            if (aliqInput) {
                const defaults = {
                    'edile': 3,
                    'impianti': 10,
                    'macchinari': 12,
                    'attrezzature': 15,
                    'arredi': 12,
                    'tecniche': 20,
                    'consulenze': 20,
                    'informatiche': 20
                };
                aliqInput.value = defaults[voce] || 10;
            }
            
            // Reset categorie (per edile e tecniche)
            const catSelect = document.getElementById(`inv_${voce}_categoria`);
            if (catSelect) catSelect.selectedIndex = 0;
            
            // Reset celle calcolate
            const totCell = document.getElementById(`inv_${voce}_totale`);
            const ammCell = document.getElementById(`inv_${voce}_ammesso`);
            const percCell = document.getElementById(`inv_${voce}_perc`);
            
            if (totCell) totCell.textContent = '0,00';
            if (ammCell) {
                ammCell.textContent = '0,00';
                ammCell.style.background = '#f0fff0';
            }
            if (percCell) percCell.textContent = '0%';
        });
        
        // Reset percentuali temporali
        document.getElementById('percAnno0').value = '0';
        document.getElementById('percAnno1').value = '100';
        document.getElementById('percAnno2').value = '0';
        
        // Reset occupazione camere
        document.getElementById('giorniAlta').value = '120';
        document.getElementById('camereAlta').value = '0';
        document.getElementById('giorniMedia').value = '120';
        document.getElementById('camereMedia').value = '0';
        document.getElementById('giorniBassa').value = '125';
        document.getElementById('camereBassa').value = '0';
        
        // ========== RESET TAB 2: DATI ECONOMICI ==========
        document.getElementById('adr').value = '0';
        document.getElementById('fattRistorazione').value = '0';
        document.getElementById('altriRicavi').value = '0';
        document.getElementById('fatturatoTotale').value = '';
        
        document.getElementById('costiMaterie').value = '0';
        document.getElementById('costoPersonale').value = '0';
        document.getElementById('costiServizi').value = '0';
        document.getElementById('costiBeni').value = '0';
        document.getElementById('costiMarketing').value = '0';
        document.getElementById('speseGenerali').value = '0';
        
        document.getElementById('ammImmateriali').value = '0';
        document.getElementById('ammMateriali').value = '0';
        document.getElementById('oneriFin').value = '0';
        document.getElementById('imposte').value = '0';
        
        // Dati esercizio precedente (se attiva)
        const fattPrecEl = document.getElementById('fattPrecedente');
        const risOpPrecEl = document.getElementById('risOpPrecedente');
        const capInvPrecEl = document.getElementById('capInvPrecedente');
        if (fattPrecEl) fattPrecEl.value = '0';
        if (risOpPrecEl) risOpPrecEl.value = '0';
        if (capInvPrecEl) capInvPrecEl.value = '0';
        
// ========== RESET QUADRO H ==========
// Reset input
for (let anno = 0; anno <= 2; anno++) {
    ['h_immateriali', 'h_materiali', 'h_iva', 'h_capitale', 'h_contributo', 'h_fin_mlt', 'h_fin_bt', 'h_altre'].forEach(campo => {
        const el = document.getElementById(`${campo}_${anno}`);
        if (el) el.value = '0';
    });
}

// RESET TOTALI CALCOLATI del Quadro H
['h_immateriali_tot', 'h_materiali_tot', 'h_iva_tot', 'h_fabb_tot',
 'h_capitale_tot', 'h_contributo_tot', 'h_fin_mlt_tot', 'h_fin_bt_tot', 
 'h_altre_tot', 'h_fonti_tot'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = '0';
});

// Reset totali per anno
for (let anno = 0; anno <= 2; anno++) {
    const fabbEl = document.getElementById(`h_fabb_${anno}`);
    const fontiEl = document.getElementById(`h_fonti_${anno}`);
    if (fabbEl) fabbEl.textContent = '0';
    if (fontiEl) fontiEl.textContent = '0';
}

// Reset tabella verifica dettagliata
for (let anno = 0; anno <= 2; anno++) {
    const verifFabb = document.getElementById(`verif_fabb_${anno}`);
    const verifFonti = document.getElementById(`verif_fonti_${anno}`);
    const verifDiff = document.getElementById(`verif_diff_${anno}`);
    const verifStato = document.getElementById(`verif_stato_${anno}`);
    
    if (verifFabb) verifFabb.textContent = '-';
    if (verifFonti) verifFonti.textContent = '-';
    if (verifDiff) verifDiff.textContent = '-';
    if (verifStato) verifStato.textContent = '-';
}

// Reset totali verifica
['verif_fabb_tot', 'verif_fonti_tot', 'verif_diff_tot', 'verif_stato_tot'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.textContent = '-';
});
        // Reset tempistica
        ['consulenze', 'progettazione', 'immobili', 'opere', 'software', 'macchinari'].forEach(voce => {
            const el = document.getElementById(`temp_${voce}`);
            if (el) el.value = '0';
            
            for (let anno = 0; anno <= 2; anno++) {
                const elAnno = document.getElementById(`temp_${voce}_${anno}`);
                if (elAnno) elAnno.value = '0';
            }
        });
        
        // ========== RESET QUADRO L ==========
        const anniQuadroL = ['prec', '0', '1', '2'];
        const campiCE = ['fatt', 'altri_ric', 'materie', 'rimanenze', 'servizi', 'personale', 'svalutazioni', 
                         'amm_imm', 'amm_mat', 'gest_fin', 'gest_str', 'imposte'];
        
        anniQuadroL.forEach(anno => {
            campiCE.forEach(campo => {
                const el = document.getElementById(`l_${campo}_${anno}`);
                if (el && el.tagName === 'INPUT') el.value = '0';
            });
        });
        // RESET CAMPI CALCOLATI (textContent) del Conto Economico
            const campiCalcolatiCE = ['val_prod', 'mol', 'ebitda', 'ris_op', 'ris_lordo', 'ris_netto'];

            anniQuadroL.forEach(anno => {
                campiCalcolatiCE.forEach(campo => {
                    const el = document.getElementById(`l_${campo}_${anno}`);
                    if (el) el.textContent = '0.0';
                });
            });
        // Reset Stato Patrimoniale
        const campiSP = ['imm_imm', 'terreni', 'impianti', 'attrezzature', 'partec', 'titoli', 
                         'crediti', 'liquidita', 'ratei_att', 'capitale', 'riserve', 'utili',
                         'tfr', 'fondi', 'debiti_mlt', 'debiti_bt', 'fornitori', 'ratei_pass'];
        
        anniQuadroL.forEach(anno => {
            campiSP.forEach(campo => {
                const el = document.getElementById(`sp_${campo}_${anno}`);
                if (el && el.tagName === 'INPUT') el.value = '0';
            });
        });

                    // RESET CAMPI CALCOLATI (textContent) dello Stato Patrimoniale
            const campiCalcolatiSP = ['tot_imm', 'tot_mat', 'tot_fin', 'att_fisso', 'att_circ', 'totale_att',
                                    'patr_netto', 'tot_fondi', 'pass_cons', 'pass_corr', 'totale_pass'];

            anniQuadroL.forEach(anno => {
                campiCalcolatiSP.forEach(campo => {
                    const el = document.getElementById(`sp_${campo}_${anno}`);
                    if (el) el.textContent = '0.0';
                });
            });

            // Reset alert quadratura Stato Patrimoniale
            const alertQuadratura = document.getElementById('sp_alert_quadratura');
            const alertQuadraturaOk = document.getElementById('sp_alert_success');
            if (alertQuadratura) alertQuadratura.style.display = 'none';
            if (alertQuadraturaOk) alertQuadraturaOk.style.display = 'none';
        
        // ========== RESET TAB PUNTEGGIO ==========
        // Reset qualit√† progettuale
        const radioQualita = document.querySelectorAll('input[name="qualita_prog"]');
        radioQualita.forEach(radio => radio.checked = false);
        radioQualita[radioQualita.length - 1].checked = true; // Seleziona "Nessun intervento"
        
        // Reset sostenibilit√†
        const checkSost = document.querySelectorAll('input[name="sostenibilita"]');
        checkSost.forEach(check => check.checked = false);
        
        // Reset efficienza spesa
        document.getElementById('importoPreventiviVincolanti').value = '0';
        
        // Reset localizzazione
        document.getElementById('griglia_f').value = '0';
        document.getElementById('overrideF').checked = false;
        
        // ========== RESET VISUALIZZAZIONI ==========
        // Reset punteggi
        document.getElementById('punteggioTotale').textContent = '0';
        document.getElementById('punteggio_d_display').textContent = '0';
        document.getElementById('punteggio_e_display').textContent = '0';
        
        // Reset risultati indici
        const indiciIds = ['rosValue', 'roiValue', 'ebitdaValue', 'molValue', 'torValue', 
                           'revparValue', 'adrResultValue', 'gopparValue', 'laborValue', 
                           'prodValue', 'invOccValue', 'satValue', 'griglia_invop'];
        
        indiciIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '-';
        });
        
        // Reset status
        const statusIds = ['rosStatus', 'roiStatus', 'ebitdaStatus', 'torStatus', 
                          'laborStatus', 'prodStatus', 'invOccStatus', 'satStatus'];
        
        statusIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = '-';
                el.className = 'result-status';
            }
        });
        
        // ========== NASCONDI TUTTI GLI ALERT ==========
        const allAlerts = document.querySelectorAll('.alert');
        allAlerts.forEach(alert => {
            alert.style.display = 'none';
        });
        
        // ========== RESET CAMPI NASCOSTI ==========
        document.getElementById('investimentoTotale').value = '0';
        document.getElementById('investimentiOperativi').value = '0';
        document.getElementById('investimentiImmobiliari').value = '0';
        document.getElementById('ivaInvestimenti').value = '0';
        document.getElementById('contributoRichiesto').value = '0';
        
        // ========== TORNA AL PRIMO TAB ==========
        showTab(0);
        
        // ========== RICALCOLA VALORI INIZIALI ==========
        updateFormVisibility();
        calcolaOccupazione();
        calcolaFatturatoTotale();
        calcolaDettaglioInvestimenti();
        validaPercentuali();
        
        
        console.log('‚úÖ RESET COMPLETO ESEGUITO CON SUCCESSO');
        
        alert('‚úÖ Reset completo eseguito!\n\nTutti i dati sono stati cancellati.\nPuoi iniziare un nuovo calcolo.');
        
    } catch (error) {
        console.error('‚ùå Errore durante il reset:', error);
        alert('‚ö†Ô∏è Si √® verificato un errore durante il reset.\n\nRicarica la pagina per un reset completo.');
    }
}

// Funzioni per il footer
function segnalaBug() {
    alert('üìß Per segnalare un bug, invia una email a:\nsupporto@vnexera.com\n\nDescrivi il problema riscontrato e allega screenshot se possibile.');
}

function mostraChangelog() {
    document.getElementById('modalChangelog').style.display = 'block';
}

function mostraPrivacy() {
    alert('üîí Privacy Policy\n\nQuesto strumento non raccoglie dati personali.\nTutti i calcoli vengono eseguiti localmente nel browser.\nNessun dato viene trasmesso a server esterni.');
}

function mostraTermini() {
    alert('üìú Termini di Utilizzo\n\nQuesto strumento √® fornito "cos√¨ com\'√®" senza garanzie.\nL\'utilizzo √® a proprio rischio.\nSi consiglia di verificare sempre i calcoli con un professionista.\nNon sostituisce la consulenza professionale.');
}

function chiudiModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

// Aggiungi info browser al caricamento
document.addEventListener('DOMContentLoaded', function() {
    // ... codice esistente ...
    
    // Aggiungi info browser
    const browserInfo = document.getElementById('browserInfo');
    if (browserInfo) {
        const userAgent = navigator.userAgent;
        let browserName = 'Browser non riconosciuto';
        
        if (userAgent.indexOf('Chrome') > -1) browserName = 'Chrome';
        else if (userAgent.indexOf('Safari') > -1) browserName = 'Safari';
        else if (userAgent.indexOf('Firefox') > -1) browserName = 'Firefox';
        else if (userAgent.indexOf('Edge') > -1) browserName = 'Edge';
        
        browserInfo.textContent = `Ottimizzato per ${browserName}`;
    }
    
    // Aggiorna data ultimo update
    const lastUpdateEl = document.getElementById('lastUpdate');
    if (lastUpdateEl) {
        const oggi = new Date();
        lastUpdateEl.textContent = oggi.toLocaleDateString('it-IT');
    }
});
 </script>
<!-- FOOTER -->
<div style="margin-top: 50px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 40px 20px 20px 20px;">
    <div style="max-width: 1400px; margin: 0 auto;">
        <!-- Prima riga - Informazioni principali -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; margin-bottom: 30px;">
            <!-- Colonna 1 - About -->
            <div>
                <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">üìä Business Plan Calculator</h4>
                <p style="font-size: 13px; line-height: 1.6; opacity: 0.9;">
                    Strumento professionale per il calcolo del Business Plan conforme al 
                    Bando FSC 2021-2027 Sicilia - Agevolazioni Imprese Turistiche.
                </p>
                <p style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
                    <strong>Versione:</strong> 2.0.1<br>
                    <strong>Release:</strong> Novembre 2025<br>
                    <strong>Ultimo aggiornamento:</strong> <span id="lastUpdate">04/11/</span>
                </p>
            </div>
            
            <!-- Colonna 2 - Funzionalit√† -->
            <div>
                <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">‚ú® Funzionalit√† Principali</h4>
                <ul style="font-size: 13px; line-height: 1.8; list-style: none; padding: 0; opacity: 0.9;">
                    <li>‚úì Calcolo automatico indici economici</li>
                    <li>‚úì Valutazione punteggio bando</li>
                    <li>‚úì Export Quadri H e L in Excel</li>
                    <li>‚úì Validazione limiti investimento</li>
                    <li>‚úì Gestione regime De Minimis/GBER</li>
                </ul>
            </div>
            
            <!-- Colonna 3 - Disclaimer -->
            <div>
                <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">‚ö†Ô∏è Disclaimer</h4>
                <p style="font-size: 12px; line-height: 1.6; opacity: 0.9;">
                    Questo strumento √® fornito a scopo informativo. I calcoli sono basati 
                    sull'interpretazione del bando pubblicato. Si consiglia sempre di verificare 
                    con il testo ufficiale del bando e consultare un professionista qualificato.
                </p>
                <p style="font-size: 11px; margin-top: 10px; opacity: 0.7;">
                    Non ci assumiamo responsabilit√† per eventuali errori o omissioni.
                </p>
            </div>
            
            <!-- Colonna 4 - Contatti/Support -->
            <div>
                <h4 style="color: white; margin-bottom: 15px; font-size: 16px;">üìû Supporto</h4>
                <p style="font-size: 13px; line-height: 1.8; opacity: 0.9;">
                    <strong>Email:</strong> <a href="mailto:vnexera@vnexera.com" style="color: white; font-weight: bold;">
                    vnexera@vnexera.com</a><br>
                    <strong>Web:</strong><a href="https://www.vnexera.com" style="color:white; font-weight: bold;" target="_blank">
                    https://www.vnexera.com
                
                </a><br>
                    <strong>Orari:</strong> Lun-Ven 9:00-18:00
                </p>
                <div style="margin-top: 15px;">
                    <button onclick="window.print()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 10px;">
                        üñ®Ô∏è Stampa
                    </button>
                    <button onclick="segnalaBug()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 12px;">
                        üêõ Segnala Bug
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Separatore -->
        <hr style="border: none; border-top: 1px solid rgba(255,255,255,0.2); margin: 20px 0;">
        
        <!-- Seconda riga - Copyright e info tecniche -->
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
            <div style="font-size: 13px; opacity: 0.9;">
                ¬© 2025  <strong>VNexera.com</strong> - Tutti i diritti riservati
            </div>
            
            <div style="font-size: 11px; opacity: 0.7; text-align: center;">
                Sviluppato con HTML5, CSS3, JavaScript | 
                Librerie: XLSX.js, html2canvas, jsPDF | 
                <span id="browserInfo"></span>
            </div>
            
            <div style="font-size: 11px; opacity: 0.7;">
                <a href="#" onclick="mostraChangelog(); return false;" style="color: white; text-decoration: none; margin: 0 10px;">üìã Changelog</a> |
                <a href="#" onclick="mostraPrivacy(); return false;" style="color: white; text-decoration: none; margin: 0 10px;">üîí Privacy</a> |
                <a href="#" onclick="mostraTermini(); return false;" style="color: white; text-decoration: none; margin: 0 10px;">üìú Termini</a>
            </div>
        </div>
        
        <!-- Badge validazione -->
        <div style="margin-top: 20px; text-align: center; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="display: inline-flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                <span style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 11px;">
                    ‚úÖ Conforme Bando FSC 2021-2027
                </span>
                <span style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 11px;">
                    üá™üá∫ Fondi Europei
                </span>
                <span style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 11px;">
                    üèõÔ∏è Regione Siciliana
                </span>
                <span style="background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; font-size: 11px;">
                    üìä v2.0.1 Stable
                </span>
            </div>
        </div>
    </div>
</div>

<!-- MODAL CHANGELOG (nascosto di default) -->
<div id="modalChangelog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
    <div style="position: relative; max-width: 600px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px; max-height: 80vh; overflow-y: auto;">
        <button onclick="chiudiModal('modalChangelog')" style="position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
        <h2 style="color: #1e3c72; margin-bottom: 20px;">üìã Changelog</h2>
        
        <div style="font-size: 14px; line-height: 1.8;">
            <h4 style="color: #667eea; margin-top: 15px;">Versione 2.0.1 - 04/11/</h4>
            <ul style="margin: 10px 0 20px 20px;">
                <li>Aggiunto arrotondamento indici economici</li>
                <li>Implementato pulsante reset completo</li>
                <li>Aggiunta visualizzazione variazioni per imprese attive</li>
                <li>Corretti calcoli ammortamenti su investimenti proposti</li>
            </ul>
            
            <h4 style="color: #667eea; margin-top: 15px;">Versione 2.0.0 - 01/11/</h4>
            <ul style="margin: 10px 0 20px 20px;">
                <li>Rilascio versione stabile</li>
                <li>Implementazione completa Quadro H e L</li>
                <li>Sistema di punteggio automatico</li>
                <li>Export Excel multipagina</li>
            </ul>
            
            <h4 style="color: #667eea; margin-top: 15px;">Versione 1.5.0 - 25/10/</h4>
            <ul style="margin: 10px 0 20px 20px;">
                <li>Aggiunta gestione regime De Minimis/GBER</li>
                <li>Validazione limiti investimento</li>
                <li>Calcolo automatico contributi</li>
            </ul>
        </div>
    </div>
</div>
 
</body>
</html>

