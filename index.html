<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calcolatore Business Plan Turistico - Bando Sicilia FSC 2021-2027</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .tabs { display:flex; background:#f5f5f5; border-bottom:2px solid #ddd; }
        .tab { flex:1; padding:15px; text-align:center; cursor:pointer; font-weight:600; border-right:1px solid #ddd; }
        .tab.active { background:white; color:#1e3c72; border-bottom:3px solid #1e3c72; }
        .content { padding:30px; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .section { margin-bottom:30px; padding:20px; background:#f9f9f9; border-radius:10px; border-left:4px solid #1e3c72; }
        .input-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
        .input-group { display:flex; flex-direction:column; }
        .input-group label { font-weight:600; margin-bottom:8px; color:#555; font-size:14px; }
        input, select, button { padding:12px; border:2px solid #ddd; border-radius:8px; font-size:14px; }
        input:focus, select:focus { outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,0.08); }
        .btn { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .occupancy-table { width:100%; border-collapse:collapse; margin:20px 0; background:white; border-radius:10px; overflow:hidden; }
        .occupancy-table th { background:#1e3c72; color:white; padding:12px; text-align:left; font-weight:600; }
        .occupancy-table td { padding:12px; border-bottom:1px solid #eee; }
        .alert { padding:12px; border-radius:8px; margin:12px 0; }
        .alert-info { background:#d1ecf1; color:#0c5460; border-left:4px solid #17a2b8; }
        .alert-warning { background:#fff3cd; color:#856404; border-left:4px solid #ffc107; }
        .invalid-input { border-color: #e74c3c !important; box-shadow: 0 0 0 3px rgba(231,76,60,0.08); }
        #validationErrors { display:none; margin-top:10px; padding:12px; border-radius:8px; }
        .results-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); gap:16px; }
        .result-card { background:white; padding:16px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.08); border-left:4px solid #667eea; }
        .result-value { font-size:28px; font-weight:700; color:#667eea; margin-top:8px; }
        .result-status { display:inline-block; padding:6px 10px; border-radius:20px; font-weight:700; margin-top:10px; font-size:12px; }
        .status-excellent { background:#d4edda; color:#155724; }
        .status-good { background:#d1ecf1; color:#0c5460; }
        .status-warning { background:#fff3cd; color:#856404; }
        .status-poor { background:#f8d7da; color:#721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Calcolatore Business Plan Turistico</h1>
            <p>Bando FSC 2021-2027 - Agevolazioni Imprese Turistiche Sicilia</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab(0)">üìù Dati Base</div>
            <div class="tab" onclick="showTab(1)">üí∞ Dati Economici</div>
            <div class="tab" onclick="showTab(2)">üìà Indici & Risultati</div>
            <div class="tab" onclick="showTab(3)">üéØ Punteggio Bando</div>
        </div>

        <div class="content">
            <!-- TAB 1 -->
            <div class="tab-content active">
                <div class="alert alert-info">
                    ‚ÑπÔ∏è I comuni sono importati automaticamente; non √® necessario caricare il CSV.
                </div>

                <div class="section">
                    <h2>Informazioni cliente</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Denominazione Cliente *</label>
                            <input type="text" id="denominazioneCliente" placeholder="Es. Ragione Sociale SRL">
                            <span class="hint">Nome della societ√† / cliente (verr√† incluso negli export)</span>
                        </div>
                        <div class="input-group">
                            <label>Comune (criterio F)</label>
                            <input list="comuniList" id="comuneInput" placeholder="Scrivi o scegli un comune" onchange="comuneChanged()">
                            <datalist id="comuniList"></datalist>
                            <span class="hint">Selezionando un comune, il punteggio F verr√† impostato automaticamente (se presente nel file).</span>
                        </div>
                        <div class="input-group">
                            <label>Verifica Validit√†</label>
                            <button class="btn" onclick="validateInputs(true)">Verifica Dati</button>
                        </div>
                    </div>
                    <div id="validationErrors" class="alert alert-warning"></div>
                </div>

                <div class="section">
                    <h2>Tipologia Impresa</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Stato Impresa *</label>
                            <select id="impresaStato" onchange="updateFormVisibility()">
                                <option value="inattiva">Impresa Inattiva (nuova costituzione)</option>
                                <option value="attiva">Impresa Attiva</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tipologia Struttura *</label>
                            <select id="tipologiaStruttura">
                                <option value="hotel">Hotel / Albergo</option>
                                <option value="residenza">Residenza Turistico-Alberghiera</option>
                                <option value="bb">B&B</option>
                                <option value="agriturismo">Agriturismo</option>
                                <option value="villaggio">Villaggio Turistico</option>
                                <option value="altro">Altra struttura extralberghiera</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Caratteristiche struttura</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Numero Camere/Unit√† Abitative *</label>
                            <input type="number" id="numeroCamere" value="1" min="1" />
                        </div>
                        <div class="input-group">
                            <label>Giorni Apertura Annui *</label>
                            <input type="number" id="giorniApertura" value="365" min="1" max="365" />
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Attuali (ULA)</label>
                            <input type="number" id="dipendentiAttuali" value="0" min="0" step="0.5" />
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Previsti (ULA) *</label>
                            <input type="number" id="dipendentiPrevisti" value="1" min="1" step="0.5" />
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Dati Investimento</h2>
                    <div class="input-grid">
                        <div class="input-group"><label>Investimento Totale (‚Ç¨) *</label><input type="number" id="investimentoTotale" value="50000" min="50000" max="3500000"></div>
                        <div class="input-group"><label>Investimenti Operativi (‚Ç¨) *</label><input type="number" id="investimentiOperativi" value="0" min="0"></div>
                        <div class="input-group"><label>Investimenti Immobiliari (‚Ç¨)</label><input type="number" id="investimentiImmobiliari" value="0" min="0"></div>
                        <div class="input-group"><label>Contributo Richiesto (‚Ç¨) *</label><input type="number" id="contributoRichiesto" value="0" min="50000"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Previsione occupazione</h2>
                    <table class="occupancy-table">
                        <thead><tr><th>Periodo</th><th>Giorni</th><th>Occupazione %</th><th>Camere Vendute</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><strong>Alta Stagione</strong></td>
                                <td><input type="number" id="giorniAlta" value="120" min="0" onchange="updateOccupancy()"></td>
                                <td><input type="number" id="occAlta" value="80" min="0" max="100" onchange="updateOccupancy()"></td>
                                <td id="camereAlta">0</td>
                            </tr>
                            <tr>
                                <td><strong>Media Stagione</strong></td>
                                <td><input type="number" id="giorniMedia" value="120" min="0" onchange="updateOccupancy()"></td>
                                <td><input type="number" id="occMedia" value="50" min="0" max="100" onchange="updateOccupancy()"></td>
                                <td id="camereMedia">0</td>
                            </tr>
                            <tr>
                                <td><strong>Bassa Stagione</strong></td>
                                <td><input type="number" id="giorniBassa" value="125" min="0" onchange="updateOccupancy()"></td>
                                <td><input type="number" id="occBassa" value="30" min="0" max="100" onchange="updateOccupancy()"></td>
                                <td id="camereBassa">0</td>
                            </tr>
                            <tr style="background:#f0f0f0;font-weight:bold;">
                                <td>TOTALE</td>
                                <td id="giorniTotali">365</td>
                                <td id="occMediaDisplay">-</td>
                                <td id="camereTotali">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <button class="btn" onclick="showTab(1)">Continua: Dati Economici ‚Üí</button>
            </div>

            <!-- TAB 2 -->
            <div class="tab-content">
                <div class="alert alert-info">‚ÑπÔ∏è Inserisci le proiezioni economiche dell'anno a regime</div>

                <div class="section">
                    <h2>Ricavi previsionali</h2>
                    <div class="input-grid">
                        <div class="input-group"><label>Prezzo Medio Camera (ADR) (‚Ç¨) *</label><input type="number" id="adr" value="75" min="1" onchange="calcola()"></div>
                        <div class="input-group"><label>Fatturato Ristorazione (‚Ç¨)</label><input type="number" id="fattRistorazione" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Altri Ricavi (‚Ç¨)</label><input type="number" id="altriRicavi" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group" style="background:#e8f4f8;padding:12px;border-radius:8px;">
                            <label>Fatturato Totale Previsto (‚Ç¨)</label>
                            <input type="text" id="fatturatoTotale" readonly>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Costi operativi</h2>
                    <div class="input-grid">
                        <div class="input-group"><label>Materie Prime (‚Ç¨)</label><input type="number" id="costiMaterie" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Costo Personale (‚Ç¨) *</label><input type="number" id="costoPersonale" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Servizi Generali (‚Ç¨) *</label><input type="number" id="costiServizi" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Godimento Beni di Terzi (‚Ç¨)</label><input type="number" id="costiBeni" value="40000" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Costi Marketing (‚Ç¨)</label><input type="number" id="costiMarketing" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Spese Generali (‚Ç¨)</label><input type="number" id="speseGenerali" value="0" min="0" onchange="calcola()"></div>
                    </div>
                </div>

                <div class="section">
                    <h2>Ammortamenti e oneri</h2>
                    <div class="input-grid">
                        <div class="input-group"><label>Ammortamenti Immateriali (‚Ç¨)</label><input type="number" id="ammImmateriali" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Ammortamenti Materiali (‚Ç¨)</label><input type="number" id="ammMateriali" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Oneri Finanziari (‚Ç¨)</label><input type="number" id="oneriFin" value="0" min="0" onchange="calcola()"></div>
                        <div class="input-group"><label>Imposte sul Reddito (‚Ç¨)</label><input type="number" id="imposte" value="0" min="0" onchange="calcola()"></div>
                    </div>
                </div>

                <button class="btn" onclick="calcola()">üßÆ Calcola Indici</button>
                <button class="btn" onclick="showTab(2)">Vai ai Risultati ‚Üí</button>
            </div>

            <!-- TAB 3 -->
            <div class="tab-content">
                <button class="btn" style="float:right;margin-left:8px;" onclick="exportExcel()">üìä Esporta Excel</button>
                <button class="btn" style="float:right;background:#0069d9;margin-left:8px;" onclick="exportPDF()">üìÑ Esporta PDF</button>
                <div style="clear:both"></div>

                <div class="alert alert-info">üìä Dashboard risultati</div>

                <div id="reportArea">
                    <div class="section">
                        <h2>Indici Economico-Finanziari</h2>
                        <div class="results-grid">
                            <div class="result-card">
                                <h4>ROS - Return On Sales</h4>
                                <div class="result-value" id="rosValue">-</div>
                                <div class="result-benchmark">Target: >20%</div>
                                <div class="result-status" id="rosStatus">-</div>
                            </div>
                            <div class="result-card">
                                <h4>ROI</h4>
                                <div class="result-value" id="roiValue">-</div>
                                <div class="result-benchmark">Target: >15%</div>
                                <div class="result-status" id="roiStatus">-</div>
                            </div>
                            <div class="result-card">
                                <h4>MOL (Margine Operativo Lordo)</h4>
                                <div class="result-value" id="molValue">-</div>
                                <div class="result-benchmark">Valore assoluto (‚Ç¨)</div>
                            </div>
                            <div class="result-card">
                                <h4>EBITDA</h4>
                                <div class="result-value" id="ebitdaValue">-</div>
                                <div class="result-benchmark">EBITDA = MOL (stessa voce)</div>
                            </div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Indici operativi</h2>
                        <div class="results-grid">
                            <div class="result-card"><h4>TOR - Occupazione</h4><div class="result-value" id="torValue">-</div><div class="result-status" id="torStatus">-</div></div>
                            <div class="result-card"><h4>RevPAR</h4><div class="result-value" id="revparValue">-</div><div class="result-status" id="revparStatus">-</div></div>
                            <div class="result-card"><h4>ADR</h4><div class="result-value" id="adrResultValue">-</div><div class="result-status">Input utente</div></div>
                            <div class="result-card"><h4>GOPPAR</h4><div class="result-value" id="gopparValue">-</div><div class="result-status" id="gopparStatus">-</div></div>
                        </div>
                    </div>

                    <div class="section">
                        <h2>Riepilogo economico</h2>
                        <table class="occupancy-table">
                            <tr><th>Voce</th><th style="text-align:right">Importo (‚Ç¨)</th></tr>
                            <tr><td><strong>Fatturato Totale</strong></td><td id="recap_fatt" style="text-align:right">-</td></tr>
                            <tr><td>Costi Operativi</td><td id="recap_costi" style="text-align:right">-</td></tr>
                            <tr style="background:#f0f0f0"><td><strong>MOL (Margine Operativo Lordo)</strong></td><td id="recap_mol" style="text-align:right">-</td></tr>
                            <tr><td>Ammortamenti</td><td id="recap_amm" style="text-align:right">-</td></tr>
                            <tr style="background:#e8f4f8"><td><strong>EBITDA</strong></td><td id="recap_ebitda" style="text-align:right">-</td></tr>
                            <tr style="background:#cfe2ff;font-weight:bold"><td><strong>RISULTATO NETTO</strong></td><td id="recap_netto" style="text-align:right">-</td></tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- TAB 4 -->
            <div class="tab-content">
                <div class="alert alert-warning">‚ö†Ô∏è I punteggi sono calcolati automaticamente in base alla griglia; verifica con il bando.</div>

                <div class="section">
                    <h2>Punteggio totale</h2>
                    <div style="font-size:40px;font-weight:700;color:#667eea;" id="punteggioTotale">0</div>
                </div>

                <div class="section">
                    <h2>Parametri griglia</h2>
                    <div class="input-grid">
                        <div class="input-group"><label>D) Qualit√† progettuale (0-14)</label><input type="number" id="griglia_d" value="0" min="0" max="14"></div>
                        <div class="input-group"><label>E) Sostenibilit√† (0-17)</label><input type="number" id="griglia_e" value="0" min="0" max="17"></div>
                        <div class="input-group"><label>F) Localizzazione (0-10)</label><input type="number" id="griglia_f" value="0" min="0" max="10"></div>
                    </div>
                </div>

                <button class="btn" onclick="calcolaPunteggio()">üéØ Ricalcola Punteggi</button>

                <div class="section" style="margin-top:20px;">
                    <h3>Riepilogo punteggi</h3>
                    <table class="occupancy-table">
                        <tr><th>Criterio</th><th style="text-align:center">Punti</th><th style="text-align:center">Max</th></tr>
                        <tr><td>A) Investimento/Occupazione</td><td id="final_a" style="text-align:center">0</td><td style="text-align:center">20</td></tr>
                        <tr><td>B) Investimento Operativo</td><td id="final_b" style="text-align:center">0</td><td style="text-align:center">20</td></tr>
                        <tr><td>C) Risultati Economici</td><td id="final_c" style="text-align:center">0</td><td style="text-align:center">14</td></tr>
                        <tr><td>D) Qualit√† Progettuale</td><td id="final_d" style="text-align:center">0</td><td style="text-align:center">14</td></tr>
                        <tr><td>E) Sostenibilit√†</td><td id="final_e" style="text-align:center">0</td><td style="text-align:center">17</td></tr>
                        <tr><td>F) Localizzazione</td><td id="final_f" style="text-align:center">0</td><td style="text-align:center">10</td></tr>
                        <tr style="background:#ffd700;font-weight:bold"><td>TOTALE</td><td id="final_tot" style="text-align:center">0</td><td style="text-align:center">100</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- libs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // variabili globali
        let comuniLocalizzazione = {};
        let risultati = {};

        // funzione tab
        function showTab(i) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            tabs.forEach((t,idx) => t.classList.toggle('active', idx === i));
            contents.forEach((c,idx) => c.classList.toggle('active', idx === i));
            window.scrollTo({top:0,behavior:'smooth'});
        }

        function updateFormVisibility() {
            document.getElementById('datiConfronto')?.style?.display = (document.getElementById('impresaStato').value === 'attiva') ? 'block' : 'none';
        }

        // carica CSV automaticamente da percorso relativo (data/comuni_localizzazione.csv)
        async function loadComuniAutomatico() {
            try {
                const resp = await fetch('data/comuni_localizzazione.csv');
                if (!resp.ok) throw new Error('CSV non trovato: ' + resp.status);
                // supporta ISO-8859-1 decoding
                const buf = await resp.arrayBuffer();
                const decoder = new TextDecoder('iso-8859-1');
                const text = decoder.decode(buf);
                parseComuniCSV(text);
            } catch (err) {
                console.warn('Impossibile caricare CSV comuni automaticamente:', err.message);
                // non bloccante: l'utente pu√≤ comunque inserire il punteggio F manualmente
            }
        }

        // parsing CSV (simile alla versione precedente)
        function parseComuniCSV(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            if (lines.length === 0) return;
            const headers = lines[0].split(';').map(h => h.trim());
            const idxComune = headers.findIndex(h => /COMUNE/i.test(h));
            const idxIsola = headers.findIndex(h => /Isola/i.test(h));
            const idxRic = headers.findIndex(h => /Ricettiv/i.test(h));
            const idxRur = headers.findIndex(h => /Area rurale/i.test(h) || /Rurale/i.test(h));
            if (idxComune === -1) return;
            for (let i=1;i<lines.length;i++){
                const cols = lines[i].split(';').map(c => c.trim());
                const nome = cols[idxComune];
                if (!nome) continue;
                comuniLocalizzazione[nome.toUpperCase()] = {
                    isIsolaMinore: idxIsola>=0 ? Number((cols[idxIsola]||'0').replace(/\D/g,''))===1 : false,
                    isRicettivita: idxRic>=0 ? Number((cols[idxRic]||'0').replace(/\D/g,''))===1 : false,
                    isAreaRurale: idxRur>=0 ? Number((cols[idxRur]||'0').replace(/\D/g,''))===1 : false
                };
            }
            populateComuniDatalist();
        }

        function populateComuniDatalist() {
            const dl = document.getElementById('comuniList');
            if (!dl) return;
            dl.innerHTML = '';
            Object.keys(comuniLocalizzazione).sort().forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                dl.appendChild(opt);
            });
        }

        function comuneChanged() {
            const nome = (document.getElementById('comuneInput').value || '').toUpperCase();
            if (comuniLocalizzazione[nome]) {
                const v = comuniLocalizzazione[nome];
                const sum = (v.isIsolaMinore?1:0) + (v.isRicettivita?1:0) + (v.isAreaRurale?1:0);
                const punti = sum >= 2 ? 8 : (sum === 1 ? 4 : 0);
                document.getElementById('griglia_f').value = punti;
            }
        }

        // occupancy
        function updateOccupancy() {
            const numeroCamere = Number(document.getElementById('numeroCamere').value) || 0;
            const gA = Number(document.getElementById('giorniAlta').value) || 0;
            const gM = Number(document.getElementById('giorniMedia').value) || 0;
            const gB = Number(document.getElementById('giorniBassa').value) || 0;
            const oA = Number(document.getElementById('occAlta').value) || 0;
            const oM = Number(document.getElementById('occMedia').value) || 0;
            const oB = Number(document.getElementById('occBassa').value) || 0;
            const camAlta = Math.round(numeroCamere * gA * (oA/100));
            const camMedia = Math.round(numeroCamere * gM * (oM/100));
            const camBassa = Math.round(numeroCamere * gB * (oB/100));
            const giorniTot = gA+gM+gB;
            const camereTot = camAlta+camMedia+camBassa;
            const occMedia = (numeroCamere * giorniTot) > 0 ? (camereTot / (numeroCamere * giorniTot) * 100) : 0;
            document.getElementById('camereAlta').innerText = camAlta.toLocaleString();
            document.getElementById('camereMedia').innerText = camMedia.toLocaleString();
            document.getElementById('camereBassa').innerText = camBassa.toLocaleString();
            document.getElementById('giorniTotali').innerText = giorniTot;
            document.getElementById('camereTotali').innerText = camereTot.toLocaleString();
            document.getElementById('occMediaDisplay').innerText = occMedia.toFixed(1) + '%';
        }

        // validazione (ora include denominazione cliente)
        function validateInputs(showAlert=false) {
            const errors = [];
            document.querySelectorAll('.invalid-input').forEach(el => el.classList.remove('invalid-input'));
            const cliente = (document.getElementById('denominazioneCliente').value || '').trim();
            if (!cliente) {
                errors.push('Denominazione Cliente √® obbligatoria');
                document.getElementById('denominazioneCliente').classList.add('invalid-input');
            }
            const required = [
                {id:'numeroCamere', label:'Numero Camere', min:1},
                {id:'giorniApertura', label:'Giorni Apertura', min:1},
                {id:'dipendentiPrevisti', label:'Numero Dipendenti Previsti', min:0.5},
                {id:'investimentoTotale', label:'Investimento Totale', min:50000},
                {id:'adr', label:'ADR', min:1}
            ];
            required.forEach(r => {
                const el = document.getElementById(r.id);
                const val = Number(el.value);
                if (isNaN(val) || val < r.min) {
                    errors.push(r.label + ' (min ' + r.min + ')');
                    el.classList.add('invalid-input');
                }
            });
            const invTot = Number(document.getElementById('investimentoTotale').value) || 0;
            const invOp = Number(document.getElementById('investimentiOperativi').value) || 0;
            if (invOp > invTot) {
                errors.push('Investimenti Operativi non pu√≤ essere maggiore dell\\'Investimento Totale');
                document.getElementById('investimentiOperativi').classList.add('invalid-input');
                document.getElementById('investimentoTotale').classList.add('invalid-input');
            }
            const gA = Number(document.getElementById('giorniAlta').value) || 0;
            const gM = Number(document.getElementById('giorniMedia').value) || 0;
            const gB = Number(document.getElementById('giorniBassa').value) || 0;
            if ((gA+gM+gB) <= 0) {
                errors.push('I giorni totali stagionali devono essere > 0');
                document.getElementById('giorniAlta').classList.add('invalid-input');
                document.getElementById('giorniMedia').classList.add('invalid-input');
                document.getElementById('giorniBassa').classList.add('invalid-input');
            }
            const div = document.getElementById('validationErrors');
            if (errors.length>0) {
                div.style.display = 'block';
                div.innerHTML = '<strong>Errore di validazione:</strong><ul><li>' + errors.join('</li><li>') + '</li></ul>';
                if (showAlert) div.scrollIntoView({behavior:'smooth'});
                return false;
            } else {
                div.style.display = 'none';
                div.innerHTML = '';
                return true;
            }
        }

        // calcolo indici: qui EBITDA = MOL (come richiesto)
        function calcola() {
            if (!validateInputs()) return;
            updateOccupancy();

            const numeroCamere = Number(document.getElementById('numeroCamere').value) || 0;
            const gA = Number(document.getElementById('giorniAlta').value) || 0;
            const gM = Number(document.getElementById('giorniMedia').value) || 0;
            const gB = Number(document.getElementById('giorniBassa').value) || 0;
            const giorniCalcolati = (gA+gM+gB) || Number(document.getElementById('giorniApertura').value) || 0;
            const occA = Number(document.getElementById('occAlta').value) || 0;
            const occM = Number(document.getElementById('occMedia').value) || 0;
            const occB = Number(document.getElementById('occBassa').value) || 0;

            const adr = Number(document.getElementById('adr').value) || 0;
            const fattRistorazione = Number(document.getElementById('fattRistorazione').value) || 0;
            const altriRicavi = Number(document.getElementById('altriRicavi').value) || 0;

            const costiMaterie = Number(document.getElementById('costiMaterie').value) || 0;
            const costoPersonale = Number(document.getElementById('costoPersonale').value) || 0;
            const costiServizi = Number(document.getElementById('costiServizi').value) || 0;
            const costiBeni = Number(document.getElementById('costiBeni').value) || 0;
            const costiMarketing = Number(document.getElementById('costiMarketing').value) || 0;
            const speseGenerali = Number(document.getElementById('speseGenerali').value) || 0;

            const ammImmateriali = Number(document.getElementById('ammImmateriali').value) || 0;
            const ammMateriali = Number(document.getElementById('ammMateriali').value) || 0;
            const oneriFin = Number(document.getElementById('oneriFin').value) || 0;
            const imposte = Number(document.getElementById('imposte').value) || 0;

            const investimentoTotale = Number(document.getElementById('investimentoTotale').value) || 0;
            const investimentiOperativi = Number(document.getElementById('investimentiOperativi').value) || 0;

            const dipAttuali = Number(document.getElementById('dipendentiAttuali').value) || 0;
            const dipPrevisti = Number(document.getElementById('dipendentiPrevisti').value) || 0;

            // camere vendute
            const camAlta = numeroCamere * gA * (occA/100);
            const camMedia = numeroCamere * gM * (occM/100);
            const camBassa = numeroCamere * gB * (occB/100);
            const camereTotali = camAlta + camMedia + camBassa;

            // ricavi camere e fatturato totale
            const ricaviCamere = adr * camereTotali;
            const fatturatoTotale = ricaviCamere + fattRistorazione + altriRicavi;

            // costi e MOL
            const costiOperativi = costiMaterie + costoPersonale + costiServizi + costiBeni + costiMarketing + speseGenerali;
            const mol = fatturatoTotale - costiOperativi;

            // come richiesto: EBITDA = MOL (mostrati uguali). Manteniamo ammortamenti per informazione ma non sottraiamo da EBITDA.
            const ebitda = mol;

            const ammortamenti = ammImmateriali + ammMateriali;
            const risultatoOperativo = ebitda; // coerente con EBITDA=MOL
            const risultatoNetto = risultatoOperativo - oneriFin - imposte;

            // indici percentuali
            const ros = fatturatoTotale !== 0 ? (risultatoOperativo / fatturatoTotale) : 0;
            const roi = investimentoTotale !== 0 ? (risultatoOperativo / investimentoTotale) : 0;
            const ebitdaMargin = fatturatoTotale !== 0 ? (ebitda / fatturatoTotale) : 0;
            const tor = (numeroCamere * giorniCalcolati) !== 0 ? (camereTotali / (numeroCamere * giorniCalcolati)) : 0;
            const revpar = (numeroCamere * giorniCalcolati) !== 0 ? (ricaviCamere / (numeroCamere * giorniCalcolati)) : 0;
            const goppar = (numeroCamere * giorniCalcolati) !== 0 ? (risultatoOperativo / (numeroCamere * giorniCalcolati)) : 0;
            const laborCostPerc = fatturatoTotale !== 0 ? (costoPersonale / fatturatoTotale) : 0;
            const produttivitaPerULA = dipPrevisti !== 0 ? (fatturatoTotale / dipPrevisti) : 0;
            const invPerULA = (dipPrevisti - dipAttuali) > 0 ? (investimentoTotale / (dipPrevisti - dipAttuali)) : (dipPrevisti > 0 ? (investimentoTotale / dipPrevisti) : Infinity);

            risultati = {
                numeroCamere, giorniCalcolati, camereTotali, ricaviCamere, fatturatoTotale,
                costiOperativi, mol, ammortamenti, ebitda, risultatoOperativo, risultatoNetto,
                ros, roi, ebitdaMargin, tor, revpar, goppar, laborCostPerc, produttivitaPerULA, invPerULA,
                investimentoTotale, investimentiOperativi, dipAttuali, dipPrevisti
            };

            // aggiorna UI
            document.getElementById('fatturatoTotale').value = formatEuro(fatturatoTotale);
            document.getElementById('rosValue').innerText = formatPerc(ros);
            document.getElementById('roiValue').innerText = formatPerc(roi);
            document.getElementById('molValue').innerText = formatEuro(mol);
            document.getElementById('ebitdaValue').innerText = formatEuro(ebitda); // stesso valore di MOL

            document.getElementById('torValue').innerText = (tor*100).toFixed(1) + '%';
            document.getElementById('revparValue').innerText = formatEuro(revpar);
            document.getElementById('adrResultValue').innerText = formatEuro(adr);
            document.getElementById('gopparValue').innerText = formatEuro(goppar);

            document.getElementById('recap_fatt').innerText = formatEuro(fatturatoTotale);
            document.getElementById('recap_costi').innerText = formatEuro(costiOperativi);
            document.getElementById('recap_mol').innerText = formatEuro(mol);
            document.getElementById('recap_amm').innerText = formatEuro(ammortamenti);
            document.getElementById('recap_ebitda').innerText = formatEuro(ebitda);
            document.getElementById('recap_netto').innerText = formatEuro(risultatoNetto);

            // badge semplificati (soglie esemplificative)
            setStatus('rosStatus', ros, [0.05,0.1,0.2]);
            setStatus('roiStatus', roi, [0.05,0.1,0.15]);
            setStatus('torStatus', tor, [0.4,0.6,0.7]);
            setStatus('revparStatus', revpar, [30,60,100]);
            setStatus('gopparStatus', goppar, [10,20,40]);
            setStatus('laborStatus', laborCostPerc, [0.35,0.45,0.6], true);
        }

        function formatEuro(v) {
            if (typeof v !== 'number' || !Number.isFinite(v)) return '-';
            return v.toLocaleString('it-IT', {style:'currency', currency:'EUR', minimumFractionDigits:0});
        }
        function formatPerc(v) {
            if (typeof v !== 'number' || !Number.isFinite(v)) return '-';
            return (v*100).toFixed(1) + '%';
        }
        function setStatus(id, val, soglie=[0.1,0.2,0.3], invert=false) {
            const el = document.getElementById(id);
            if (!el) return;
            if (!Number.isFinite(val)) { el.className='result-status'; el.innerText='-'; return; }
            let classe='status-poor', testo='Migliorabile';
            if (!invert) {
                if (val >= soglie[2]) { classe='status-excellent'; testo='Eccellente'; }
                else if (val >= soglie[1]) { classe='status-good'; testo='Buono'; }
                else if (val >= soglie[0]) { classe='status-warning'; testo='Sufficiente'; }
            } else {
                if (val <= soglie[0]) { classe='status-excellent'; testo='Eccellente'; }
                else if (val <= soglie[1]) { classe='status-good'; testo='Buono'; }
                else if (val <= soglie[2]) { classe='status-warning'; testo='Sufficiente'; }
            }
            el.className = 'result-status ' + classe;
            el.innerText = testo;
        }

        // calcolo punteggi A-F (usa risultati calcolati)
        function calcolaPunteggio() {
            if (!validateInputs()) return;
            if (!risultati || !('fatturatoTotale' in risultati)) calcola();

            const stato = document.getElementById('impresaStato').value;
            const dipAttuali = Number(document.getElementById('dipendentiAttuali').value) || 0;
            const dipPrevisti = Number(document.getElementById('dipendentiPrevisti').value) || 0;
            const nuoviOccupati = Math.max(0, dipPrevisti - dipAttuali);
            const invPerULA = risultati.invPerULA;

            // A
            let puntiA = 0;
            if (nuoviOccupati <= 0) puntiA = 0;
            else {
                if (stato === 'inattiva') {
                    if (invPerULA <= 150000) puntiA = 20;
                    else if (invPerULA <= 200000) puntiA = 16;
                    else if (invPerULA <= 300000) puntiA = 10;
                    else puntiA = 6;
                } else {
                    if (invPerULA <= 350000) puntiA = 20;
                    else if (invPerULA <= 466666) puntiA = 16;
                    else if (invPerULA <= 700000) puntiA = 10;
                    else puntiA = 6;
                }
            }
            document.getElementById('final_a').innerText = puntiA;

            // B
            const ratioInvOp = risultati.investimentiOperativi > 0 && risultati.investimentoTotale > 0 ? (risultati.investimentiOperativi / risultati.investimentoTotale) : 0;
            let puntiB = 0;
            if (ratioInvOp > 0.85) puntiB = 20;
            else if (ratioInvOp > 0.7) puntiB = 16;
            else if (ratioInvOp > 0.55) puntiB = 10;
            else if (ratioInvOp > 0.4) puntiB = 7;
            else puntiB = 0;
            document.getElementById('final_b').innerText = puntiB;
            document.getElementById('griglia_invop')?.innerText = (ratioInvOp*100).toFixed(1) + '%';

            // C
            let puntiC1=0,puntiC2=0,puntiC3=0,puntiC4=0;
            const ros = risultati.ros;
            const roi = risultati.roi;
            const ebitdaMargin = risultati.ebitdaMargin;
            const tor = risultati.tor;
            if (stato === 'inattiva') {
                if (ros > 0.20) puntiC1 = 4;
                if (roi > 0.15) puntiC2 = 4;
                if (ebitdaMargin > 0.30) puntiC3 = 4;
            } else {
                const fattPre = Number(document.getElementById('fattPrecedente')?.value) || 0;
                const risOpPre = Number(document.getElementById('risOpPrecedente')?.value) || 0;
                const rosPre = (fattPre>0) ? (risOpPre / fattPre) : 0;
                if ((ros - rosPre) > 0.10) puntiC1 = 4;
                const capInvPre = Number(document.getElementById('capInvPrecedente')?.value) || 0;
                const roiPre = (capInvPre>0) ? (risOpPre / capInvPre) : 0;
                if ((roi - roiPre) > 0.10) puntiC2 = 4;
                if (ebitdaMargin > 0.20) puntiC3 = 4;
            }
            if ((tor*100) > 70) puntiC4 = 2;
            let puntiC = puntiC1 + puntiC2 + puntiC3 + puntiC4;
            if (puntiC > 14) puntiC = 14;
            document.getElementById('final_c').innerText = puntiC;

            // D,E input diretto
            const puntiD = Math.max(0, Math.min(14, Number(document.getElementById('griglia_d').value) || 0));
            const puntiE = Math.max(0, Math.min(17, Number(document.getElementById('griglia_e').value) || 0));
            document.getElementById('final_d').innerText = puntiD;
            document.getElementById('final_e').innerText = puntiE;

            // F
            let puntiF = Math.max(0, Math.min(8, Number(document.getElementById('griglia_f').value) || 0));
            document.getElementById('final_f').innerText = puntiF;

            const totale = puntiA + puntiB + puntiC + puntiD + puntiE + puntiF;
            document.getElementById('punteggioTotale').innerText = totale;
            document.getElementById('final_tot').innerText = totale;
        }

        // export PDF / Excel: includono denominazione cliente nel nome file quando presente
        async function exportPDF() {
            if (!risultati || !('fatturatoTotale' in risultati)) calcola();
            const report = document.getElementById('reportArea');
            try {
                const canvas = await html2canvas(report, {scale:2});
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p','mm','a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                const cliente = (document.getElementById('denominazioneCliente').value || '').trim();
                const name = cliente ? `report-${safeFileName(cliente)}.pdf` : 'report-business-plan.pdf';
                pdf.save(name);
            } catch (err) {
                alert('Errore esportazione PDF: ' + err.message);
            }
        }

        function exportExcel() {
            if (!risultati || !('fatturatoTotale' in risultati)) calcola();
            const cliente = (document.getElementById('denominazioneCliente').value || '').trim();
            const wb = XLSX.utils.book_new();

            const inputObj = {
                Cliente: cliente || '-',
                NumeroCamere: risultati.numeroCamere,
                GiorniApertura: risultati.giorniCalcolati,
                ADR: Number(document.getElementById('adr').value) || 0,
                FattRistorazione: Number(document.getElementById('fattRistorazione').value) || 0,
                AltriRicavi: Number(document.getElementById('altriRicavi').value) || 0,
                InvestimentoTotale: risultati.investimentoTotale,
                InvestimentiOperativi: risultati.investimentiOperativi,
                DipendentiAttuali: risultati.dipAttuali,
                DipendentiPrevisti: risultati.dipPrevisti
            };
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([inputObj]), 'Input');

            const resObj = {
                FatturatoTotale: risultati.fatturatoTotale,
                CostiOperativi: risultati.costiOperativi,
                MOL: risultati.mol,
                EBITDA: risultati.ebitda, // uguale a MOL
                Ammortamenti: risultati.ammortamenti,
                RisultatoNetto: risultati.risultatoNetto,
                ROS_pct: risultati.ros,
                ROI_pct: risultati.roi,
                EBITDA_Margin_pct: risultati.ebitdaMargin,
                TOR_pct: risultati.tor,
                RevPAR: risultati.revpar,
                GOPPAR: risultati.goppar,
                LaborCost_pct: risultati.laborCostPerc,
                Produttivita_per_ULA: risultati.produttivitaPerULA,
                Inv_per_ULA: risultati.invPerULA
            };
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([resObj]), 'Risultati');

            calcolaPunteggio();
            const scores = {
                A: document.getElementById('final_a').innerText,
                B: document.getElementById('final_b').innerText,
                C: document.getElementById('final_c').innerText,
                D: document.getElementById('final_d').innerText,
                E: document.getElementById('final_e').innerText,
                F: document.getElementById('final_f').innerText,
                Totale: document.getElementById('final_tot').innerText
            };
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet([scores]), 'Punteggi');

            const name = cliente ? `report-${safeFileName(cliente)}.xlsx` : 'report-business-plan.xlsx';
            XLSX.writeFile(wb, name);
        }

        function safeFileName(name) {
            return name.replace(/[^a-z0-9\-_\s]/gi, '').replace(/\s+/g, '-').toLowerCase();
        }

        // inizializzazione
        updateFormVisibility();
        updateOccupancy();
        loadComuniAutomatico();
    </script>
</body>
</html>
