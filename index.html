<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Calcolatore Business Plan Turistico - Bando Sicilia FSC 2021-2027</title>
    
    <!-- Librerie esterne necessarie -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            padding: 20px; 
            color: #333; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden; 
        }
        .header { 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 28px; margin-bottom: 10px; }
        .tabs { display:flex; background:#f5f5f5; border-bottom:2px solid #ddd; }
        .tab { 
            flex:1; 
            padding:15px; 
            text-align:center; 
            cursor:pointer; 
            font-weight:600; 
            border-right:1px solid #ddd; 
            transition: all 0.3s ease;
        }
        .tab:hover { background: #e8e8e8; }
        .tab.active { 
            background:white; 
            color:#1e3c72; 
            border-bottom:3px solid #1e3c72; 
        }
        .content { padding:30px; }
        .tab-content { display:none; animation: fadeIn 0.5s; }
        .tab-content.active { display:block; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .section { 
            margin-bottom:30px; 
            padding:20px; 
            background:#f9f9f9; 
            border-radius:10px; 
            border-left:4px solid #1e3c72; 
        }
        .input-grid { 
            display:grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap:20px; 
        }
        .input-group { display:flex; flex-direction:column; }
        .input-group label { 
            font-weight:600; 
            margin-bottom:8px; 
            color:#555; 
            font-size:14px; 
        }
        .hint { 
            font-size: 12px; 
            color: #666; 
            margin-top: 5px; 
            font-style: italic; 
        }
        input, select, button { 
            padding:12px; 
            border:2px solid #ddd; 
            border-radius:8px; 
            font-size:14px; 
            transition: all 0.3s ease;
        }
        input:focus, select:focus { 
            outline:none; 
            border-color:#667eea; 
            box-shadow:0 0 0 3px rgba(102,126,234,0.08); 
        }
        .btn { 
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); 
            color:white; 
            padding:12px 20px; 
            border:none; 
            border-radius:8px; 
            cursor:pointer; 
            font-weight:600; 
            transition: transform 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .occupancy-table { 
            width:100%; 
            border-collapse:collapse; 
            margin:20px 0; 
            background:white; 
            border-radius:10px; 
            overflow:hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .occupancy-table th { 
            background:#1e3c72; 
            color:white; 
            padding:12px; 
            text-align:left; 
            font-weight:600; 
        }
        .occupancy-table td { 
            padding:12px; 
            border-bottom:1px solid #eee; 
        }
        .occupancy-table tr:hover { background: #f5f5f5; }
        .alert { 
            padding:12px; 
            border-radius:8px; 
            margin:12px 0; 
        }
        .alert-info { 
            background:#d1ecf1; 
            color:#0c5460; 
            border-left:4px solid #17a2b8; 
        }
        .alert-warning { 
            background:#fff3cd; 
            color:#856404; 
            border-left:4px solid #ffc107; 
        }
        .alert-danger { 
            background:#f8d7da; 
            color:#721c24; 
            border-left:4px solid #dc3545; 
        }
        .alert-success { 
            background:#d4edda; 
            color:#155724; 
            border-left:4px solid #28a745; 
        }
        .invalid-input { 
            border-color: #e74c3c !important; 
            box-shadow: 0 0 0 3px rgba(231,76,60,0.08); 
        }
        #validationErrors { 
            display:none; 
            margin-top:10px; 
            padding:12px; 
            border-radius:8px; 
        }
        .results-grid { 
            display:grid; 
            grid-template-columns: repeat(auto-fit, minmax(260px,1fr)); 
            gap:16px; 
        }
        .result-card { 
            background:white; 
            padding:16px; 
            border-radius:8px; 
            box-shadow:0 4px 10px rgba(0,0,0,0.08); 
            border-left:4px solid #667eea; 
            transition: transform 0.2s ease;
        }
        .result-card:hover { 
            transform: translateY(-5px); 
            box-shadow:0 6px 20px rgba(0,0,0,0.15); 
        }
        .result-value { 
            font-size:28px; 
            font-weight:700; 
            color:#667eea; 
            margin-top:8px; 
        }
        .result-status { 
            display:inline-block; 
            padding:6px 10px; 
            border-radius:20px; 
            font-weight:700; 
            margin-top:10px; 
            font-size:12px; 
        }
        .status-excellent { background:#d4edda; color:#155724; }
        .status-good { background:#d1ecf1; color:#0c5460; }
        .status-warning { background:#fff3cd; color:#856404; }
        .status-poor { background:#f8d7da; color:#721c24; }
        
        .score-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        .score-table th {
            background: #2a5298;
            color: white;
            padding: 10px;
            text-align: left;
        }
        .score-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .total-score {
            font-size: 36px;
            font-weight: bold;
            color: #1e3c72;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            border-radius: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Calcolatore Business Plan Turistico</h1>
            <p>Bando FSC 2021-2027 - Agevolazioni Imprese Turistiche Sicilia</p>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab(0)">üìù Dati Base</div>
            <div class="tab" onclick="showTab(1)">üí∞ Dati Economici</div>
            <div class="tab" onclick="showTab(2)">üìà Indici & Risultati</div>
            <div class="tab" onclick="showTab(3)">üéØ Punteggio Bando</div>
        </div>

        <div class="content">
            <!-- TAB 1: Dati Base -->
            <div class="tab-content active">
                <div class="alert alert-info">
                    ‚ÑπÔ∏è Inserisci i dati base della tua struttura ricettiva per calcolare il business plan
                </div>

                <div class="section">
                    <h2>Informazioni Cliente</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Denominazione Cliente *</label>
                            <input type="text" id="denominazioneCliente" placeholder="Es. Hotel Paradise SRL">
                            <span class="hint">Nome della societ√† (verr√† incluso negli export)</span>
                        </div>
                        <div class="input-group">
                            <label>Comune</label>
                            <input type="text" id="comuneInput" placeholder="Es. Palermo">
                            <span class="hint">Comune dove √® ubicata la struttura</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Tipologia Impresa</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Stato Impresa *</label>
                            <select id="impresaStato" onchange="updateFormVisibility()">
                                <option value="inattiva">Impresa Inattiva (nuova costituzione)</option>
                                <option value="attiva">Impresa Attiva</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Tipologia Struttura *</label>
                            <select id="tipologiaStruttura">
                                <option value="hotel">Hotel / Albergo</option>
                                <option value="residenza">Residenza Turistico-Alberghiera</option>
                                <option value="bb">B&B</option>
                                <option value="agriturismo">Agriturismo</option>
                                <option value="villaggio">Villaggio Turistico</option>
                                <option value="altro">Altra struttura extralberghiera</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Caratteristiche Struttura</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Numero Camere/Unit√† Abitative *</label>
                            <input type="number" id="numeroCamere" value="10" min="1" />
                        </div>
                        <div class="input-group">
                            <label>Giorni Apertura Annui *</label>
                            <input type="number" id="giorniApertura" value="365" min="1" max="365" />
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Attuali (ULA)</label>
                            <input type="number" id="dipendentiAttuali" value="0" min="0" step="0.5" />
                        </div>
                        <div class="input-group">
                            <label>Numero Dipendenti Previsti (ULA) *</label>
                            <input type="number" id="dipendentiPrevisti" value="2" min="0" step="0.5" />
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Dati Investimento</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Investimento Totale (‚Ç¨) *</label>
                            <input type="number" id="investimentoTotale" value="100000" min="50000" max="3500000">
                        </div>
                        <div class="input-group">
                            <label>Investimenti Operativi (‚Ç¨) *</label>
                            <input type="number" id="investimentiOperativi" value="80000" min="0">
                            <span class="hint">Investimenti in attrezzature, macchinari, ecc.</span>
                        </div>
                    </div>
                </div>

                <div class="section" id="datiPrecedenti" style="display:none;">
                    <h2>Dati Anno Precedente (per imprese attive)</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Fatturato Anno Precedente (‚Ç¨)</label>
                            <input type="number" id="fattPrecedente" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Risultato Operativo Precedente (‚Ç¨)</label>
                            <input type="number" id="risOpPrecedente" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Capitale Investito Precedente (‚Ç¨)</label>
                            <input type="number" id="capInvPrecedente" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Previsioni Occupancy</h2>
                    <table class="occupancy-table">
                        <thead>
                            <tr>
                                <th>Mese</th>
                                <th>Occupancy %</th>
                                <th>Camere Occupate</th>
                                <th>Giorni</th>
                            </tr>
                        </thead>
                        <tbody id="occupancyTable">
                            <!-- Generato dinamicamente -->
                        </tbody>
                    </table>
                    <button class="btn" onclick="resetOccupancy()">Reset Valori Default</button>
                </div>
            </div>

            <!-- TAB 2: Dati Economici -->
            <div class="tab-content">
                <div class="section">
                    <h2>Ricavi</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>ADR - Tariffa Media Camera (‚Ç¨) *</label>
                            <input type="number" id="adr" value="80" min="1" step="0.01">
                            <span class="hint">Average Daily Rate</span>
                        </div>
                        <div class="input-group">
                            <label>Fatturato Ristorazione (‚Ç¨/anno)</label>
                            <input type="number" id="fattRistorazione" value="0" min="0">
                        </div>
                        <div class="input-group">
                            <label>Altri Ricavi (‚Ç¨/anno)</label>
                            <input type="number" id="altriRicavi" value="0" min="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Costi Operativi</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Costo del Personale (‚Ç¨/anno) *</label>
                            <input type="number" id="costoPersonale" value="50000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Costi Materie Prime (‚Ç¨/anno)</label>
                            <input type="number" id="costiMaterie" value="10000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Costi Servizi (‚Ç¨/anno)</label>
                            <input type="number" id="costiServizi" value="15000" min="0">
                        </div>
                        <div class="input-group">
                            <label>Altri Costi Operativi (‚Ç¨/anno)</label>
                            <input type="number" id="altriCosti" value="5000" min="0">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Parametri Finanziari</h2>
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Anni Ammortamento</label>
                            <input type="number" id="anniAmmortamento" value="10" min="1" max="20">
                        </div>
                        <div class="input-group">
                            <label>Aliquota Fiscale (%)</label>
                            <input type="number" id="aliquotaFiscale" value="24" min="0" max="100">
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="calcola()" style="font-size: 18px; padding: 15px 40px;">
                        üìä CALCOLA BUSINESS PLAN
                    </button>
                </div>
            </div>

            <!-- TAB 3: Indici & Risultati -->
            <div class="tab-content">
                <div id="reportArea">
                    <div class="alert alert-warning" id="noResultsAlert">
                        ‚ö†Ô∏è Clicca su "CALCOLA BUSINESS PLAN" nella tab precedente per visualizzare i risultati
                    </div>
                    
                    <div id="resultsContainer" style="display:none;">
                        <div class="section">
                            <h2>Risultati Economici</h2>
                            <div class="results-grid">
                                <div class="result-card">
                                    <div>üí∞ Fatturato Totale</div>
                                    <div class="result-value" id="resFatturato">‚Ç¨ 0</div>
                                </div>
                                <div class="result-card">
                                    <div>üìâ Costi Operativi</div>
                                    <div class="result-value" id="resCosti">‚Ç¨ 0</div>
                                </div>
                                <div class="result-card">
                                    <div>üìä EBITDA</div>
                                    <div class="result-value" id="resEbitda">‚Ç¨ 0</div>
                                </div>
                                <div class="result-card">
                                    <div>‚úÖ Risultato Netto</div>
                                    <div class="result-value" id="resNetto">‚Ç¨ 0</div>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h2>KPI Principali</h2>
                            <div class="results-grid">
                                <div class="result-card">
                                    <div>üìà ROS</div>
                                    <div class="result-value" id="resRos">0%</div>
                                    <span class="result-status" id="statusRos">-</span>
                                </div>
                                <div class="result-card">
                                    <div>üíπ ROI</div>
                                    <div class="result-value" id="resRoi">0%</div>
                                    <span class="result-status" id="statusRoi">-</span>
                                </div>
                                <div class="result-card">
                                    <div>üìä EBITDA Margin</div>
                                    <div class="result-value" id="resEbitdaMargin">0%</div>
                                    <span class="result-status" id="statusEbitdaMargin">-</span>
                                </div>
                                <div class="result-card">
                                    <div>üè® RevPAR</div>
                                    <div class="result-value" id="resRevpar">‚Ç¨ 0</div>
                                    <span class="result-status" id="statusRevpar">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="section">
                            <h2>Altri Indicatori</h2>
                            <div class="results-grid">
                                <div class="result-card">
                                    <div>üîÑ TOR (Occupancy Media)</div>
                                    <div class="result-value" id="resTor">0%</div>
                                </div>
                                <div class="result-card">
                                    <div>üíº GOPPAR</div>
                                    <div class="result-value" id="resGoppar">‚Ç¨ 0</div>
                                </div>
                                <div class="result-card">
                                    <div>üë• Labor Cost %</div>
                                    <div class="result-value" id="resLaborCost">0%</div>
                                </div>
                                <div class="result-card">
                                    <div>‚ö° Produttivit√†/ULA</div>
                                    <div class="result-value" id="resProduttivita">‚Ç¨ 0</div>
                                </div>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn" onclick="exportPDF()">üìÑ Esporta PDF</button>
                            <button class="btn" onclick="exportExcel()">üìä Esporta Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 4: Punteggio Bando -->
            <div class="tab-content">
                <div class="section">
                    <h2>Griglia di Valutazione Bando</h2>
                    <div class="alert alert-info">
                        ‚ÑπÔ∏è Il punteggio viene calcolato automaticamente in base ai dati inseriti
                    </div>
                    
                    <table class="score-table">
                        <thead>
                            <tr>
                                <th>Criterio</th>
                                <th>Descrizione</th>
                                <th>Max Punti</th>
                                <th>Punti Ottenuti</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>A</td>
                                <td>Incremento occupazionale (ULA)</td>
                                <td>27</td>
                                <td id="final_a">0</td>
                            </tr>
                            <tr>
                                <td>B</td>
                                <td>Investimenti operativi/totali</td>
                                <td>20</td>
                                <td id="final_b">0</td>
                            </tr>
                            <tr>
                                <td>C</td>
                                <td>Indicatori economici (ROS, ROI, EBITDA, TOR)</td>
                                <td>14</td>
                                <td id="final_c">0</td>
                            </tr>
                            <tr>
                                <td>D</td>
                                <td>Qualit√† del progetto</td>
                                <td>14</td>
                                <td>
                                    <input type="number" id="griglia_d" value="0" min="0" max="14" onchange="calcolaPunteggio()">
                                </td>
                            </tr>
                            <tr>
                                <td>E</td>
                                <td>Sostenibilit√† ambientale</td>
                                <td>17</td>
                                <td>
                                    <input type="number" id="griglia_e" value="0" min="0" max="17" onchange="calcolaPunteggio()">
                                </td>
                            </tr>
                            <tr>
                                <td>F</td>
                                <td>Localizzazione geografica</td>
                                <td>8</td>
                                <td>
                                    <input type="number" id="griglia_f" value="0" min="0" max="8" onchange="calcolaPunteggio()">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="total-score">
                        Punteggio Totale: <span id="punteggioTotale">0</span> / 100
                    </div>
                    
                    <div class="alert alert-warning" style="margin-top: 20px;">
                        ‚ö†Ô∏è <strong>Nota:</strong> I criteri D, E, F devono essere inseriti manualmente in base alla documentazione del progetto
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variabili globali
        let risultati = {};
        const mesi = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                      'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
        const giorniPerMese = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
        
        // Occupancy default per tipo di struttura
        const occupancyDefaults = {
            hotel: [40, 45, 50, 55, 60, 70, 80, 85, 75, 60, 50, 45],
            bb: [30, 35, 40, 50, 60, 75, 85, 90, 70, 55, 40, 35],
            agriturismo: [20, 25, 35, 45, 55, 65, 75, 80, 60, 45, 30, 25],
            default: [35, 40, 45, 50, 60, 70, 80, 85, 70, 55, 45, 40]
        };

        // Funzione per cambiare tab
        function showTab(index) {
            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');
            
            tabs.forEach((tab, i) => {
                tab.classList.toggle('active', i === index);
            });
            
            contents.forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
        }

        // Aggiorna visibilit√† form per imprese attive
        function updateFormVisibility() {
            const stato = document.getElementById('impresaStato').value;
            const datiPrecedenti = document.getElementById('datiPrecedenti');
            if (datiPrecedenti) {
                datiPrecedenti.style.display = stato === 'attiva' ? 'block' : 'none';
            }
        }

        // Genera tabella occupancy
        function updateOccupancy() {
            const tipo = document.getElementById('tipologiaStruttura').value;
            const defaults = occupancyDefaults[tipo] || occupancyDefaults.default;
            const tbody = document.getElementById('occupancyTable');
            const camere = parseInt(document.getElementById('numeroCamere').value) || 10;
            
            tbody.innerHTML = '';
            
            mesi.forEach((mese, i) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${mese}</td>
                    <td><input type="number" id="occ_${i}" value="${defaults[i]}" min="0" max="100" onchange="updateCamereOccupate(${i})"></td>
                    <td id="camere_${i}">${Math.round(camere * defaults[i] / 100)}</td>
                    <td>${giorniPerMese[i]}</td>
                `;
            });
        }

        // Aggiorna camere occupate quando cambia l'occupancy
        function updateCamereOccupate(mese) {
            const camere = parseInt(document.getElementById('numeroCamere').value) || 10;
            const occ = parseFloat(document.getElementById(`occ_${mese}`).value) || 0;
            document.getElementById(`camere_${mese}`).textContent = Math.round(camere * occ / 100);
        }

        // Reset occupancy ai valori default
        function resetOccupancy() {
            updateOccupancy();
        }

        // Calcolo principale
        function calcola() {
            // Raccolta dati
            const numeroCamere = parseInt(document.getElementById('numeroCamere').value) || 0;
            const giorniApertura = parseInt(document.getElementById('giorniApertura').value) || 365;
            const adr = parseFloat(document.getElementById('adr').value) || 0;
            const fattRistorazione = parseFloat(document.getElementById('fattRistorazione').value) || 0;
            const altriRicavi = parseFloat(document.getElementById('altriRicavi').value) || 0;
            
            const costoPersonale = parseFloat(document.getElementById('costoPersonale').value) || 0;
            const costiMaterie = parseFloat(document.getElementById('costiMaterie').value) || 0;
            const costiServizi = parseFloat(document.getElementById('costiServizi').value) || 0;
            const altriCosti = parseFloat(document.getElementById('altriCosti').value) || 0;
            
            const investimentoTotale = parseFloat(document.getElementById('investimentoTotale').value) || 0;
            const investimentiOperativi = parseFloat(document.getElementById('investimentiOperativi').value) || 0;
            const anniAmmortamento = parseInt(document.getElementById('anniAmmortamento').value) || 10;
            const aliquotaFiscale = parseFloat(document.getElementById('aliquotaFiscale').value) || 24;
            
            const dipAttuali = parseFloat(document.getElementById('dipendentiAttuali').value) || 0;
            const dipPrevisti = parseFloat(document.getElementById('dipendentiPrevisti').value) || 0;
            
            // Calcolo ricavi da camere
            let roomNights = 0;
            let occupancyTotale = 0;
            let giorniCalcolati = 0;
            
            for (let i = 0; i < 12; i++) {
                const occ = parseFloat(document.getElementById(`occ_${i}`).value) || 0;
                const giorni = Math.min(giorniPerMese[i], giorniApertura - giorniCalcolati);
                if (giorni > 0) {
                    roomNights += numeroCamere * (occ / 100) * giorni;
                    occupancyTotale += occ;
                    giorniCalcolati += giorni;
                }
                if (giorniCalcolati >= giorniApertura) break;
            }
            
            const ricaviCamere = roomNights * adr;
            const fatturatoTotale = ricaviCamere + fattRistorazione + altriRicavi;
            
            // Calcolo costi
            const costiOperativi = costoPersonale + costiMaterie + costiServizi + altriCosti;
            
            // Calcolo risultati
            const mol = fatturatoTotale - costiOperativi;
            const ebitda = mol; // Semplificato
            const ammortamenti = investimentoTotale / anniAmmortamento;
            const risultatoLordo = ebitda - ammortamenti;
            const imposte = Math.max(0, risultatoLordo * (aliquotaFiscale / 100));
            const risultatoNetto = risultatoLordo - imposte;
            
            // Calcolo KPI
            const ros = fatturatoTotale > 0 ? (risultatoLordo / fatturatoTotale) : 0;
            const roi = investimentoTotale > 0 ? (risultatoLordo / investimentoTotale) : 0;
            const ebitdaMargin = fatturatoTotale > 0 ? (ebitda / fatturatoTotale) : 0;
            const tor = occupancyTotale / 12; // Media occupancy
            const revpar = (giorniCalcolati * numeroCamere) > 0 ? 
                         (ricaviCamere / (giorniCalcolati * numeroCamere)) : 0;
            const goppar = (giorniCalcolati * numeroCamere) > 0 ? 
                          (mol / (giorniCalcolati * numeroCamere)) : 0;
            const laborCostPerc = fatturatoTotale > 0 ? (costoPersonale / fatturatoTotale) : 0;
            const produttivitaPerULA = dipPrevisti > 0 ? (fatturatoTotale / dipPrevisti) : 0;
            const invPerULA = dipPrevisti > 0 ? (investimentoTotale / dipPrevisti) : 0;
            
            // Salva risultati
            risultati = {
                numeroCamere,
                giorniCalcolati,
                fatturatoTotale,
                costiOperativi,
                mol,
                ebitda,
                ammortamenti,
                risultatoNetto,
                ros,
                roi,
                ebitdaMargin,
                tor,
                revpar,
                goppar,
                laborCostPerc,
                produttivitaPerULA,
                invPerULA,
                investimentoTotale,
                investimentiOperativi,
                dipAttuali,
                dipPrevisti
            };
            
            // Mostra risultati
            mostraRisultati();
            calcolaPunteggio();
        }

        // Mostra risultati calcolati
        function mostraRisultati() {
            document.getElementById('noResultsAlert').style.display = 'none';
            document.getElementById('resultsContainer').style.display = 'block';
            
            // Aggiorna valori
            document.getElementById('resFatturato').textContent = '‚Ç¨ ' + formatNumber(risultati.fatturatoTotale);
            document.getElementById('resCosti').textContent = '‚Ç¨ ' + formatNumber(risultati.costiOperativi);
            document.getElementById('resEbitda').textContent = '‚Ç¨ ' + formatNumber(risultati.ebitda);
            document.getElementById('resNetto').textContent = '‚Ç¨ ' + formatNumber(risultati.risultatoNetto);
            
            document.getElementById('resRos').textContent = (risultati.ros * 100).toFixed(1) + '%';
            document.getElementById('resRoi').textContent = (risultati.roi * 100).toFixed(1) + '%';
            document.getElementById('resEbitdaMargin').textContent = (risultati.ebitdaMargin * 100).toFixed(1) + '%';
            document.getElementById('resRevpar').textContent = '‚Ç¨ ' + formatNumber(risultati.revpar);
            
            document.getElementById('resTor').textContent = risultati.tor.toFixed(1) + '%';
            document.getElementById('resGoppar').textContent = '‚Ç¨ ' + formatNumber(risultati.goppar);
            document.getElementById('resLaborCost').textContent = (risultati.laborCostPerc * 100).toFixed(1) + '%';
            document.getElementById('resProduttivita').textContent = '‚Ç¨ ' + formatNumber(risultati.produttivitaPerULA);
            
            // Aggiorna status
            updateStatus('statusRos', risultati.ros, [0.15, 0.10, 0.05]);
            updateStatus('statusRoi', risultati.roi, [0.20, 0.15, 0.10]);
            updateStatus('statusEbitdaMargin', risultati.ebitdaMargin, [0.30, 0.20, 0.10]);
            updateStatus('statusRevpar', risultati.revpar, [100, 70, 50]);
        }

        // Aggiorna indicatore di status
        function updateStatus(elementId, value, thresholds) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (value >= thresholds[0]) {
                element.className = 'result-status status-excellent';
                element.textContent = 'Eccellente';
            } else if (value >= thresholds[1]) {
                element.className = 'result-status status-good';
                element.textContent = 'Buono';
            } else if (value >= thresholds[2]) {
                element.className = 'result-status status-warning';
                element.textContent = 'Sufficiente';
            } else {
                element.className = 'result-status status-poor';
                element.textContent = 'Da migliorare';
            }
        }

        // Calcola punteggio bando
        function calcolaPunteggio() {
            if (!risultati.fatturatoTotale) return;
            
            const stato = document.getElementById('impresaStato').value;
            
            // Criterio A - Incremento occupazionale
            const incrementoULA = risultati.dipPrevisti - risultati.dipAttuali;
            let puntiA = 0;
            if (incrementoULA >= 10) puntiA = 27;
            else if (incrementoULA >= 7) puntiA = 24;
            else if (incrementoULA >= 5) puntiA = 20;
            else if (incrementoULA >= 3) puntiA = 16;
            else if (incrementoULA >= 1) puntiA = 10;
            else if (incrementoULA >= 0.5) puntiA = 5;
            
            // Criterio B - Investimenti operativi
            const ratioInvOp = risultati.investimentoTotale > 0 ? 
                              (risultati.investimentiOperativi / risultati.investimentoTotale) : 0;
            let puntiB = 0;
            if (ratioInvOp > 0.85) puntiB = 20;
            else if (ratioInvOp > 0.70) puntiB = 16;
            else if (ratioInvOp > 0.55) puntiB = 10;
            else if (ratioInvOp > 0.40) puntiB = 7;
            
            // Criterio C - Indicatori economici
            let puntiC = 0;
            if (stato === 'inattiva') {
                if (risultati.ros > 0.20) puntiC += 4;
                if (risultati.roi > 0.15) puntiC += 4;
                if (risultati.ebitdaMargin > 0.30) puntiC += 4;
            } else {
                // Per imprese attive, servirebbero i dati precedenti per confronto
                if (risultati.ros > 0.15) puntiC += 4;
                if (risultati.roi > 0.10) puntiC += 4;
                if (risultati.ebitdaMargin > 0.20) puntiC += 4;
            }
            if (risultati.tor > 70) puntiC += 2;
            if (puntiC > 14) puntiC = 14;
            
            // Criteri D, E, F - Input manuali
            const puntiD = parseInt(document.getElementById('griglia_d').value) || 0;
            const puntiE = parseInt(document.getElementById('griglia_e').value) || 0;
            const puntiF = parseInt(document.getElementById('griglia_f').value) || 0;
            
            // Aggiorna visualizzazione
            document.getElementById('final_a').textContent = puntiA;
            document.getElementById('final_b').textContent = puntiB;
            document.getElementById('final_c').textContent = puntiC;
            
            const totale = puntiA + puntiB + puntiC + puntiD + puntiE + puntiF;
            document.getElementById('punteggioTotale').textContent = totale;
        }

        // Export PDF
        async function exportPDF() {
            if (!risultati.fatturatoTotale) {
                alert('Prima calcola il business plan!');
                return;
            }
            
            const report = document.getElementById('reportArea');
            try {
                const canvas = await html2canvas(report, {scale: 2});
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                const cliente = document.getElementById('denominazioneCliente').value || 'business-plan';
                const filename = `report-${safeFileName(cliente)}.pdf`;
                pdf.save(filename);
            } catch (err) {
                alert('Errore esportazione PDF: ' + err.message);
            }
        }

        // Export Excel
        function exportExcel() {
            if (!risultati.fatturatoTotale) {
                alert('Prima calcola il business plan!');
                return;
            }
            
            const cliente = document.getElementById('denominazioneCliente').value || 'business-plan';
            const wb = XLSX.utils.book_new();
            
            // Foglio Input
            const inputData = [{
                Cliente: cliente,
                NumeroCamere: risultati.numeroCamere,
                GiorniApertura: risultati.giorniCalcolati,
                ADR: document.getElementById('adr').value,
                InvestimentoTotale: risultati.investimentoTotale,
                InvestimentiOperativi: risultati.investimentiOperativi,
                DipendentiAttuali: risultati.dipAttuali,
                DipendentiPrevisti: risultati.dipPrevisti
            }];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(inputData), 'Input');
            
            // Foglio Risultati
            const resultsData = [{
                FatturatoTotale: risultati.fatturatoTotale,
                CostiOperativi: risultati.costiOperativi,
                EBITDA: risultati.ebitda,
                RisultatoNetto: risultati.risultatoNetto,
                ROS_pct: (risultati.ros * 100).toFixed(2),
                ROI_pct: (risultati.roi * 100).toFixed(2),
                EBITDA_Margin_pct: (risultati.ebitdaMargin * 100).toFixed(2),
                TOR_pct: risultati.tor.toFixed(2),
                RevPAR: risultati.revpar.toFixed(2),
                GOPPAR: risultati.goppar.toFixed(2)
            }];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(resultsData), 'Risultati');
            
            const filename = `report-${safeFileName(cliente)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Utility functions
        function formatNumber(num) {
            return new Intl.NumberFormat('it-IT', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.round(num));
        }

        function safeFileName(name) {
            return name.replace(/[^a-z0-9\-_\s]/gi, '').replace(/\s+/g, '-').toLowerCase();
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            updateFormVisibility();
            updateOccupancy();
            
            // Event listener per aggiornare occupancy quando cambiano le camere
            document.getElementById('numeroCamere').addEventListener('change', updateOccupancy);
            document.getElementById('tipologiaStruttura').addEventListener('change', updateOccupancy);
        });
    </script>
</body>
</html>
